<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Builder</title>
    
    <!-- Tailwind CSS CDN -->
    <!-- <script src="https://cdn.tailwindcss.com"></script> -->
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
    <!-- Tailwind Config -->

    <script src="https://cdn.jsdelivr.net/npm/exceljs@4.4.0/dist/exceljs.min.js"></script>
    
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
    
    <style>
        /* ==========================================
           RESET & BASE
           ========================================== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100%;
            height: 100%;
            overflow: hidden;
        }

        /* FIX: Force full width for all major containers */
        body, .container, .main-content, .screen, 
        .mapping-screen, .tab-config-screen, .dashboard-screen,
        .upload-screen, .welcome-screen, .summary-screen {
            width: 100% !important;
            max-width: 100% !important;
        }
        
        :root {
            --primary-green: #27ae60;
            --dark-green: #1e8449;
            --light-green: #a8e6cf;
            --mint-bg: #e8f8f5;
            --success: #2ecc71;
            --warning: #f39c12;
            --error: #e74c3c;
            --white: #ffffff;
            --light-gray: #f8f9fa;
            --medium-gray: #e9ecef;
            --border-gray: #dee2e6;
            --text-dark: #2c3e50;
            --text-gray: #6c757d;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.15);
            --shadow-lg: 0 8px 16px rgba(0,0,0,0.2);
        }
        
        body {
            font-family: 'Plus Jakarta Sans', 'Inter', 'Noto Sans JP', 'Noto Sans', sans-serif;
            background: var(--light-gray);
            color: var(--text-dark);
            height: 100vh;
            overflow: hidden;
            letter-spacing: -0.01em;
        }
        
        .container {
            display: flex;
            width: 100vw;
            height: 100vh;
            max-width: 100vw;
        }
        
        /* ==========================================
           SIDEBAR - PREMIUM
           ========================================== */
        .sidebar {
            width: 60px;
            background: linear-gradient(180deg, #1e8449 0%, #145a32 100%);
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            padding: 24px 0;
            box-shadow: 4px 0 24px rgba(0, 0, 0, 0.15);
            z-index: 100;
            position: relative;
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: visible !important;
        }
        
        .sidebar.expanded {
            width: 220px;
        }
        
        .sidebar-hamburger {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding-left: 10px;
            color: white;
            margin: 0 8px 8px 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .sidebar.expanded .sidebar-hamburger {
            width: calc(100% - 16px);
            padding: 0 16px;
        }
        
        .sidebar-hamburger:hover {
            background: rgba(255,255,255,0.15);
        }
        
        .sidebar-hamburger i {
            flex-shrink: 0;
            transition: transform 0.3s;
        }
        
        .sidebar.expanded .sidebar-hamburger i {
            transform: rotate(90deg);
        }
        
        .sidebar-divider {
            width: calc(100% - 16px);
            height: 2px;
            background: rgba(255,255,255,0.2);
            margin: 8px auto 16px;
            transition: all 0.3s;
        }
        
        .sidebar.expanded .sidebar-divider {
            width: calc(100% - 32px);
        }
        
        .sidebar-item {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: flex-start;
            padding-left: 10px;
            color: white;
            margin: 6px 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }
        
        .sidebar.expanded .sidebar-item {
            width: calc(100% - 16px);
            padding: 0 16px;
        }
        
        .sidebar-item::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 12px;
            padding: 2px;
            background: linear-gradient(135deg, rgba(255,255,255,0.3), transparent);
            -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
            -webkit-mask-composite: xor;
            mask-composite: exclude;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .sidebar-item:hover:not(.disabled)::before {
            opacity: 1;
        }
        
        .sidebar-item:hover:not(.disabled) {
            background: rgba(255,255,255,0.15);
            transform: translateX(3px);
        }
        
        .sidebar-item.active {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            box-shadow: 
                0 4px 12px rgba(39, 174, 96, 0.4),
                0 0 0 3px rgba(255, 255, 255, 0.25);
            transform: scale(1.02);
        }
        
        .sidebar-item.disabled {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .sidebar-item i {
            flex-shrink: 0;
        }
        
        .sidebar-item-label {
            margin-left: 12px;
            font-size: 14px;
            font-weight: 600;
            color: white;
            white-space: nowrap;
            opacity: 0;
            max-width: 0;
            overflow: hidden;
            transition: opacity 0.3s ease 0.1s, max-width 0.3s ease;
        }
        
        .sidebar.expanded .sidebar-item-label {
            opacity: 1;
            max-width: 200px;
            transition: opacity 0.3s ease 0.2s, max-width 0.3s ease;
        }
        
        .sidebar-tooltip {
            position: absolute;
            left: calc(100% + 16px);
            top: 50%;
            transform: translateY(-50%);
            padding: 8px 12px;
            background: #1f2937;
            color: white;
            font-size: 12px;
            font-weight: 600;
            border-radius: 8px;
            opacity: 0;
            visibility: hidden;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            white-space: nowrap;
            pointer-events: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .sidebar-item:hover .sidebar-tooltip {
            opacity: 1;
            visibility: visible;
        }
        
        .sidebar.expanded .sidebar-tooltip {
            display: none;
        }
        
        .sidebar-tooltip::before {
            content: '';
            position: absolute;
            right: 100%;
            top: 50%;
            transform: translateY(-50%);
            border: 5px solid transparent;
            border-right-color: #1f2937;
        }
        
        /* ==========================================
           MAIN CONTENT
           ========================================== */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .header {
            background: white;
            padding: 24px 32px;
            border-bottom: 2px solid var(--border-gray);
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left h1 {
            font-size: 28px;
            font-weight: 800;
            background: linear-gradient(135deg, #1f2937 0%, #4b5563 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 6px;
            letter-spacing: -0.02em;
        }
        
        .header-left p {
            font-size: 14px;
            color: var(--text-gray);
            font-weight: 500;
        }
        
        .content-area {
            flex: 1;
            overflow: hidden;
            position: relative;
        }
        
        .screen {
            display: none;
            height: 100%;
            width: 100%;
        }
        
        .screen.active {
            display: flex;
        }
        
        /* ==========================================
           WELCOME SCREEN - AURORA
           ========================================== */
        .welcome-screen {
            position: relative;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            overflow: hidden;
            background: #0a0e27;
        }
        
        .aurora-canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 0;
        }
        
        .welcome-content {
            position: relative;
            z-index: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
        }
        
        .welcome-logo-container {
            margin-bottom: 32px;
            animation: float 3s ease-in-out infinite;
        }
        
        @keyframes float {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
        }
        
        .welcome-logo {
            width: 120px;
            height: 120px;
            background: linear-gradient(135deg, rgba(39, 174, 96, 0.2), rgba(30, 132, 73, 0.3));
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 
                0 8px 32px rgba(39, 174, 96, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        
        .welcome-title {
            font-size: 56px;
            font-weight: 900;
            color: white;
            margin-bottom: 16px;
            letter-spacing: -0.03em;
            text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }
        
        .welcome-subtitle {
            font-size: 20px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 56px;
            font-weight: 500;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }
        
        .welcome-options {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            max-width: 900px;
            width: 100%;
        }
        
        .welcome-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 24px;
            padding: 48px 40px;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            text-align: center;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }
        
        .welcome-card:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(39, 174, 96, 0.5);
            transform: translateY(-12px) scale(1.03);
            box-shadow: 
                0 20px 60px rgba(39, 174, 96, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.4);
        }
        
        .welcome-card-icon {
            margin-bottom: 24px;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .welcome-card-title {
            font-size: 26px;
            color: white;
            margin-bottom: 12px;
            font-weight: 700;
        }
        
        .welcome-card-desc {
            font-size: 15px;
            color: rgba(255, 255, 255, 0.7);
            font-weight: 500;
        }
        
        /* ==========================================
           UPLOAD SCREEN
           ========================================== */
        .upload-screen {
            flex-direction: column;
            background: white;
        }
        
        .upload-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 40px;
            overflow-y: auto;
        }
        
        .upload-zone {
            border: 3px dashed var(--border-gray);
            border-radius: 20px;
            padding: 64px;
            text-align: center;
            background: var(--light-gray);
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 32px;
        }
        
        .upload-zone:hover {
            border-color: var(--primary-green);
            background: var(--mint-bg);
            transform: scale(1.01);
        }
        
        .upload-zone.dragover {
            border-color: var(--primary-green);
            background: var(--mint-bg);
            transform: scale(1.02);
            box-shadow: 0 8px 24px rgba(39, 174, 96, 0.15);
        }
        
        .upload-zone-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }
        
        .upload-zone-title {
            font-size: 22px;
            color: var(--text-dark);
            margin-bottom: 12px;
            font-weight: 700;
        }
        
        .upload-zone-desc {
            font-size: 14px;
            color: var(--text-gray);
            font-weight: 500;
        }
        
        .upload-zone input[type="file"] {
            display: none;
        }
        
        .preview-section {
            display: none;
        }
        
        .preview-section.active {
            display: block;
        }
        
        .preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }
        
        .preview-header h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        .preview-info {
            font-size: 14px;
            color: var(--text-gray);
            font-weight: 600;
        }
        
        .preview-table-container {
            max-height: 400px;
            overflow: auto;
            border: 2px solid var(--border-gray);
            border-radius: 12px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .preview-table {
            width: 100%;
            border-collapse: collapse;
        }
        
        .preview-table th {
            background: linear-gradient(135deg, #a8e6cf 0%, #8dd3bb 100%);
            color: var(--text-dark);
            font-weight: 700;
            padding: 12px;
            text-align: left;
            font-size: 12px;
            position: sticky;
            top: 0;
            z-index: 10;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .preview-table td {
            padding: 10px 12px;
            border-bottom: 1px solid var(--border-gray);
            font-size: 13px;
        }
        
        .preview-table tbody tr:hover {
            background: linear-gradient(90deg, #f0fdf4 0%, transparent 100%);
        }
        
        /* ==========================================
           MAPPING SCREEN
           ========================================== */
        .mapping-screen {
            flex-direction: row;
        }
        
        .mapping-panel {
            flex: 1;
            background: white;
            overflow-y: auto;
            transition: margin-right 0.3s;
            display: flex;
            flex-direction: column;
        }
        
        .mapping-panel .header {
            position: sticky;
            top: 0;
            z-index: 50;
        }
        
        .mapping-content {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
            padding-bottom: 100px;
        }
        
        .mapping-main {
            flex: 1;
            overflow-y: auto;
            transition: margin-right 0.3s;
            display: flex;
            flex-direction: column;
        }
        
        .mapping-main.columns-open {
            margin-right: 300px;
        }
        
        .mapping-main.edit-open {
            margin-right: 400px;
        }
        
        /* ==========================================
           ALERTS
           ========================================== */
        .alert {
            padding: 14px 18px;
            border-radius: 10px;
            margin-bottom: 24px;
            display: flex;
            align-items: start;
            gap: 12px;
            font-size: 14px;
            font-weight: 500;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }
        
        .alert-info {
            background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%);
            color: #1e40af;
            border-left: 4px solid #3b82f6;
        }
        
        .alert-warning {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            color: #92400e;
            border-left: 4px solid #f59e0b;
        }
        
        /* ==========================================
           SECTION CONTAINERS
           ========================================== */
        .section-container {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 28px;
            box-shadow: 
                0 1px 3px rgba(0, 0, 0, 0.05),
                0 4px 12px rgba(0, 0, 0, 0.05);
            position: relative;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .section-container:hover {
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.08),
                0 8px 24px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .section-header-left {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .section-header h2 {
            font-size: 18px;
            font-weight: 800;
            background: linear-gradient(135deg, #1f2937 0%, #4b5563 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: -0.01em;
        }
        
        .section-header .icon {
            font-size: 22px;
        }

        .section-header:not(:has(.section-header-left)) {
            gap: 12px;
        }
        
        .section-header:not(:has(.section-header-left)) .icon {
            flex-shrink: 0;
        }
        
        .section-header:not(:has(.section-header-left)) h3 {
            flex: 1;
            margin: 0;
        }
        
        /* Style h3 */
        .section-header h3 {
            font-size: 16px;
            font-weight: 700;
            color: green;
        }
        
        .drop-zone-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(168, 230, 207, 0.25);
            border: 3px dashed var(--primary-green);
            border-radius: 16px;
            z-index: 10;
            pointer-events: none;
            animation: pulse-drop 1.5s infinite;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            font-weight: 700;
            color: var(--dark-green);
        }
        
        .section-container.drag-over .drop-zone-overlay {
            display: flex;
        }
        
        @keyframes pulse-drop {
            0%, 100% { opacity: 0.6; }
            50% { opacity: 1; }
        }
        
        /* ==========================================
           FORMS
           ========================================== */
        .date-setting-form {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-size: 13px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 8px;
        }
        
        .form-group input[type="text"],
        .form-group input[type="number"],
        .form-group select {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--border-gray);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 
                0 0 0 4px rgba(39, 174, 96, 0.1),
                0 2px 8px rgba(0, 0, 0, 0.08);
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        
        .radio-group label {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 500;
            cursor: pointer;
            transition: color 0.2s;
        }
        
        .radio-group label:hover {
            color: var(--primary-green);
        }
        
        .radio-group input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .checkbox-item label {
            font-size: 14px;
            color: var(--text-dark);
            cursor: pointer;
            font-weight: 500;
            transition: color 0.2s;
        }
        
        .checkbox-item:hover label {
            color: var(--primary-green);
        }
        
        .checkbox-group {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }
        
        /* ==========================================
           TABLES
           ========================================== */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 12px;
            overflow: hidden;
        }
        
        .data-table th {
            background: linear-gradient(135deg, #a8e6cf 0%, #8dd3bb 100%);
            color: var(--text-dark);
            font-weight: 700;
            padding: 14px 12px;
            text-align: left;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .data-table td {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            font-size: 14px;
        }
        
        .data-table tbody tr {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .data-table tbody tr:hover {
            background: linear-gradient(90deg, #f0fdf4 0%, transparent 100%);
            transform: scale(1.002);
        }
        
        .data-table tbody tr.new-row {
            animation: flashGreen 0.5s;
        }
        
        @keyframes flashGreen {
            0%, 100% { background: white; }
            50% { background: var(--light-green); }
        }
        
        .drag-handle {
            cursor: move;
            color: var(--text-gray);
            font-size: 16px;
            padding: 5px;
            transition: color 0.2s;
        }
        
        .drag-handle:hover {
            color: var(--primary-green);
        }
        
        .data-table input[type="text"],
        .data-table input[type="number"] {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid var(--border-gray);
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .data-table input:focus {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
            outline: none;
        }
        
        .data-table select {
            width: 100%;
            padding: 8px 10px;
            border: 2px solid var(--border-gray);
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            background: white;
            transition: all 0.2s;
        }
        
        .data-table select:focus {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
            outline: none;
        }
        
        .delete-btn {
            background: none;
            border: none;
            color: var(--error);
            font-size: 18px;
            cursor: pointer;
            padding: 6px;
            transition: all 0.2s;
            border-radius: 6px;
        }
        
        .delete-btn:hover {
            transform: scale(1.15);
            background: rgba(231, 76, 60, 0.1);
        }
        
        .metric-name {
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .metric-info {
            font-size: 12px;
            color: var(--text-gray);
            line-height: 1.4;
            font-weight: 500;
        }
        
        .calc-status {
            display: inline-flex;
            align-items: center;
            padding: 6px 12px;
            border-radius: 16px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .calc-status.on {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            box-shadow: 
                0 2px 8px rgba(39, 174, 96, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .calc-status.off {
            background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            color: #64748b;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        .edit-icon {
            color: var(--primary-green);
            cursor: pointer;
            font-size: 18px;
            transition: all 0.2s;
            padding: 4px;
            border-radius: 6px;
        }
        
        .edit-icon:hover {
            transform: scale(1.15);
            background: rgba(39, 174, 96, 0.1);
        }

        /* ==========================================
           PANELS (Columns & Edit)
           ========================================== */
        .columns-panel {
            position: fixed;
            right: 0;
            top: 0;
            height: 100vh;
            width: 300px;
            background: var(--mint-bg);
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.15);
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 100;
            display: flex;
            flex-direction: column;
        }
        
        .columns-panel.open {
            transform: translateX(0);
        }
        
        .columns-panel-header {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            padding: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .columns-panel-header h3 {
            font-size: 18px;
            font-weight: 700;
        }
        
        .close-panel-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 6px;
            border-radius: 8px;
            transition: all 0.2s;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-panel-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }
        
        .columns-panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }
        
        .search-box {
            position: relative;
            margin-bottom: 16px;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 40px 12px 14px;
            border: 2px solid var(--border-gray);
            border-radius: 10px;
            font-size: 14px;
            font-weight: 500;
            background: white;
            transition: all 0.2s;
        }
        
        .search-box input:focus {
            outline: none;
            border-color: var(--primary-green);
            box-shadow: 0 0 0 4px rgba(39, 174, 96, 0.1);
        }
        
        .search-icon {
            position: absolute;
            right: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-gray);
            font-size: 16px;
        }
        
        .column-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .column-item {
            background: white;
            padding: 14px;
            border-radius: 10px;
            cursor: move;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .column-item:hover:not(.used) {
            border-color: var(--primary-green);
            transform: translateX(-5px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.15);
        }
        
        .column-item.dragging {
            opacity: 0.6;
            transform: scale(1.05);
        }
        
        .column-item.used {
            opacity: 0.4;
            cursor: not-allowed;
            pointer-events: none;
        }
        
        .column-item .icon {
            color: var(--primary-green);
            font-size: 16px;
        }
        
        .column-item .name {
            font-size: 14px;
            color: var(--text-dark);
            font-weight: 600;
        }
        
        /* Edit Panel */
        .edit-panel {
            position: fixed;
            right: 0;
            top: 0;
            height: 100vh;
            width: 400px;
            background: white;
            box-shadow: -4px 0 24px rgba(0, 0, 0, 0.15);
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 200;
            overflow-y: auto;
            padding: 32px;
        }
        
        .edit-panel.open {
            transform: translateX(0);
        }
        
        .edit-panel h3 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 24px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        /* ==========================================
           FORMULA BUILDER
           ========================================== */
        .formula-builder {
            background: var(--mint-bg);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid var(--light-green);
        }
        
        .formula-display {
            background: white;
            padding: 16px;
            border-radius: 8px;
            min-height: 70px;
            margin-bottom: 16px;
            border: 2px dashed var(--border-gray);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        
        .formula-token {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: move;
            transition: all 0.2s;
            user-select: none;
            box-shadow: 0 2px 6px rgba(39, 174, 96, 0.2);
        }
        
        .formula-token:hover {
            transform: scale(1.08);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }
        
        .formula-token.selected {
            outline: 3px solid var(--warning);
            outline-offset: 2px;
        }
        
        .formula-token.operator {
            background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
        }
        
        .formula-token.number {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
        }
        
        .formula-controls {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .formula-controls select {
            padding: 8px 12px;
            border-radius: 8px;
            border: 2px solid var(--border-gray);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            background: white;
            transition: all 0.2s;
        }
        
        .formula-controls select:focus {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
            outline: none;
        }
        
        .formula-btn {
            padding: 8px 16px;
            border: 2px solid var(--border-gray);
            background: white;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .formula-btn:hover {
            border-color: var(--primary-green);
            background: var(--mint-bg);
            transform: translateY(-1px);
        }
        
        .formula-preview {
            margin-top: 16px;
            padding: 12px;
            background: white;
            border-radius: 8px;
            font-size: 13px;
            color: var(--text-gray);
            font-weight: 500;
        }
        
        /* ==========================================
           TAB CONFIGURATION
           ========================================== */
        .tab-config-screen {
            flex-direction: row;
        }
        
        .tabs-sidebar {
            width: 300px;
            background: white;
            border-right: 2px solid var(--border-gray);
            display: flex;
            flex-direction: column;
        }
        
        .tabs-sidebar-header {
            padding: 24px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .tabs-sidebar-header h2 {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 6px;
        }
        
        .tabs-list {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
        }
        
        .tab-item {
            background: var(--light-gray);
            padding: 16px;
            margin-bottom: 10px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .tab-item:hover {
            border-color: var(--primary-green);
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.1);
        }
        
        .tab-item.active {
            background: var(--mint-bg);
            border-color: var(--primary-green);
            box-shadow: 0 2px 8px rgba(39, 174, 96, 0.15);
        }
        
        .tab-item .tab-name {
            flex: 1;
            font-weight: 600;
            color: var(--text-dark);
        }
        
        .tab-item .tab-actions {
            display: flex;
            gap: 6px;
        }
        
        .tab-item .tab-actions button {
            background: rgba(255,255,255,0.8);
            border: none;
            cursor: pointer;
            font-size: 16px;
            padding: 6px;
            border-radius: 6px;
            transition: all 0.2s;
        }
        
        .tab-item .tab-actions button:hover {
            transform: scale(1.15);
            background: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }
        
        .config-panel {
            flex: 1;
            background: white;
            overflow-y: auto;
            padding: 32px;
            padding-bottom: 120px;
        }
        
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-gray);
        }
        
        .empty-state .icon {
            font-size: 72px;
            margin-bottom: 24px;
            opacity: 0.4;
        }
        
        .empty-state h3 {
            font-size: 22px;
            font-weight: 700;
            margin-bottom: 12px;
            color: var(--text-dark);
        }
        
        .empty-state p {
            margin-bottom: 24px;
            font-weight: 500;
        }
        
        .section {
            margin-bottom: 32px;
        }
        
        .dimension-selection {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .dimension-column {
            background: var(--light-gray);
            padding: 16px;
            border-radius: 12px;
            border: 2px solid var(--border-gray);
        }
        
        .dimension-column h4 {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-dark);
            margin-bottom: 12px;
        }
        
        .dimension-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            min-height: 200px;
        }
        
        .dimension-item {
            background: white;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 2px solid transparent;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .dimension-item:hover {
            border-color: var(--primary-green);
            transform: translateX(4px);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.12);
        }
        
        .dimension-item.selected {
            cursor: move;
        }
        
        .dimension-item .icon {
            font-size: 14px;
        }
        
        .dimension-item .name {
            flex: 1;
            font-size: 14px;
            color: var(--text-dark);
            font-weight: 600;
        }
        
        /* ==========================================
           FILTERS
           ========================================== */
        .filters-section {
            background: var(--mint-bg);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid var(--light-green);
        }
        
        .filter-item {
            background: white;
            padding: 16px;
            border-radius: 10px;
            margin-bottom: 12px;
            border: 2px solid var(--border-gray);
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        
        .filter-row {
            display: grid;
            grid-template-columns: 2fr 1.5fr 2fr 40px;
            gap: 10px;
            align-items: center;
        }
        
        .filter-row select,
        .filter-row input {
            padding: 10px 12px;
            border: 2px solid var(--border-gray);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.2s;
        }
        
        .filter-row select:focus,
        .filter-row input:focus {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
            outline: none;
        }
        
        .filter-between {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 10px;
            align-items: center;
        }
        
        .filter-between span {
            text-align: center;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-gray);
        }
        
        .delete-filter-btn {
            background: var(--error);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            box-shadow: 0 2px 6px rgba(231, 76, 60, 0.3);
        }
        
        .delete-filter-btn:hover {
            transform: scale(1.12);
            box-shadow: 0 4px 12px rgba(231, 76, 60, 0.4);
        }
        
        .empty-filters {
            text-align: center;
            padding: 24px;
            color: var(--text-gray);
            font-size: 14px;
            font-weight: 500;
        }
        
        .unsaved-indicator {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--warning);
            border-radius: 50%;
            margin-left: 6px;
            box-shadow: 0 0 8px rgba(243, 156, 18, 0.5);
            animation: pulse-warning 2s infinite;
        }
        
        @keyframes pulse-warning {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* ==========================================
           SUMMARY SCREEN
           ========================================== */
        .summary-screen {
            flex-direction: column;
            background: white;
        }
        
        .summary-container {
            flex: 1;
            overflow-y: auto;
            padding: 40px;
        }
        
        .summary-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 32px;
            margin-bottom: 32px;
            box-shadow: 
                0 1px 3px rgba(0, 0, 0, 0.05),
                0 4px 12px rgba(0, 0, 0, 0.05);
            transition: all 0.3s;
        }
        
        .summary-card:hover {
            box-shadow: 
                0 4px 12px rgba(0, 0, 0, 0.08),
                0 8px 24px rgba(0, 0, 0, 0.08);
            transform: translateY(-2px);
        }
        
        .summary-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .summary-card-header .icon {
            font-size: 28px;
        }
        
        .summary-card-header h3 {
            font-size: 20px;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
        }
        
        .stat-box {
            background: linear-gradient(135deg, #e8f8f5 0%, #d1f2eb 100%);
            padding: 24px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid var(--light-green);
            transition: all 0.3s;
        }
        
        .stat-box:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(39, 174, 96, 0.15);
        }
        
        .stat-number {
            font-size: 42px;
            font-weight: 800;
            background: linear-gradient(135deg, #27ae60 0%, #1e8449 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--text-gray);
            font-weight: 600;
        }

        /* ==========================================
           DASHBOARD SCREEN
           ========================================== */
        .dashboard-screen {
            flex-direction: column;
            background: var(--light-gray);
        }
        
        .dashboard-header {
            background: white;
            padding: 28px 40px;
            border-bottom: 2px solid var(--border-gray);
            box-shadow: 0 2px 12px rgba(0,0,0,0.06);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        
        .dashboard-header-left {
            flex: 1;
        }
        
        .dashboard-header-right {
            display: flex;
            align-items: center;
        }
        
        .dashboard-title {
            font-size: 32px;
            font-weight: 800;
            background: linear-gradient(135deg, #1f2937 0%, #27ae60 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 12px;
            letter-spacing: -0.02em;
        }
        
        .dashboard-meta {
            display: flex;
            gap: 32px;
            font-size: 15px;
            color: var(--text-gray);
        }
        
        .dashboard-meta-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }
        
        .dashboard-meta-item .icon {
            font-size: 18px;
        }
        
        .dashboard-controls {
            display: flex;
            gap: 16px;
            align-items: center;
        }
        
        .date-range-picker {
            display: flex;
            gap: 12px;
            align-items: center;
            background: var(--light-gray);
            padding: 14px 20px;
            border-radius: 12px;
            border: 2px solid var(--border-gray);
            box-shadow: 0 2px 6px rgba(0,0,0,0.05);
        }
        
        .date-range-picker label {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        .date-range-picker input {
            padding: 10px 14px;
            border: 2px solid var(--border-gray);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            background: white;
            transition: all 0.2s;
        }
        
        .date-range-picker input:focus {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
            outline: none;
        }
        
        .dashboard-tabs {
            background: white;
            border-bottom: 2px solid var(--border-gray);
            padding: 0 32px;
            display: flex;
            gap: 8px;
        }
        
        .dashboard-tab {
            padding: 14px 28px;
            background: transparent;
            border: none;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            color: var(--text-gray);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border-radius: 24px;
            margin: 8px 4px;
        }
        
        .dashboard-tab:hover {
            color: var(--primary-green);
            background: var(--mint-bg);
        }
        
        .dashboard-tab.active {
            color: white;
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.3);
        }
        
        .dashboard-content {
            flex: 1;
            overflow-y: auto;
            padding: 32px;
        }
        
        .dashboard-table-container {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 32px;
            box-shadow: 
                0 1px 3px rgba(0, 0, 0, 0.05),
                0 4px 12px rgba(0, 0, 0, 0.05);
            overflow-x: auto;
        }
        
        .dashboard-table-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .dashboard-table-header .icon {
            font-size: 22px;
        }
        
        .dashboard-table-header h3 {
            font-size: 17px;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        .dashboard-table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
            min-width: 100%;
        }
        
        .dashboard-table th {
            background: var(--light-green) !important;
            color: var(--text-dark);
            font-weight: 700;
            padding: 14px 12px;
            text-align: left;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            user-select: none;
            position: relative;
            border-right: 1px solid rgba(0,0,0,0.05);
            min-width: 120px;
            max-width: 250px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .dashboard-table th:last-child {
            border-right: none;
        }
        
        .dashboard-table th[onclick] {
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .dashboard-table th[onclick]:hover {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
        }
        
        .dashboard-table th.sorted-asc::after {
            content: ' ';
            font-size: 10px;
            margin-left: 4px;
        }
        
        .dashboard-table th.sorted-desc::after {
            content: ' ';
            font-size: 10px;
            margin-left: 4px;
        }
        
        .dashboard-table.sticky-dimensions th.dimension-col,
        .dashboard-table.sticky-dimensions td.dimension-col {
            position: sticky;
            background: white;
            z-index: 10;
        }
        
        .dashboard-table.sticky-dimensions th.dimension-col {
            background: linear-gradient(135deg, #a8e6cf 0%, #8dd3bb 100%);
            z-index: 11;
        }
        
        .dashboard-table td {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            border-right: 1px solid rgba(0,0,0,0.03);
            font-size: 13px;
            font-weight: 500;
            min-width: 120px;
            max-width: 250px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            position: relative;
        }
        
        .dashboard-table td:last-child {
            border-right: none;
        }
        
        .dashboard-table td[title],
        .dashboard-table th[title] {
            cursor: default;
        }
        
        .dashboard-table.alternate-rows tbody tr:nth-child(even):not(.total-row) {
            background: #fafbfc;
        }
        
        .dashboard-table tbody tr {
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .dashboard-table tbody tr:hover:not(.total-row) {
            background: linear-gradient(90deg, #f0fdf4 0%, transparent 100%);
            transform: scale(1.002);
        }
        
        .dashboard-table tbody tr.total-row {
            background: var(--mint-bg);
            font-weight: 700;
            border-top: 3px solid var(--primary-green);
        }
        
        .dashboard-table .data-bar-cell {
            position: relative;
        }
        
        .data-bar {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            opacity: 0.25;
            z-index: 0;
            transition: all 0.3s;
        }
        
        .data-bar-value {
            position: relative;
            z-index: 1;
        }
        
        /* ==========================================
           BUTTONS - PREMIUM
           ========================================== */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            position: relative;
            overflow: hidden;
        }
        
        .btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.6s;
        }
        
        .btn:hover::before {
            left: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            box-shadow: 
                0 4px 12px rgba(39, 174, 96, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .btn-primary:hover {
            background: linear-gradient(135deg, #229954 0%, #1e8449 100%);
            transform: translateY(-2px);
            box-shadow: 
                0 8px 20px rgba(39, 174, 96, 0.35),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .btn-primary:active {
            transform: translateY(0);
        }
        
        .btn-secondary {
            background: white;
            color: var(--primary-green);
            border: 2px solid var(--primary-green);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        
        .btn-secondary:hover {
            background: var(--mint-bg);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            box-shadow: 
                0 4px 12px rgba(231, 76, 60, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .btn-danger:hover {
            background: linear-gradient(135deg, #c0392b 0%, #a93226 100%);
            transform: translateY(-2px);
            box-shadow: 
                0 8px 20px rgba(231, 76, 60, 0.35),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .btn-block {
            width: 100%;
            justify-content: center;
        }
        
        .add-btn {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 
                0 4px 12px rgba(39, 174, 96, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .add-btn:hover {
            background: linear-gradient(135deg, #229954 0%, #1e8449 100%);
            transform: translateY(-2px);
            box-shadow: 
                0 6px 16px rgba(39, 174, 96, 0.35),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
        }
        
        .add-btn-secondary {
            background: white;
            color: var(--primary-green);
            border: 2px solid var(--primary-green);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
        }
        
        .add-btn-secondary:hover {
            background: var(--mint-bg);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 2px solid #f1f5f9;
        }
        
        .footer-buttons {
            background: white;
            padding: 20px 32px;
            border-top: 2px solid var(--border-gray);
            display: flex;
            justify-content: space-between;
            box-shadow: 0 -2px 12px rgba(0,0,0,0.05);
            position: sticky;
            bottom: 0;
            z-index: 40;
        }
        
        /* ==========================================
           MODALS
           ========================================== */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1000;
            animation: fadeIn 0.2s;
            backdrop-filter: blur(4px);
        }
        
        .modal-overlay.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .modal {
            background: white;
            border-radius: 16px;
            padding: 32px;
            max-width: 600px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 
                0 20px 60px rgba(0, 0, 0, 0.3),
                0 0 0 1px rgba(0, 0, 0, 0.05);
            animation: slideUp 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        @keyframes slideUp {
            from { 
                transform: translateY(50px); 
                opacity: 0; 
            }
            to { 
                transform: translateY(0); 
                opacity: 1; 
            }
        }
        
        .modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .modal-header .icon {
            font-size: 28px;
        }
        
        .modal-header h3 {
            font-size: 22px;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        .modal-body {
            margin-bottom: 24px;
            color: var(--text-dark);
            line-height: 1.7;
            font-weight: 500;
        }
        
        .modal-footer {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }
        
        /* ==========================================
           SETTINGS MODAL
           ========================================== */
        .settings-tabs {
            display: flex;
            gap: 6px;
            margin-bottom: 24px;
            border-bottom: 2px solid #f1f5f9;
        }
        
        .settings-tab {
            padding: 14px 28px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-gray);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 8px;
            border-radius: 8px 8px 0 0;
        }
        
        .settings-tab:hover {
            color: var(--primary-green);
            background: var(--light-gray);
        }
        
        .settings-tab.active {
            color: var(--primary-green);
            border-bottom-color: var(--primary-green);
            background: var(--mint-bg);
        }
        
        .settings-content {
            display: none;
            padding: 24px 0;
        }
        
        .settings-content.active {
            display: block;
        }
        
        /* ==========================================
           LOADING OVERLAY
           ========================================== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            backdrop-filter: blur(8px);
        }
        
        .loading-overlay.active {
            display: flex;
        }
        
        .spinner {
            width: 64px;
            height: 64px;
            border: 6px solid var(--light-green);
            border-top: 6px solid var(--primary-green);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            margin-top: 24px;
            font-size: 16px;
            color: var(--text-dark);
            font-weight: 600;
        }

        /* ==========================================
           CREATIVE COLUMNS
           ========================================== */
        .creative-cell {
            padding: 10px !important;
            text-align: center;
            vertical-align: middle;
        }
        
        .creative-wrapper {
            position: relative;
            display: inline-block;
            cursor: pointer;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .creative-wrapper:hover {
            transform: scale(1.08);
        }
        
        .creative-thumbnail {
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid var(--border-gray);
            transition: all 0.3s;
            display: block;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .creative-thumbnail:hover {
            border-color: var(--primary-green);
            box-shadow: 0 6px 16px rgba(39, 174, 96, 0.25);
        }
        
        .video-badge {
            position: absolute;
            bottom: 6px;
            right: 6px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            font-size: 10px;
            padding: 4px 8px;
            border-radius: 4px;
            font-weight: 700;
            box-shadow: 0 2px 6px rgba(0,0,0,0.3);
        }
        
        .video-badge-large {
            position: absolute;
            top: 12px;
            right: 12px;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            font-size: 16px;
            padding: 10px 18px;
            border-radius: 8px;
            font-weight: 700;
            box-shadow: 0 4px 12px rgba(0,0,0,0.4);
        }
        
        .no-image {
            width: 60px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--light-gray);
            border: 2px dashed var(--border-gray);
            border-radius: 8px;
            font-size: 10px;
            color: var(--text-gray);
            text-align: center;
            line-height: 1.3;
            font-weight: 600;
        }
        
        .image-zoom-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.95);
            z-index: 10000;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            animation: fadeIn 0.2s;
            backdrop-filter: blur(4px);
        }
        
        .image-zoom-overlay img {
            cursor: default;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
            border-radius: 12px;
        }
        
        /* ==========================================
           PAGINATION
           ========================================== */
        .pagination-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            background: var(--light-gray);
            border-top: 2px solid #f1f5f9;
            border-radius: 0 0 12px 12px;
        }
        
        .pagination-info {
            font-size: 14px;
            color: var(--text-gray);
            font-weight: 600;
        }
        
        .pagination-controls {
            display: flex;
            gap: 6px;
            align-items: center;
        }
        
        .pagination-btn {
            padding: 8px 14px;
            border: 2px solid var(--border-gray);
            background: white;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }
        
        .pagination-btn:hover:not(:disabled) {
            border-color: var(--primary-green);
            background: var(--mint-bg);
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(39, 174, 96, 0.15);
        }
        
        .pagination-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }
        
        .pagination-btn.active {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
            border-color: var(--primary-green);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.25);
        }
        
        .pagination-btn.view-all {
            background: linear-gradient(135deg, #f39c12 0%, #e67e22 100%);
            color: white;
            border-color: var(--warning);
            margin-left: 12px;
            box-shadow: 0 4px 12px rgba(243, 156, 18, 0.25);
        }
        
        .pagination-btn.view-all:hover {
            background: linear-gradient(135deg, #e67e22 0%, #d35400 100%);
            box-shadow: 0 6px 16px rgba(243, 156, 18, 0.35);
        }
        
        .pagination-ellipsis {
            padding: 8px 10px;
            color: var(--text-gray);
            font-weight: 600;
        }
        
        /* ==========================================
           SCROLLBAR - CUSTOM
           ========================================== */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 5px;
        }
        
        ::-webkit-scrollbar-thumb {
            background: linear-gradient(180deg, #27ae60 0%, #229954 100%);
            border-radius: 5px;
            border: 2px solid #f1f5f9;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(180deg, #229954 0%, #1e8449 100%);
        }
        
        /* ==========================================
           MISC
           ========================================== */
        .sortable-ghost {
            opacity: 0.5;
            background: var(--mint-bg);
        }
        
        /* Smooth transitions for all interactive elements */
        button, a, input, select, .sidebar-item, .tab-item, .column-item, .dimension-item {
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        /* Focus ring for accessibility */
        button:focus-visible,
        input:focus-visible,
        select:focus-visible {
            outline: 3px solid rgba(39, 174, 96, 0.5);
            outline-offset: 2px;
        }

        /* ==========================================
           METRIC SELECTOR (Comparison Tab)
           ========================================== */
        .metric-selector-container {
            background: var(--mint-bg);
            padding: 20px;
            border-radius: 12px;
            border: 2px solid var(--light-green);
        }
        
        .metric-selector-display {
            background: white;
            padding: 16px;
            border-radius: 8px;
            min-height: 80px;
            margin-bottom: 12px;
            border: 2px dashed var(--border-gray);
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            align-items: center;
        }
        
        .metric-selector-token {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: move;
            transition: all 0.2s;
            user-select: none;
            box-shadow: 0 2px 6px rgba(59, 130, 246, 0.25);
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .metric-selector-token:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.35);
        }
        
        .metric-selector-token .remove-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }
        
        .metric-selector-token .remove-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }
        
        #comparisonMetricDropdown {
            width: 100%;
            padding: 10px 14px;
            border: 2px solid var(--border-gray);
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        #comparisonMetricDropdown:focus {
            border-color: var(--primary-green);
            box-shadow: 0 0 0 3px rgba(39, 174, 96, 0.1);
            outline: none;
        }

        /* ==========================================
           COMPARISON TABLE
           ========================================== */
        .comparison-table {
            border-collapse: collapse;
        }
        
        .comparison-table thead tr {
            background: linear-gradient(135deg, #a8e6cf 0%, #8dd3bb 100%);
        }
        
        .comparison-table th {
            background: transparent;
            padding: 14px 12px;
            font-weight: 700;
            font-size: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-right: 1px solid rgba(255,255,255,0.3);
        }
        
        .comparison-table th:last-child {
            border-right: none;
        }
        
        .comparison-table th[rowspan="2"] {
            vertical-align: middle;
        }
        
        .comparison-table tbody tr {
            transition: all 0.2s;
        }
        
        .comparison-table tbody tr:hover {
            background: linear-gradient(90deg, #f0fdf4 0%, transparent 100%);
        }
        
        .comparison-table tbody td {
            padding: 12px;
            border-bottom: 1px solid #f1f5f9;
            border-right: 1px solid rgba(0,0,0,0.03);
            font-size: 13px;
            font-weight: 500;
        }
        
        .comparison-table tbody td:last-child {
            border-right: none;
        }
        
        /* Dimension cells */
        .comparison-table tbody td[rowspan] {
            background: #fafbfc;
            font-weight: 600;
            vertical-align: middle;
        }
        
        /* Metric name cells */
        .comparison-table tbody td:nth-child(2) {
            font-weight: 600;
            padding-left: 24px;
            color: var(--text-dark);
        }
        
        /* Difference cells with color */
        .comparison-table tbody td[style*="color: rgb(39, 174, 96)"],
        .comparison-table tbody td[style*="color: #27ae60"] {
            background: linear-gradient(90deg, rgba(39, 174, 96, 0.05) 0%, transparent 100%);
        }
        
        .comparison-table tbody td[style*="color: rgb(231, 76, 60)"],
        .comparison-table tbody td[style*="color: #e74c3c"] {
            background: linear-gradient(90deg, rgba(231, 76, 60, 0.05) 0%, transparent 100%);
        }

        /* ==========================================
           CHART CONFIG
           ========================================== */
        .chart-config-item {
            background: white;
            border: 2px solid var(--border-gray);
            border-radius: 12px;
            margin-bottom: 16px;
            overflow: hidden;
            transition: all 0.3s;
        }
        
        .chart-config-item.active {
            border-color: var(--primary-green);
            box-shadow: 0 4px 12px rgba(39, 174, 96, 0.15);
        }
        
        .chart-config-header {
            padding: 16px 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--light-gray);
        }
        
        .chart-config-header:hover {
            background: var(--mint-bg);
        }
        
        .chart-config-item.active .chart-config-header {
            background: linear-gradient(135deg, #e8f8f5 0%, #d1f2eb 100%);
        }
        
        .chart-expand-icon {
            font-size: 16px;
            color: var(--text-gray);
            transition: transform 0.3s;
            flex-shrink: 0;
        }
        
        .chart-config-item.active .chart-expand-icon {
            transform: rotate(90deg);
            color: var(--primary-green);
        }
        
        .chart-type-icon {
            font-size: 20px;
            flex-shrink: 0;
        }
        
        .chart-config-title {
            flex: 1;
            font-size: 15px;
            font-weight: 700;
            color: var(--text-dark);
        }
        
        .chart-config-actions {
            display: flex;
            gap: 8px;
        }
        
        .chart-config-actions button {
            background: white;
            border: none;
            padding: 6px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 16px;
            transition: all 0.2s;
        }
        
        .chart-config-actions button:hover {
            background: var(--primary-green);
            color: white;
            transform: scale(1.1);
        }
        
        .chart-config-body {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out, padding 0.3s ease-out;
            padding: 0 20px;
        }
        
        .chart-config-item.active .chart-config-body {
            max-height: 2000px;
            padding: 20px;
            border-top: 2px solid var(--border-gray);
        }
        
        .chart-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }
        
        .empty-charts {
            text-align: center;
            padding: 40px;
            color: var(--text-gray);
            font-size: 14px;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="loading-overlay" id="loadingOverlay">
        <div style="text-align: center;">
            <div class="spinner"></div>
            <div class="loading-text" id="loadingText">Processing...</div>
        </div>
    </div>

    <div class="container">
        <!-- Sidebar -->
        <div class="sidebar">
            <!-- Toggle Button -->
            <div class="sidebar-hamburger" onclick="toggleSidebar()">
                <i data-lucide="menu"></i>
                <span class="sidebar-item-label"></span>
            </div>
            
            <div class="sidebar-divider"></div>
            
            <!-- Home -->
            <div class="sidebar-item" data-step="welcome" onclick="navigateToStep('welcome')">
                <i data-lucide="home" style="width: 20px; height: 20px; color: white;"></i>
                <span class="sidebar-item-label">Home</span>
                <div class="sidebar-tooltip">Home</div>
            </div>
            
            <!-- Upload -->
            <div class="sidebar-item disabled" data-step="upload" onclick="navigateToStep('upload')">
                <i data-lucide="upload" style="width: 20px; height: 20px; color: white;"></i>
                <span class="sidebar-item-label">Upload CSV</span>
                <div class="sidebar-tooltip">Upload CSV</div>
            </div>
            
            <!-- Mapping -->
            <div class="sidebar-item disabled" data-step="mapping" onclick="navigateToStep('mapping')">
                <i data-lucide="layout-grid" style="width: 20px; height: 20px; color: white;"></i>
                <span class="sidebar-item-label">Mapping</span>
                <div class="sidebar-tooltip">Mapping</div>
            </div>
            
            <!-- Tabs -->
            <div class="sidebar-item disabled" data-step="tabs" onclick="navigateToStep('tabs')">
                <i data-lucide="file-text" style="width: 20px; height: 20px; color: white;"></i>
                <span class="sidebar-item-label">Tabs</span>
                <div class="sidebar-tooltip">Tabs</div>
            </div>
            
            <!-- Summary -->
            <div class="sidebar-item disabled" data-step="summary" onclick="navigateToStep('summary')">
                <i data-lucide="save" style="width: 20px; height: 20px; color: white;"></i>
                <span class="sidebar-item-label">Summary</span>
                <div class="sidebar-tooltip">Summary</div>
            </div>
            
            <!-- Dashboard -->
            <div class="sidebar-item disabled" data-step="dashboard" onclick="navigateToStep('dashboard')">
                <i data-lucide="bar-chart-3" style="width: 20px; height: 20px; color: white;"></i>
                <span class="sidebar-item-label">Dashboard</span>
                <div class="sidebar-tooltip">Dashboard</div>
            </div>
            
            <!-- Spacer -->
            <div style="flex: 1;"></div>
            
            <!-- Settings -->
            <div class="sidebar-item" onclick="openSettingsModal()">
                <i data-lucide="settings" style="width: 20px; height: 20px; color: white;"></i>
                <span class="sidebar-item-label">Settings</span>
                <div class="sidebar-tooltip">Settings</div>
            </div>
        </div>
        
        <div class="main-content">
            <!-- WELCOME SCREEN - AURORA VERSION -->
            <div class="screen active welcome-screen" id="welcomeScreen">
                <!-- Aurora Background Canvas -->
                <canvas id="auroraCanvas" class="aurora-canvas"></canvas>
                
                <!-- Content overlay -->
                <div class="welcome-content">
                    <div class="welcome-logo-container">
                        <div class="welcome-logo">
                            <i data-lucide="bar-chart-3" style="width: 80px; height: 80px; color: white;"></i>
                        </div>
                    </div>
                    
                    <h1 class="welcome-title">Dashboard Builder</h1>
                    <p class="welcome-subtitle">Create beautiful, interactive dashboards from your CSV data</p>
                    
                    <div class="welcome-options">
                        <div class="welcome-card" onclick="startNewDashboard()">
                            <div class="welcome-card-icon">
                                <i data-lucide="file-plus" style="width: 48px; height: 48px;"></i>
                            </div>
                            <div class="welcome-card-title">New Dashboard</div>
                            <div class="welcome-card-desc">Start fresh with a CSV file</div>
                        </div>
                        
                        <div class="welcome-card" onclick="loadFromTemplate()">
                            <div class="welcome-card-icon">
                                <i data-lucide="folder-open" style="width: 48px; height: 48px;"></i>
                            </div>
                            <div class="welcome-card-title">From Template</div>
                            <div class="welcome-card-desc">Load existing configuration</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- UPLOAD SCREEN (Step 1) -->
            <div class="screen upload-screen" id="uploadScreen">
                <div class="header">
                    <div class="header-left">
                        <h1>Step 1: Upload CSV Data</h1>
                        <p>Upload your data file to get started</p>
                    </div>
                </div>
                
                <div class="upload-container">
                    <div class="upload-zone" id="uploadZone" onclick="document.getElementById('csvFileInput').click()">
                        <div class="upload-zone-icon"></div>
                        <div class="upload-zone-title">Drag & Drop CSV File Here</div>
                        <div class="upload-zone-desc">or click to browse<br>Supported: UTF-8, UTF-16</div>
                        <input type="file" id="csvFileInput" accept=".csv" onchange="handleCSVUpload(event)">
                    </div>
                    
                    <div class="preview-section" id="previewSection">
                        <div class="preview-header">
                            <h3> Data Preview</h3>
                            <div class="preview-info" id="previewInfo">
                                <span id="rowCount">0</span> rows  <span id="colCount">0</span> columns
                            </div>
                        </div>
                        
                        <div class="preview-table-container">
                            <table class="preview-table" id="previewTable">
                                <thead id="previewTableHead"></thead>
                                <tbody id="previewTableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <div class="footer-buttons">
                    <button class="btn btn-secondary" onclick="navigateToStep('welcome')">
                        <span></span>
                        <span>Back</span>
                    </button>
                    <button class="btn btn-primary" id="uploadNextBtn" disabled onclick="navigateToStep('mapping')">
                        <span>Next: Map Columns</span>
                        <span></span>
                    </button>
                </div>
            </div>
            
            <!-- MAPPING SCREEN (Step 2) -->
            <div class="screen mapping-screen" id="mappingScreen">
                <div class="mapping-main" id="mappingPanel">
                    <div class="header">
                        <div class="header-left">
                            <h1>Step 2: Map Dimensions & Metrics</h1>
                            <p>Configure your data structure for analysis</p>
                        </div>
                        <div class="header-right">
                            <button class="add-btn add-btn-secondary" onclick="toggleColumnsPanel()">
                                <span></span>
                                <span>Columns</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="mapping-content">
                        <div class="alert alert-info">
                            <span></span>
                            <span>Click [ Columns] to open column list, then drag columns to create dimensions or metrics automatically.</span>
                        </div>
                        
                        <!-- Date Setting Section -->
                        <div class="section-container">
                            <div class="section-header">
                                <div class="section-header-left">
                                    <span class="icon"></span>
                                    <h2>DATE COLUMN SETTING</h2>
                                </div>
                            </div>
                            
                            <div class="date-setting-form">
                                <div class="form-group">
                                    <label>Display Name</label>
                                    <input type="text" id="dateName" placeholder="Date" value="Date">
                                </div>
                                <div class="form-group">
                                    <label>Source Column</label>
                                    <select id="dateColumn" onchange="updateDateColumn()">
                                        <option value="">-- Select Column --</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Format</label>
                                    <select id="dateFormat">
                                        <option value="YYYY/MM/DD" selected>YYYY/MM/DD</option>
                                        <option value="YYYY-MM-DD">YYYY-MM-DD</option>
                                        <option value="DD/MM/YYYY">DD/MM/YYYY</option>
                                        <option value="MM/DD/YYYY">MM/DD/YYYY</option>
                                        <option value="YYYYMMDD">YYYYMMDD</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <!-- Creative Columns Section (NEW!) -->
                        <div class="section-container">
                            <div class="section-header">
                                <div class="section-header-left">
                                    <span class="icon"></span>
                                    <h2>CREATIVE COLUMNS (Optional)</h2>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="enableCreative" onchange="toggleCreativeConfig()">
                                    <label for="enableCreative" style="font-weight: 600;">Enable Creative Report</label>
                                </div>
                            </div>
                            
                            <div id="creativeConfigForm" style="display: none;">
                                <div class="alert alert-info" style="margin-bottom: 20px;">
                                    <span></span>
                                    <span>Configure columns for displaying ad creatives (images/videos) in reports</span>
                                </div>
                                
                                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
                                    <div class="form-group">
                                        <label>Ad Name Column *</label>
                                        <select id="creativeAdName" onchange="updateCreativeConfig()">
                                            <option value="">-- Select Column --</option>
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>File Name Column *</label>
                                        <select id="creativeFileName" onchange="updateCreativeConfig()">
                                            <option value="">-- Select Column --</option>
                                        </select>
                                        <div class="checkbox-item" style="margin-top: 8px;">
                                            <input type="checkbox" id="sameAsAdName" onchange="toggleSameAsAdName()">
                                            <label for="sameAsAdName" style="font-size: 12px;">Same as Ad Name</label>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group" style="margin-bottom: 20px;">
                                    <label>Ad Format Column *</label>
                                    <select id="creativeAdFormat" onchange="updateCreativeConfig()">
                                        <option value="">-- Select Column --</option>
                                    </select>
                                    <p style="font-size: 12px; color: var(--text-gray); margin-top: 5px;">
                                        Column containing format type (/ or static/video)
                                    </p>
                                </div>
                                
                                <div style="background: var(--mint-bg); padding: 20px; border-radius: 8px; border: 2px solid var(--light-green); margin-bottom: 20px;">
                                    <h4 style="margin-bottom: 15px; color: var(--text-dark);"> Image URLs</h4>
                                    
                                    <div class="form-group" style="margin-bottom: 15px;">
                                        <label>Thumbnail URL Column (Optional)</label>
                                        <select id="creativeThumbnailUrl" onchange="updateCreativeConfig()">
                                            <option value="">-- Select Column --</option>
                                        </select>
                                        <p style="font-size: 12px; color: var(--text-gray); margin-top: 5px;">
                                            If available, this will be used for both static and video thumbnails
                                        </p>
                                    </div>
                                    
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                        <div class="form-group">
                                            <label>Static URL Column</label>
                                            <select id="creativeStaticUrl" onchange="updateCreativeConfig()">
                                                <option value="">-- Select Column --</option>
                                            </select>
                                            <div class="checkbox-item" style="margin-top: 8px;">
                                                <input type="checkbox" id="useThumbForStatic" onchange="toggleUseThumbnail()">
                                                <label for="useThumbForStatic" style="font-size: 12px;">Use Thumbnail URL</label>
                                            </div>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label>Video URL Column</label>
                                            <select id="creativeVideoUrl" onchange="updateCreativeConfig()">
                                                <option value="">-- Select Column --</option>
                                            </select>
                                            <div class="checkbox-item" style="margin-top: 8px;">
                                                <input type="checkbox" id="useThumbForVideo" onchange="toggleUseThumbnail()">
                                                <label for="useThumbForVideo" style="font-size: 12px;">Use Thumbnail URL</label>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label>Thumbnail Size</label>
                                    <div class="radio-group">
                                        <label>
                                            <input type="radio" name="thumbnailSize" value="small" onchange="updateCreativeConfig()">
                                            <span>Small (4053)</span>
                                        </label>
                                        <label>
                                            <input type="radio" name="thumbnailSize" value="medium" checked onchange="updateCreativeConfig()">
                                            <span>Medium (6080)</span>
                                        </label>
                                        <label>
                                            <input type="radio" name="thumbnailSize" value="large" onchange="updateCreativeConfig()">
                                            <span>Large (80107)</span>
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        
                        <!-- Dimensions Section -->
                        <div class="section-container" id="dimensionsSection">
                            <div class="drop-zone-overlay">
                                 Drop here to add as Dimension
                            </div>
                            
                            <div class="section-header">
                                <div class="section-header-left">
                                    <span class="icon"></span>
                                    <h2>DIMENSIONS</h2>
                                </div>
                                <button class="add-btn add-btn-secondary" onclick="addDimension()">
                                    <span></span>
                                    <span>Add Manually</span>
                                </button>
                            </div>
                            
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th style="width: 30px;"></th>
                                        <th style="width: 40px;">#</th>
                                        <th>Display Name</th>
                                        <th>Source Column</th>
                                        <th style="width: 50px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="dimensionsBody">
                                    <!-- Dimensions will be added here -->
                                </tbody>
                            </table>
                        </div>
                        
                        <!-- Metrics Section -->
                        <div class="section-container" id="metricsSection">
                            <div class="drop-zone-overlay">
                                 Drop here to add as Metric
                            </div>
                            
                            <div class="section-header">
                                <div class="section-header-left">
                                    <span class="icon"></span>
                                    <h2>METRICS</h2>
                                </div>
                                <button class="add-btn add-btn-secondary" onclick="addMetric()">
                                    <span></span>
                                    <span>Add Manually</span>
                                </button>
                            </div>
                            
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <th style="width: 30px;"></th>
                                        <th style="width: 40px;">#</th>
                                        <th>Name</th>
                                        <th>Source</th>
                                        <th style="width: 80px;">Calc</th>
                                        <th>Info</th>
                                        <th style="width: 50px;"></th>
                                    </tr>
                                </thead>
                                <tbody id="metricsBody">
                                    <!-- Metrics will be added here -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                
                <!-- Columns Panel -->
                <div class="columns-panel" id="columnsPanel">
                    <div class="columns-panel-header">
                        <h3> Available Columns</h3>
                        <button class="close-panel-btn" onclick="toggleColumnsPanel()"></button>
                    </div>
                    <div class="columns-panel-content">
                        <div class="search-box">
                            <input type="text" placeholder="Search columns..." id="columnSearch" oninput="filterColumns()">
                            <span class="search-icon"></span>
                        </div>
                        
                        <div class="column-list" id="columnList"></div>
                    </div>
                </div>
                
                <!-- Edit Panel -->
                <div class="edit-panel" id="editPanel">
                    <h3> Edit Metric: <span id="editMetricName">-</span></h3>
                    
                    <div class="form-group">
                        <label>Display Name</label>
                        <input type="text" id="metricDisplayName" placeholder="Enter display name">
                    </div>
                    
                    <div class="form-group">
                        <label>Type</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="metricType" value="base" onchange="toggleMetricType()">
                                <span>Base Metric</span>
                            </label>
                            <label>
                                <input type="radio" name="metricType" value="calculated" onchange="toggleMetricType()">
                                <span>Calculated</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group" id="baseMetricSection">
                        <label>Source Column</label>
                        <select id="sourceColumn"></select>
                    </div>
                    
                    <div class="form-group" id="calculatedMetricSection" style="display: none;">
                        <label> Formula Builder</label>
                        <div class="formula-builder">
                            <div class="formula-display" id="formulaDisplay"></div>
                            
                            <div style="margin: 10px 0; font-size: 12px; color: var(--text-gray);">
                                 Click to select, Delete to remove, Drag to reorder
                            </div>
                            
                            <div class="formula-controls">
                                <select id="metricDropdown" onchange="addMetricToken()">
                                    <option value="">+ Metric </option>
                                </select>
                                
                                <select id="operatorDropdown" onchange="addOperatorToken()">
                                    <option value="">+ Operator </option>
                                    <option value="+">+ (Add)</option>
                                    <option value="-">- (Subtract)</option>
                                    <option value="*"> (Multiply)</option>
                                    <option value="/">/  (Divide)</option>
                                </select>
                                
                                <button class="formula-btn" onclick="showNumberInput()">+ Number</button>
                                <button class="formula-btn" onclick="clearFormula()">Clear All</button>
                            </div>
                            
                            <div id="numberInputSection" style="display: none; margin-top: 10px;">
                                <div style="display: flex; gap: 10px;">
                                    <input type="number" id="numberInput" placeholder="Enter number" 
                                           style="flex: 1; padding: 8px; border: 2px solid var(--border-gray); border-radius: 6px;">
                                    <button class="formula-btn" onclick="addNumberToken()">Add</button>
                                    <button class="formula-btn" onclick="cancelNumberInput()">Cancel</button>
                                </div>
                            </div>
                            
                            <div class="formula-preview">
                                <strong>Result Preview:</strong> <span id="formulaPreview">-</span><br>
                                <span style="font-size: 11px; color: var(--text-gray);">(Based on sample data)</span><br>
                                <span id="formulaStatus"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Format Type</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="formatType" value="number" onchange="toggleCurrencyField()">
                                <span>Number</span>
                            </label>
                            <label>
                                <input type="radio" name="formatType" value="percentage" onchange="toggleCurrencyField()">
                                <span>Percentage</span>
                            </label>
                            <label>
                                <input type="radio" name="formatType" value="currency" onchange="toggleCurrencyField()">
                                <span>Currency</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Decimal Places</label>
                        <select id="decimalPlaces" onchange="updateFormulaPreview()">
                            <option value="0" selected>0</option>
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Number Format</label>
                        <div class="checkbox-item">
                            <input type="checkbox" id="thousandSeparator" checked onchange="updateFormulaPreview()">
                            <label for="thousandSeparator">Use thousand separator (1,234 vs 1234)</label>
                        </div>
                    </div>
                    
                    <div class="form-group" id="currencySection" style="display: none;">
                        <label>Currency Symbol</label>
                        <select id="currencySymbol" onchange="updateFormulaPreview()">
                            <option value="$">$ (USD)</option>
                            <option value="" selected> (JPY)</option>
                            <option value=""> (EUR)</option>
                            <option value=""> (VND)</option>
                            <option value=""> (GBP)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Data Bar</label>
                        <div style="margin-top: 10px;">
                            <div class="checkbox-item" style="margin-bottom: 15px;">
                                <input type="checkbox" id="dataBarEnable" onchange="toggleDataBarOptions()">
                                <label for="dataBarEnable">Enable Data Bar</label>
                            </div>
                            
                            <div id="dataBarOptions" style="display: none;">
                                <div class="radio-group" style="margin-bottom: 15px;">
                                    <label>
                                        <input type="radio" name="barStyle" value="solid" checked>
                                        <span>Solid</span>
                                    </label>
                                    <label>
                                        <input type="radio" name="barStyle" value="gradient">
                                        <span>Gradient</span>
                                    </label>
                                </div>
                                
                                <label style="display: flex; align-items: center; gap: 10px;">
                                    <span>Color:</span>
                                    <input type="color" id="dataBarColor" value="#27ae60" style="width: 60px; height: 35px; border: none; cursor: pointer; border-radius: 4px;">
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="action-buttons">
                        <button class="btn btn-primary" onclick="saveMetric()">
                            <span></span>
                            <span>Apply</span>
                        </button>
                        <button class="btn btn-secondary" onclick="closeEditPanel()">
                            <span></span>
                            <span>Cancel</span>
                        </button>
                        <button class="btn btn-danger" onclick="deleteCurrentMetric()">
                            <span></span>
                            <span>Delete</span>
                        </button>
                    </div>
                </div>
            </div>  <!--  NG .screen -->
            
            <!--  FOOTER  NGOI -->
            <div class="footer-buttons" id="mappingFooter" style="display: none;">
                <button class="btn btn-secondary" onclick="navigateToStep('upload')">
                    <span></span>
                    <span>Back</span>
                </button>
                <button class="btn btn-primary" onclick="proceedToTabs()">
                    <span>Next: Create Tabs</span>
                    <span></span>
                </button>
            </div>
            
            <!-- TAB CONFIGURATION SCREEN (Step 3) -->
            <div class="screen tab-config-screen" id="tabsScreen">
                <div class="tabs-sidebar">
                    <div class="tabs-sidebar-header">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                            <h2> Tabs</h2>
                            <button class="btn btn-primary" onclick="addNewTab()" style="padding: 8px 16px; font-size: 13px;">
                                <span></span>
                                <span>Add</span>
                            </button>
                        </div>
                        <p style="font-size: 12px; color: var(--text-gray);">
                            Drag to reorder
                        </p>
                    </div>
                    
                    <div class="tabs-list" id="tabsList">
                        <!-- Tabs will be added here -->
                    </div>
                </div>
                
                <div class="config-panel" id="configPanel">
                    <div class="empty-state" id="emptyState">
                        <div class="icon"></div>
                        <h3>No Tabs Yet</h3>
                        <p>Click "Add New Tab" to create your first dashboard tab</p>
                    </div>
                    
                    <div id="tabConfig" style="display: none;">
                        <div class="alert alert-info">
                            <span></span>
                            <span>Configure tab settings. Changes are not saved until you click "Save Tab".</span>
                        </div>
                        
                        <div class="section">
                            <div class="form-group">
                                <label>Tab Name</label>
                                <input type="text" id="tabName" placeholder="e.g., Media x Daily">
                            </div>
                            
                            <div class="form-group" style="margin-top: 20px;">
                                <label>Tab Type</label>
                                <div class="radio-group">
                                    <label>
                                        <input type="radio" name="tabType" value="standard" checked onchange="toggleTabType()">
                                        <span> Standard</span>
                                    </label>
                                    <label>
                                        <input type="radio" name="tabType" value="creative" onchange="toggleTabType()" id="creativeTabTypeRadio">
                                        <span> Creative</span>
                                    </label>
                                    <label>
                                        <input type="radio" name="tabType" value="comparison" onchange="toggleTabType()">
                                        <span> Comparison</span>
                                    </label>
                                    <label>
                                        <input type="radio" name="tabType" value="chart" onchange="toggleTabType()">
                                        <span> Chart</span>
                                    </label>
                                </div>
                                <p id="creativeTabWarning" style="display: none; font-size: 12px; color: var(--error); margin-top: 5px;">
                                     Creative Report is not configured in Step 2
                                </p>
                            </div>
                        </div>

                        <!-- COMPARISON CONFIG (NEW!) -->
                        <div id="comparisonConfig" style="display: none;">
                            
                            <!-- Date Range Mode -->
                            <div class="section">
                                <div class="section-header">
                                    <span class="icon"></span>
                                    <h3>Date Range Mode</h3>
                                </div>
                                
                                <div class="radio-group">
                                    <label>
                                        <input type="radio" name="dateRangeMode" value="smart" checked onchange="toggleDateRangeMode()">
                                        <span> Smart (Auto-update)</span>
                                    </label>
                                    <label>
                                        <input type="radio" name="dateRangeMode" value="custom" onchange="toggleDateRangeMode()">
                                        <span> Custom (Fixed dates)</span>
                                    </label>
                                </div>
                            </div>
                            
                            <!-- Smart Mode -->
                            <div id="smartModeConfig" class="section">
                                <div class="form-group">
                                    <label>Smart Template</label>
                                    <select id="smartTemplate" onchange="updateSmartPreview()">
                                        <option value="this_week_vs_last">This Week vs Last Week</option>
                                        <option value="last_7_vs_prev_7" selected>Last 7 Days vs Previous 7 Days</option>
                                        <option value="this_month_vs_last">This Month vs Last Month</option>
                                        <option value="last_30_vs_prev_30">Last 30 Days vs Previous 30 Days</option>
                                    </select>
                                </div>
                                
                                <div class="alert alert-info" style="margin-top: 15px;">
                                    <span></span>
                                    <div>
                                        <strong>Preview (Today: <span id="smartToday"></span>)</strong><br>
                                        <span id="smartPeriod1Preview"></span><br>
                                        <span id="smartPeriod2Preview"></span><br>
                                        <span style="font-size: 12px; color: var(--text-gray); margin-top: 5px; display: inline-block;">
                                             Dates auto-update daily based on current date
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Custom Mode -->
                            <div id="customModeConfig" class="section" style="display: none;">
                                <div style="background: var(--mint-bg); padding: 20px; border-radius: 12px; border: 2px solid var(--light-green); margin-bottom: 20px;">
                                    <h4 style="margin-bottom: 15px; color: var(--text-dark); font-weight: 700;"> Period 1</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                        <div class="form-group">
                                            <label>From Date</label>
                                            <input type="text" id="customPeriod1From" placeholder="YYYY-MM-DD">
                                        </div>
                                        <div class="form-group">
                                            <label>To Date</label>
                                            <input type="text" id="customPeriod1To" placeholder="YYYY-MM-DD">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Label (Optional)</label>
                                        <input type="text" id="customPeriod1Label" placeholder="e.g., First Half">
                                    </div>
                                </div>
                                
                                <div style="background: var(--light-gray); padding: 20px; border-radius: 12px; border: 2px solid var(--border-gray);">
                                    <h4 style="margin-bottom: 15px; color: var(--text-dark); font-weight: 700;"> Period 2</h4>
                                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                                        <div class="form-group">
                                            <label>From Date</label>
                                            <input type="text" id="customPeriod2From" placeholder="YYYY-MM-DD">
                                        </div>
                                        <div class="form-group">
                                            <label>To Date</label>
                                            <input type="text" id="customPeriod2To" placeholder="YYYY-MM-DD">
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Label (Optional)</label>
                                        <input type="text" id="customPeriod2Label" placeholder="e.g., Second Half">
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Dimension Selector (NEW!) -->
                            <div class="section">
                                <div class="section-header">
                                    <span class="icon"></span>
                                    <h3>Dimensions (Optional)</h3>
                                </div>
                                
                                <div class="metric-selector-container">
                                    <div class="metric-selector-display" id="comparisonDimensionsDisplay">
                                        <div style="text-align: center; padding: 20px; color: var(--text-gray); font-size: 14px;">
                                            No dimensions selected.<br>
                                            Data will be aggregated as total.
                                        </div>
                                    </div>
                                    
                                    <select id="comparisonDimensionDropdown" onchange="addDimensionToComparison()" style="margin-top: 12px;">
                                        <option value="">+ Add Dimension </option>
                                    </select>
                                </div>
                            </div>

                            <!-- Metric Selector -->
                            <div class="section">
                                <div class="section-header">
                                    <span class="icon"></span>
                                    <h3>Metrics to Compare</h3>
                                </div>
                                
                                <div class="metric-selector-container">
                                    <div class="metric-selector-display" id="comparisonMetricsDisplay">
                                        <div style="text-align: center; padding: 20px; color: var(--text-gray); font-size: 14px;">
                                            No metrics selected.<br>Click dropdown below to add metrics.
                                        </div>
                                    </div>
                                    
                                    <select id="comparisonMetricDropdown" onchange="addMetricToComparison()" style="margin-top: 12px;">
                                        <option value="">+ Add Metric </option>
                                    </select>
                                </div>
                            </div>
                            
                            <!-- Comparison Options -->
                            <div class="section">
                                <div class="section-header">
                                    <span class="icon"></span>
                                    <h3>Display Options</h3>
                                </div>
                                
                                <div class="checkbox-group">
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="compShowAbsolute" checked>
                                        <label for="compShowAbsolute">Show absolute difference (+20,000)</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="compShowPercentage" checked>
                                        <label for="compShowPercentage">Show percentage change (+20%)</label>
                                    </div>
                                    <div class="checkbox-item">
                                        <input type="checkbox" id="compColorCoding" checked>
                                        <label for="compColorCoding">Color coding (green  / red )</label>
                                    </div>
                                </div>
                            </div>
                            
                        </div>

                        <!-- CHART CONFIG (NEW!) -->
                        <div id="chartConfig" style="display: none;">
                            
                            <div class="alert alert-info">
                                <span></span>
                                <span>Create multiple charts in this tab. Click chart title to expand/collapse settings.</span>
                            </div>
                            
                            <!-- Charts List -->
                            <div class="section">
                                <div class="section-header">
                                    <span class="icon"></span>
                                    <h3>Charts in this tab</h3>
                                </div>
                                
                                <div id="chartsList">
                                    <div class="empty-charts" style="text-align: center; padding: 40px; color: var(--text-gray);">
                                        No charts yet.<br>
                                        Click "Add New Chart" to create your first chart.
                                    </div>
                                </div>
                                
                                <button class="btn btn-primary btn-block" onclick="addNewChart()" style="margin-top: 16px;">
                                    <span></span>
                                    <span>Add New Chart</span>
                                </button>
                            </div>
                            
                        </div>
                        
                        <div class="section" id="tabdimensionsSection">
                            <div class="section-header">
                                <span class="icon"></span>
                                <h3>Dimensions</h3>
                            </div>
                            
                            <div class="dimension-selection">
                                <div class="dimension-column">
                                    <h4>Available</h4>
                                    <div class="dimension-list" id="availableDimensions">
                                        <!-- Will be populated -->
                                    </div>
                                </div>
                                
                                <div class="dimension-column">
                                    <h4>Selected (Drag to reorder)</h4>
                                    <div class="dimension-list" id="selectedDimensions">
                                        <!-- Will be populated -->
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="section"  id="groupBySection">
                            <div class="form-group">
                                <label>Group By (Optional)</label>
                                <select id="groupBy">
                                    <option value="">None - Single table</option>
                                </select>
                                <p style="font-size: 12px; color: var(--text-gray); margin-top: 5px;">
                                    Create separate tables for each value
                                </p>
                            </div>
                        </div>
                        
                        <div class="section">
                            <div class="section-header">
                                <span class="icon"></span>
                                <h3>Options</h3>
                            </div>
                            
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="hideDuplicates">
                                    <label for="hideDuplicates">Hide duplicate values in dimensions</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="showTotal" checked>
                                    <label for="showTotal">Show total row</label>
                                </div>
                            </div>
                        </div>
                        
                        <div class="section">
                            <div class="section-header">
                                <span class="icon"></span>
                                <h3>Filters (Optional)</h3>
                            </div>
                            
                            <div class="filters-section">
                                <div id="filtersList">
                                    <div class="empty-filters">
                                        No filters applied.<br>
                                        All data will be displayed.
                                    </div>
                                </div>
                                
                                <button class="btn btn-secondary btn-block" onclick="addFilter()" style="margin-top: 15px;">
                                    <span></span>
                                    <span>Add Filter</span>
                                </button>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn btn-secondary" onclick="previewTab()">
                                <span></span>
                                <span>Preview</span>
                            </button>
                            <button class="btn btn-primary" onclick="saveTab()">
                                <span></span>
                                <span>Save Tab</span>
                            </button>
                            <button class="btn btn-secondary" onclick="cancelTabEdit()">
                                <span></span>
                                <span>Cancel</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>  <!--  NG .screen  Y -->
            
            <!--  FOOTER  NGOI .screen -->
            <div class="footer-buttons" id="tabsFooter" style="display: none;">
                <button class="btn btn-secondary" onclick="navigateToStep('mapping')">
                    <span></span>
                    <span>Back</span>
                </button>
                <button class="btn btn-primary" onclick="proceedToSummary()">
                    <span>Next: Template Info</span>
                    <span></span>
                </button>
            </div>
            
            <!-- SUMMARY SCREEN (Step 4) -->
            <div class="screen summary-screen" id="summaryScreen">
                <div class="header">
                    <div class="header-left">
                        <h1>Step 4: Template Information & Summary</h1>
                        <p>Review and save your configuration</p>
                    </div>
                </div>
                
                <div class="summary-container">
                    <div class="summary-card">
                        <div class="summary-card-header">
                            <span class="icon"></span>
                            <h3>Template Information</h3>
                        </div>
                        
                        <div class="summary-grid">
                            <div class="form-group">
                                <label>Client Name *</label>
                                <input type="text" id="clientName" placeholder="Enter client name">
                            </div>
                            
                            <div class="form-group">
                                <label>Service *</label>
                                <input type="text" id="serviceName" placeholder="Enter service name">
                            </div>
                        </div>
                        
                        <div class="form-group" style="margin-top: 20px;">
                            <label>Report Type *</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="reportType" value="Daily" checked>
                                    <span>Daily</span>
                                </label>
                                <label>
                                    <input type="radio" name="reportType" value="Weekly">
                                    <span>Weekly</span>
                                </label>
                                <label>
                                    <input type="radio" name="reportType" value="Monthly">
                                    <span>Monthly</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <div class="summary-card">
                        <div class="summary-card-header">
                            <span class="icon"></span>
                            <h3>Configuration Summary</h3>
                        </div>
                        
                        <div class="summary-stats">
                            <div class="stat-box">
                                <div class="stat-number" id="statTabs">0</div>
                                <div class="stat-label">Tabs</div>
                            </div>
                            
                            <div class="stat-box">
                                <div class="stat-number" id="statDimensions">0</div>
                                <div class="stat-label">Dimensions</div>
                            </div>
                            
                            <div class="stat-box">
                                <div class="stat-number" id="statMetrics">0</div>
                                <div class="stat-label">Metrics</div>
                            </div>
                        </div>
                        
                        <div style="margin-top: 30px;">
                            <button class="btn btn-secondary btn-block" onclick="exportTemplate()">
                                <span></span>
                                <span>Save Template (JSON)</span>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="footer-buttons">
                    <button class="btn btn-secondary" onclick="navigateToStep('tabs')">
                        <span></span>
                        <span>Back</span>
                    </button>
                    <button class="btn btn-primary" onclick="proceedToDashboard()">
                        <span> Go to Dashboard</span>
                        <span></span>
                    </button>
                </div>
            </div>
            
            <!-- DASHBOARD SCREEN -->
            <div class="screen dashboard-screen" id="dashboardScreen">
                <div class="dashboard-header">
                    <div>
                        <h1 class="dashboard-title"> Dashboard</h1>
                        <div class="dashboard-meta">
                            <div class="dashboard-meta-item">
                                <span class="icon"></span>
                                <span id="dashClientName">-</span>
                            </div>
                            <div class="dashboard-meta-item">
                                <span class="icon"></span>
                                <span id="dashService">-</span>
                            </div>
                            <div class="dashboard-meta-item">
                                <span class="icon"></span>
                                <span id="dashReportType">-</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-controls">
                         <button class="btn btn-primary" onclick="exportToExcel()" style="margin-right: 16px;">
                            <i data-lucide="download" style="width: 16px; height: 16px;"></i>
                            <span>Export Excel</span>
                        </button>
                        <div class="date-range-picker">
                            <label> Date Range:</label>
                            <input type="text" id="dateRangeStart" placeholder="Start date">
                            <span style="color: var(--text-gray); font-weight: 600;">to</span>
                            <input type="text" id="dateRangeEnd" placeholder="End date">
                            <button class="btn btn-primary" onclick="applyDateFilter()">Apply</button>
                        </div>
                    </div>
                </div>
                
                <div class="dashboard-tabs" id="dashboardTabs">
                    <!-- Tabs will be rendered here -->
                </div>
                
                <div class="dashboard-content" id="dashboardContent">
                    <!-- Dashboard tables will be rendered here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settingsModalOverlay">
        <div class="modal" style="max-width: 700px;">
            <div class="modal-header">
                <span class="icon"</span>
                <h3>Dashboard Settings</h3>
            </div>
            
            <div class="modal-body">
                <!-- Settings Tabs -->
                <div class="settings-tabs">
                    <button class="settings-tab active" onclick="switchSettingsTab('display', this)">
                        <span></span>
                        <span>Display</span>
                    </button>
                    <button class="settings-tab" onclick="switchSettingsTab('theme', this)">
                        <span></span>
                        <span>Theme</span>
                    </button>
                </div>
                
                <!-- Display Tab Content -->
                <div class="settings-content active" id="settingsDisplay">
                    <h4 style="margin-bottom: 15px; color: var(--text-dark); font-size: 16px;"> Table Display</h4>
                    
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="settingStickyDim">
                            <label for="settingStickyDim">Sticky dimensions when scrolling</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="settingTooltips">
                            <label for="settingTooltips">Show tooltips on hover</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="settingAlternateRows">
                            <label for="settingAlternateRows">Alternate row colors</label>
                        </div>
                    </div>
                    
                    <div class="form-group" style="margin-top: 20px;">
                        <label>Column Width</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="settingColumnWidth" value="auto" checked onchange="toggleFixedWidthInput()">
                                <span>Auto</span>
                            </label>
                            <label>
                                <input type="radio" name="settingColumnWidth" value="fixed" onchange="toggleFixedWidthInput()">
                                <span>Fixed</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="form-group" id="fixedWidthInput" style="display: none;">
                        <label>Fixed Width (px)</label>
                        <input type="number" id="settingFixedWidth" value="150" min="80" max="400" style="width: 150px;">
                    </div>
                </div>
                
                <!-- Theme Tab Content -->
                <div class="settings-content" id="settingsTheme">
                    <h4 style="margin-bottom: 15px; color: var(--text-dark); font-size: 16px;"> Color Scheme</h4>
                    
                    <div class="form-group">
                        <label>Primary Color</label>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="color" id="settingPrimaryColor" value="#27ae60" style="width: 80px; height: 40px; border: 2px solid var(--border-gray); border-radius: 6px; cursor: pointer;">
                            <span id="primaryColorPreview" style="font-family: monospace; color: var(--text-gray);">#27ae60</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Header Background</label>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="color" id="settingHeaderBg" value="#a8e6cf" style="width: 80px; height: 40px; border: 2px solid var(--border-gray); border-radius: 6px; cursor: pointer;">
                            <span id="headerBgPreview" style="font-family: monospace; color: var(--text-gray);">#a8e6cf</span>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>Total Row Color</label>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="color" id="settingTotalRowColor" value="#e8f8f5" style="width: 80px; height: 40px; border: 2px solid var(--border-gray); border-radius: 6px; cursor: pointer;">
                            <span id="totalRowColorPreview" style="font-family: monospace; color: var(--text-gray);">#e8f8f5</span>
                        </div>
                    </div>
                    
                    <h4 style="margin: 25px 0 15px; color: var(--text-dark); font-size: 16px;"> Typography</h4>
                    
                    <div class="form-group">
                        <label>Font Size</label>
                        <div class="radio-group">
                            <label>
                                <input type="radio" name="settingFontSize" value="small">
                                <span>Small (12px)</span>
                            </label>
                            <label>
                                <input type="radio" name="settingFontSize" value="medium" checked>
                                <span>Medium (14px)</span>
                            </label>
                            <label>
                                <input type="radio" name="settingFontSize" value="large">
                                <span>Large (16px)</span>
                            </label>
                        </div>
                    </div>
                    
                    <button class="btn btn-secondary" onclick="resetThemeToDefault()" style="margin-top: 20px;">
                        <span></span>
                        <span>Reset to Default</span>
                    </button>
                </div>
            </div>
            
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeSettingsModal()">Cancel</button>
                <button class="btn btn-primary" onclick="applySettings()">Apply</button>
                <button class="btn btn-primary" onclick="saveTemplateFromSettings()">
                    <span></span>
                    <span>Save Template</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-header">
                <span class="icon" id="modalIcon"></span>
                <h3 id="modalTitle">Confirmation</h3>
            </div>
            <div class="modal-body" id="modalBody">
                Are you sure?
            </div>
            <div class="modal-footer" id="modalFooter">
                <button class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn btn-primary" id="modalConfirmBtn" onclick="closeModal()">OK</button>
            </div>
        </div>
    </div>
        <script>
        // ========================================
        // GLOBAL STATE
        // ========================================
        
        let currentStep = 'welcome';
        let csvData = {
            headers: [],
            rows: [],
            raw: null
        };

       let dashboardSettings = {
            display: {
                stickyDimensions: false,
                showTooltips: false,
                alternateRowColors: false,
                columnWidth: 'auto',
                fixedColumnWidth: 150
            },
            theme: {
                primaryColor: '#27ae60',
                headerBackground: '#a8e6cf',
                totalRowColor: '#e8f8f5',
                fontSize: 'medium'
            }
        };
        
        function getDefaultSettings() {
            return {
                display: {
                    stickyDimensions: false,
                    showTooltips: false,
                    alternateRowColors: false,
                    columnWidth: 'auto',
                    fixedColumnWidth: 150
                },
                theme: {
                    primaryColor: '#27ae60',
                    headerBackground: '#a8e6cf',
                    totalRowColor: '#e8f8f5',
                    fontSize: 'medium'
                }
            };
        }
        
        let dateConfig = {
            displayName: 'Date',
            sourceColumn: '',
            format: 'YYYY/MM/DD'
        };

        let creativeConfig = {
            enabled: false,
            adNameColumn: '',
            fileNameColumn: '',
            sameAsAdName: false,
            adFormatColumn: '',
            thumbnailUrlColumn: '',
            staticUrlColumn: '',
            videoUrlColumn: '',
            useThumbnailForStatic: false,
            useThumbnailForVideo: false,
            thumbnailSize: 'medium'
        };
        
        const thumbnailSizes = {
            small: { w: 40, h: 53 },
            medium: { w: 60, h: 80 },
            large: { w: 80, h: 107 }
        };
        
        let zoomedImage = null;

        // Pagination state for each table
        let tablePaginationState = new Map(); // key: tableId, value: { currentPage, pageSize, viewAll }
        
        const DEFAULT_PAGE_SIZE = 50;
        
        let dimensions = [];
        let metrics = [];
        let tabs = [];
        
        let templateMetadata = {
            clientName: '',
            service: '',
            reportType: 'Daily',
            createdAt: null,
            updatedAt: null
        };
        
        let dimensionIdCounter = 1;
        let metricIdCounter = 1;
        let tabIdCounter = 1;
        let filterIdCounter = 1;
        let chartIdCounter = 1;

        // Smart Date Templates
        const smartTemplates = {
            'this_week_vs_last': {
                label: 'This Week vs Last Week',
                calculate: () => {
                    const today = new Date();
                    const dayOfWeek = today.getDay();
                    
                    const thisMonday = new Date(today);
                    thisMonday.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                    
                    const lastMonday = new Date(thisMonday);
                    lastMonday.setDate(thisMonday.getDate() - 7);
                    const lastSunday = new Date(thisMonday);
                    lastSunday.setDate(thisMonday.getDate() - 1);
                    
                    return {
                        period1: {
                            from: formatDate(lastMonday),
                            to: formatDate(lastSunday),
                            label: 'Last Week'
                        },
                        period2: {
                            from: formatDate(thisMonday),
                            to: formatDate(today),
                            label: 'This Week'
                        }
                    };
                }
            },
            
            'last_7_vs_prev_7': {
                label: 'Last 7 Days vs Previous 7 Days',
                calculate: () => {
                    const today = new Date();
                    
                    const period2End = new Date(today);
                    period2End.setDate(today.getDate() - 1);
                    const period2Start = new Date(today);
                    period2Start.setDate(today.getDate() - 7);
                    
                    const period1End = new Date(today);
                    period1End.setDate(today.getDate() - 8);
                    const period1Start = new Date(today);
                    period1Start.setDate(today.getDate() - 14);
                    
                    return {
                        period1: {
                            from: formatDate(period1Start),
                            to: formatDate(period1End),
                            label: 'Previous 7 Days'
                        },
                        period2: {
                            from: formatDate(period2Start),
                            to: formatDate(period2End),
                            label: 'Last 7 Days'
                        }
                    };
                }
            },
            
            'this_month_vs_last': {
                label: 'This Month vs Last Month',
                calculate: () => {
                    const today = new Date();
                    
                    const thisMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    
                    const lastMonthStart = new Date(today.getFullYear(), today.getMonth() - 1, 1);
                    const lastMonthEnd = new Date(today.getFullYear(), today.getMonth(), 0);
                    
                    return {
                        period1: {
                            from: formatDate(lastMonthStart),
                            to: formatDate(lastMonthEnd),
                            label: 'Last Month'
                        },
                        period2: {
                            from: formatDate(thisMonthStart),
                            to: formatDate(today),
                            label: 'This Month (MTD)'
                        }
                    };
                }
            },
            
            'last_30_vs_prev_30': {
                label: 'Last 30 Days vs Previous 30 Days',
                calculate: () => {
                    const today = new Date();
                    
                    const period2End = new Date(today);
                    period2End.setDate(today.getDate() - 1);
                    const period2Start = new Date(today);
                    period2Start.setDate(today.getDate() - 30);
                    
                    const period1End = new Date(today);
                    period1End.setDate(today.getDate() - 31);
                    const period1Start = new Date(today);
                    period1Start.setDate(today.getDate() - 60);
                    
                    return {
                        period1: {
                            from: formatDate(period1Start),
                            to: formatDate(period1End),
                            label: 'Previous 30 Days'
                        },
                        period2: {
                            from: formatDate(period2Start),
                            to: formatDate(period2End),
                            label: 'Last 30 Days'
                        }
                    };
                }
            }
        };
        
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }
        
        function formatDateDisplay(dateStr) {
            // Convert YYYY-MM-DD to display format
            const parts = dateStr.split('-');
            return `${parts[0]}/${parts[1]}/${parts[2]}`;
        }
        
        function getDaysBetween(from, to) {
            const fromDate = new Date(from);
            const toDate = new Date(to);
            const diffTime = Math.abs(toDate - fromDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)) + 1;
            return diffDays;
        }
        
        let currentEditingMetricId = null;
        let currentEditingTabId = null;
        let selectedFormulaToken = null;
        
        let hasUnsavedChanges = false;
        let draggedColumn = null;
        
        let filteredData = null;
        let isLoadingTemplate = false;
        
        // Operators
        const operators = {
            text: [
                { value: 'equals', label: 'Equals (=)' },
                { value: 'not_equals', label: 'Not Equals ()' },
                { value: 'contains', label: 'Contains' },
                { value: 'not_contains', label: 'Not Contains' },
                { value: 'starts_with', label: 'Starts With' },
                { value: 'ends_with', label: 'Ends With' }
            ],
            number: [
                { value: '=', label: 'Equals (=)' },
                { value: '>', label: 'Greater Than (>)' },
                { value: '<', label: 'Less Than (<)' },
                { value: '>=', label: 'Greater or Equal ()' },
                { value: '<=', label: 'Less or Equal ()' },
                { value: 'between', label: 'Between' }
            ],
            date: [
                { value: '=', label: 'Equals (=)' },
                { value: '>', label: 'After (>)' },
                { value: '<', label: 'Before (<)' },
                { value: '>=', label: 'On or After ()' },
                { value: '<=', label: 'On or Before ()' },
                { value: 'between', label: 'Between' }
            ]
        };


        // ========================================
        // CREATIVE CONFIG (Step 2)
        // ========================================
        
        function toggleCreativeConfig() {
            const enabled = document.getElementById('enableCreative').checked;
            const form = document.getElementById('creativeConfigForm');
            
            creativeConfig.enabled = enabled;
            
            if (enabled) {
                form.style.display = 'block';
                populateCreativeDropdowns();
                // Don't reset config here - it might be loaded from template
            } else {
                form.style.display = 'none';
                // FIX: Only reset if user manually unchecks (not when loading template)
                if (!isLoadingTemplate) {
                    creativeConfig = {
                        enabled: false,
                        adNameColumn: '',
                        fileNameColumn: '',
                        sameAsAdName: false,
                        adFormatColumn: '',
                        thumbnailUrlColumn: '',
                        staticUrlColumn: '',
                        videoUrlColumn: '',
                        useThumbnailForStatic: false,
                        useThumbnailForVideo: false,
                        thumbnailSize: 'medium'
                    };
                }
            }
            
            hasUnsavedChanges = true;
        }
        
        function populateCreativeDropdowns() {
            const dropdowns = [
                'creativeAdName',
                'creativeFileName',
                'creativeAdFormat',
                'creativeThumbnailUrl',
                'creativeStaticUrl',
                'creativeVideoUrl'
            ];
            
            dropdowns.forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '<option value="">-- Select Column --</option>';
                
                csvData.headers.forEach(header => {
                    const option = document.createElement('option');
                    option.value = header;
                    option.textContent = header;
                    select.appendChild(option);
                });
            });
        }
        
        function updateCreativeConfig() {
            creativeConfig.adNameColumn = document.getElementById('creativeAdName').value;
            creativeConfig.fileNameColumn = document.getElementById('creativeFileName').value;
            creativeConfig.adFormatColumn = document.getElementById('creativeAdFormat').value;
            creativeConfig.thumbnailUrlColumn = document.getElementById('creativeThumbnailUrl').value;
            creativeConfig.staticUrlColumn = document.getElementById('creativeStaticUrl').value;
            creativeConfig.videoUrlColumn = document.getElementById('creativeVideoUrl').value;
            creativeConfig.thumbnailSize = document.querySelector('input[name="thumbnailSize"]:checked').value;
            
            hasUnsavedChanges = true;
        }
        
        function toggleSameAsAdName() {
            const checked = document.getElementById('sameAsAdName').checked;
            const fileNameSelect = document.getElementById('creativeFileName');
            
            creativeConfig.sameAsAdName = checked;
            
            if (checked) {
                fileNameSelect.value = document.getElementById('creativeAdName').value;
                fileNameSelect.disabled = true;
            } else {
                fileNameSelect.disabled = false;
            }
            
            updateCreativeConfig();
        }
        
        function toggleUseThumbnail() {
            const useForStatic = document.getElementById('useThumbForStatic').checked;
            const useForVideo = document.getElementById('useThumbForVideo').checked;
            
            const staticSelect = document.getElementById('creativeStaticUrl');
            const videoSelect = document.getElementById('creativeVideoUrl');
            const thumbnailUrl = document.getElementById('creativeThumbnailUrl').value;
            
            creativeConfig.useThumbnailForStatic = useForStatic;
            creativeConfig.useThumbnailForVideo = useForVideo;
            
            if (useForStatic) {
                staticSelect.value = thumbnailUrl;
                staticSelect.disabled = true;
            } else {
                staticSelect.disabled = false;
            }
            
            if (useForVideo) {
                videoSelect.value = thumbnailUrl;
                videoSelect.disabled = true;
            } else {
                videoSelect.disabled = false;
            }
            
            updateCreativeConfig();
        }
        
        // ========================================
        // INITIALIZATION
        // ========================================
        
        function init() {
            setupDragDrop();
            setupEventListeners();
            enableSidebarStep('welcome');
            enableSidebarStep('upload'); // FIX: Enable upload step from start
        }
        
        function setupEventListeners() {
            const uploadZone = document.getElementById('uploadZone');
            uploadZone.addEventListener('dragover', handleDragOver);
            uploadZone.addEventListener('dragleave', handleDragLeave);
            uploadZone.addEventListener('drop', handleFileDrop);
            
            document.getElementById('dateName').addEventListener('input', () => hasUnsavedChanges = true);
            document.getElementById('dateColumn').addEventListener('change', () => hasUnsavedChanges = true);
            document.getElementById('dateFormat').addEventListener('change', () => hasUnsavedChanges = true);
            
            document.getElementById('tabName').addEventListener('input', () => hasUnsavedChanges = true);
            document.getElementById('groupBy').addEventListener('change', () => hasUnsavedChanges = true);
            document.getElementById('hideDuplicates').addEventListener('change', () => hasUnsavedChanges = true);
            document.getElementById('showTotal').addEventListener('change', () => hasUnsavedChanges = true);
            
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Delete' && selectedFormulaToken) {
                    showModal('', 'Delete Token', 
                        'Remove this token from formula?',
                        function() {
                            selectedFormulaToken.remove();
                            selectedFormulaToken = null;
                            updateFormulaPreview();
                        }
                    );
                }
            });
            
            flatpickr('#dateRangeStart', {
                dateFormat: 'Y-m-d',
                allowInput: true,
                onChange: function(selectedDates, dateStr, instance) {
                    // FIX: Ensure format is YYYY-MM-DD
                    if (dateStr) {
                        instance.input.value = normalizeDateString(dateStr);
                    }
                }
            });
            
            flatpickr('#dateRangeEnd', {
                dateFormat: 'Y-m-d',
                allowInput: true,
                onChange: function(selectedDates, dateStr, instance) {
                    // FIX: Ensure format is YYYY-MM-DD
                    if (dateStr) {
                        instance.input.value = normalizeDateString(dateStr);
                    }
                }
            });

            // FIX: Add color picker preview updates
            document.addEventListener('change', function(e) {
                if (e.target.id === 'settingPrimaryColor') {
                    const preview = document.getElementById('primaryColorPreview');
                    if (preview) preview.textContent = e.target.value;
                } else if (e.target.id === 'settingHeaderBg') {
                    const preview = document.getElementById('headerBgPreview');
                    if (preview) preview.textContent = e.target.value;
                } else if (e.target.id === 'settingTotalRowColor') {
                    const preview = document.getElementById('totalRowColorPreview');
                    if (preview) preview.textContent = e.target.value;
                }
            });
        }
        
        function setupDragDrop() {
            const dimensionsSection = document.getElementById('dimensionsSection');
            const metricsSection = document.getElementById('metricsSection');
            
            dimensionsSection.addEventListener('dragover', handleDragOver);
            dimensionsSection.addEventListener('drop', (e) => handleDrop(e, 'dimension'));
            
            metricsSection.addEventListener('dragover', handleDragOver);
            metricsSection.addEventListener('drop', (e) => handleDrop(e, 'metric'));
        }
        
        // ========================================
        // NAVIGATION
        // ========================================
        
        function navigateToStep(step) {
            const sidebarItem = document.querySelector(`.sidebar-item[data-step="${step}"]`);
            if (sidebarItem && sidebarItem.classList.contains('disabled')) {
                showModal('', 'Step Locked', 'Please complete previous steps first.');
                return;
            }
            
            if (hasUnsavedChanges && (currentStep === 'mapping' || currentStep === 'tabs')) {
                showModal('', 'Unsaved Changes', 
                    'You have unsaved changes. Continue anyway?',
                    function() {
                        hasUnsavedChanges = false;
                        switchToStep(step);
                    }
                );
                return;
            }
            
            switchToStep(step);
            // FIX: Load creative config if going to mapping
            if (step === 'mapping' && creativeConfig.enabled) {
                setTimeout(() => {
                    loadCreativeConfigUI();
                }, 300);
            }
        }
        
        function switchToStep(step) {
            console.log('=== switchToStep START ===', step);
            
            // Hide all footers first
            const mappingFooter = document.getElementById('mappingFooter');
            const tabsFooter = document.getElementById('tabsFooter');
            if (mappingFooter) mappingFooter.style.display = 'none';
            if (tabsFooter) tabsFooter.style.display = 'none';
            
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
                console.log('Removed active from:', screen.id);
            });
            
            let screenId = step + 'Screen';
            if (step === 'tabs') {
                screenId = 'tabsScreen';
            }
            const targetScreen = document.getElementById(screenId);
            console.log('Target screen:', targetScreen);
            
            if (targetScreen) {
                targetScreen.classList.add('active');
                console.log('Added active to:', targetScreen.id);
            } else {
                console.error(' Target screen not found:', screenId);
            }
            
            document.querySelectorAll('.sidebar-item').forEach(item => {
                item.classList.remove('active');
            });
            const sidebarItem = document.querySelector(`.sidebar-item[data-step="${step}"]`);
            if (sidebarItem) {
                sidebarItem.classList.add('active');
            }
            
            currentStep = step;
            console.log('Current step now:', currentStep);
            
            if (step === 'mapping') {
                populateColumnList();
                
                // FIX: If template loaded, render existing data
                if (dimensions.length > 0 || metrics.length > 0) {
                    renderDateConfig();
                    renderDimensionsTable();
                    renderMetricsTable();
                    populateMetricDropdowns();
                } else {
                    populateDateColumnDropdown();
                    autoDetectDateColumn();
                }
                
                updateUsedColumns();
                // Show mapping footer
                if (mappingFooter) mappingFooter.style.display = 'flex';
            } else if (step === 'tabs') {
                console.log(' Calling renderTabsList()');
                renderTabsList();
                console.log(' Calling checkEmptyState()');
                checkEmptyState();
                // Show tabs footer
                if (tabsFooter) tabsFooter.style.display = 'flex';
            } else if (step === 'summary') {
                updateSummaryStats();
            } else if (step === 'dashboard') {
                renderDashboard();
            }
            
            console.log('=== switchToStep END ===');
        }

       function loadCreativeConfigToForm() {
            populateCreativeDropdowns();
            
            // FIX: Wait for dropdowns to populate
            setTimeout(() => {
                document.getElementById('creativeAdName').value = creativeConfig.adNameColumn;
                document.getElementById('creativeFileName').value = creativeConfig.fileNameColumn;
                document.getElementById('creativeAdFormat').value = creativeConfig.adFormatColumn;
                document.getElementById('creativeThumbnailUrl').value = creativeConfig.thumbnailUrlColumn;
                document.getElementById('creativeStaticUrl').value = creativeConfig.staticUrlColumn;
                document.getElementById('creativeVideoUrl').value = creativeConfig.videoUrlColumn;
                
                document.getElementById('sameAsAdName').checked = creativeConfig.sameAsAdName;
                document.getElementById('useThumbForStatic').checked = creativeConfig.useThumbnailForStatic;
                document.getElementById('useThumbForVideo').checked = creativeConfig.useThumbnailForVideo;
                
                const sizeRadio = document.querySelector(`input[name="thumbnailSize"][value="${creativeConfig.thumbnailSize}"]`);
                if (sizeRadio) sizeRadio.checked = true;
                
                toggleSameAsAdName();
                toggleUseThumbnail();
            }, 100);
        }

        function loadCreativeConfigUI() {
            console.log('=== loadCreativeConfigUI ===');
            console.log('creativeConfig:', creativeConfig);
            
            if (creativeConfig.enabled) {
                // Tick checkbox
                const checkbox = document.getElementById('enableCreative');
                if (checkbox) {
                    checkbox.checked = true;
                    console.log('Checkbox ticked');
                }
                
                // Show form
                const form = document.getElementById('creativeConfigForm');
                if (form) {
                    form.style.display = 'block';
                    console.log('Form shown');
                }
                
                // Populate dropdowns
                populateCreativeDropdowns();
                
                // Load values
                setTimeout(() => {
                    console.log('Loading values to form...');
                    
                    document.getElementById('creativeAdName').value = creativeConfig.adNameColumn || '';
                    document.getElementById('creativeFileName').value = creativeConfig.fileNameColumn || '';
                    document.getElementById('creativeAdFormat').value = creativeConfig.adFormatColumn || '';
                    document.getElementById('creativeThumbnailUrl').value = creativeConfig.thumbnailUrlColumn || '';
                    document.getElementById('creativeStaticUrl').value = creativeConfig.staticUrlColumn || '';
                    document.getElementById('creativeVideoUrl').value = creativeConfig.videoUrlColumn || '';
                    
                    document.getElementById('sameAsAdName').checked = creativeConfig.sameAsAdName || false;
                    document.getElementById('useThumbForStatic').checked = creativeConfig.useThumbnailForStatic || false;
                    document.getElementById('useThumbForVideo').checked = creativeConfig.useThumbnailForVideo || false;
                    
                    const sizeRadio = document.querySelector(`input[name="thumbnailSize"][value="${creativeConfig.thumbnailSize}"]`);
                    if (sizeRadio) {
                        sizeRadio.checked = true;
                        console.log('Size radio checked:', creativeConfig.thumbnailSize);
                    }
                    
                    // Apply checkbox states
                    toggleSameAsAdName();
                    toggleUseThumbnail();
                    
                    console.log('Creative config loaded to UI!');
                }, 100);
            }
        }
        
        function enableSidebarStep(step) {
            const sidebarItem = document.querySelector(`.sidebar-item[data-step="${step}"]`);
            if (sidebarItem) {
                sidebarItem.classList.remove('disabled');
            }
        }
        
        // ========================================
        // WELCOME SCREEN
        // ========================================
        
        function startNewDashboard() {
            navigateToStep('upload');
        }
        
        function loadFromTemplate() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                showLoading('Loading template...');
                
                const reader = new FileReader();
                reader.onload = function(event) {
                    try {
                        const template = JSON.parse(event.target.result);
                        validateAndLoadTemplate(template);
                    } catch (err) {
                        hideLoading();
                        showModal('', 'Invalid Template', 'Failed to parse JSON file: ' + err.message);
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }
        
        function validateAndLoadTemplate(template) {
            if (!template.version || !template.metadata || !template.dateConfig || 
                !template.dimensions || !template.metrics || !template.tabs) {
                hideLoading();
                showModal('', 'Invalid Template', 'Template is missing required fields.');
                return;
            }
            
            hideLoading();
            
            const modalBody = `
                <div style="margin-bottom: 20px;">
                    <strong>Template Information:</strong><br>
                    Client: ${template.metadata.clientName}<br>
                    Service: ${template.metadata.service}<br>
                    Report Type: ${template.metadata.reportType}<br>
                    <br>
                    Tabs: ${template.tabs.length}<br>
                    Dimensions: ${template.dimensions.length}<br>
                    Metrics: ${template.metrics.length}
                </div>
                <div class="alert alert-info">
                    <span></span>
                    <span>Please upload CSV file to continue</span>
                </div>
            `;
            
            showModal('', 'Load Template', modalBody, function() {
                const csvInput = document.createElement('input');
                csvInput.type = 'file';
                csvInput.accept = '.csv';
                csvInput.onchange = function(e) {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    showLoading('Processing CSV...');
                    handleCSVUpload(e, template);
                };
                csvInput.click();
            }, null, 'Upload CSV', 'Cancel');
        }
        
        function applyTemplate(template) {
            // FIX: Set flag to prevent reset
            isLoadingTemplate = true;
            templateMetadata = template.metadata;
            dateConfig = template.dateConfig;

            // FIX: Load creative config
            if (template.creativeConfig) {
                creativeConfig = template.creativeConfig;
                console.log(' Creative config loaded from template:', creativeConfig);
            } else {
                creativeConfig = {
                    enabled: false,
                    adNameColumn: '',
                    fileNameColumn: '',
                    sameAsAdName: false,
                    adFormatColumn: '',
                    thumbnailUrlColumn: '',
                    staticUrlColumn: '',
                    videoUrlColumn: '',
                    useThumbnailForStatic: false,
                    useThumbnailForVideo: false,
                    thumbnailSize: 'medium'
                };
            }
            dimensions = template.dimensions;
            metrics = template.metrics;
            tabs = template.tabs;
            
            dimensionIdCounter = Math.max(...dimensions.map(d => parseInt(d.id.replace('dim_', ''))), 0) + 1;
            metricIdCounter = Math.max(...metrics.map(m => parseInt(m.id.replace('metric_', ''))), 0) + 1;
            tabIdCounter = Math.max(...tabs.map(t => parseInt(t.id.replace('tab_', ''))), 0) + 1;

            // FIX: Update chartIdCounter
            let maxChartId = 0;
            tabs.forEach(tab => {
                if (tab.charts && tab.charts.length > 0) {
                    tab.charts.forEach(chart => {
                        const id = parseInt(chart.id.replace('chart_', ''));
                        if (id > maxChartId) maxChartId = id;
                    });
                }
            });
            chartIdCounter = maxChartId + 1;

            // FIX: Load settings from template
            if (template.settings) {
                dashboardSettings = template.settings;
            } else {
                dashboardSettings = getDefaultSettings();
            }
            
            // FIX: Update filterIdCounter
            let maxFilterId = 0;
            tabs.forEach(tab => {
                if (tab.filters && tab.filters.length > 0) {
                    tab.filters.forEach(filter => {
                        const id = parseInt(filter.id.replace('filter_', ''));
                        if (id > maxFilterId) maxFilterId = id;
                    });
                }
            });
            filterIdCounter = maxFilterId + 1;
            
            const templateColumns = [
                dateConfig.sourceColumn,
                ...dimensions.map(d => d.sourceColumn),
                ...metrics.filter(m => m.type === 'base').map(m => m.sourceColumn)
            ];
            
            const missingColumns = templateColumns.filter(col => !csvData.headers.includes(col));
            
            // FIX: Load metadata into summary form when navigating to summary
            // This will be called when user goes to step 4
            
            if (missingColumns.length > 0) {
                showModal('', 'Column Mismatch', 
                    `The following columns are missing in CSV:\n${missingColumns.join(', ')}\n\nWhat would you like to do?`,
                    function() {
                        enableSidebarStep('mapping');
                        enableSidebarStep('tabs');
                        enableSidebarStep('summary');
                        enableSidebarStep('dashboard');
                        navigateToStep('mapping');
                        
                        // FIX: Load creative config after navigation
                        setTimeout(() => {
                            loadCreativeConfigUI();
                        }, 200);
                    },
                    function() {
                        showModal('', 'Template Loaded', 
                            'Template loaded. Missing columns will be skipped.',
                            function() {
                                showModal('', 'Next Step', 
                                    'Do you want to review settings or go directly to dashboard?',
                                    function() {
                        enableSidebarStep('mapping');
                        enableSidebarStep('tabs');
                        enableSidebarStep('summary');
                        enableSidebarStep('dashboard');
                        navigateToStep('mapping');
                        
                        // FIX: Load creative config after navigation
                        setTimeout(() => {
                            loadCreativeConfigUI();
                        }, 200);
                    },
                                    function() {
                        enableSidebarStep('mapping');
                        enableSidebarStep('tabs');
                        enableSidebarStep('summary');
                        enableSidebarStep('dashboard');
                        navigateToStep('mapping');
                        
                        // FIX: Load creative config after navigation
                        setTimeout(() => {
                            loadCreativeConfigUI();
                        }, 200);
                    },
                                    'Go to Dashboard',
                                    'Review Settings'
                                );
                            }
                        );
                    },
                    'Remap Manually',
                    'Continue Anyway'
                );
            } else {
                showModal('', 'Template Loaded', 
                    'Template loaded successfully! What would you like to do?',
                    function() {
                        enableSidebarStep('mapping');
                        enableSidebarStep('tabs');
                        enableSidebarStep('summary');
                        enableSidebarStep('dashboard');
                        navigateToStep('dashboard');
setTimeout(() => {
                            loadCreativeConfigUI();
                        }, 200);
                    },
                    function() {
                        enableSidebarStep('mapping');
                        enableSidebarStep('tabs');
                        enableSidebarStep('summary');
                        enableSidebarStep('dashboard');
                        navigateToStep('mapping');
setTimeout(() => {
                            loadCreativeConfigUI();
                        }, 200);
                    },
                    'Go to Dashboard',
                    'Review Settings'
                );
            }
            // FIX: Reset flag after loading
            setTimeout(() => {
                isLoadingTemplate = false;
            }, 1000);
        }
        
        // ========================================
        // UPLOAD SCREEN (Step 1)
        // ========================================
        
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            if (e.currentTarget.id === 'uploadZone') {
                e.currentTarget.classList.add('dragover');
            }
        }
        
        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            if (e.currentTarget.id === 'uploadZone') {
                e.currentTarget.classList.remove('dragover');
            }
        }
        
        function handleFileDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            
            const uploadZone = document.getElementById('uploadZone');
            uploadZone.classList.remove('dragover');
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                const file = files[0];
                if (file.name.endsWith('.csv')) {
                    processCSVFile(file);
                } else {
                    showModal('', 'Invalid File', 'Please upload a CSV file.');
                }
            }
        }
        
        function handleCSVUpload(event, template = null) {
            const file = event.target.files[0];
            if (!file) return;
            
            processCSVFile(file, template);
        }
        
        function processCSVFile(file, template = null) {
            showLoading('Processing CSV file...');
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                encoding: 'UTF-8',
                preview: 1000,
                complete: function(results) {
                    if (results.errors.length > 0) {
                        Papa.parse(file, {
                            header: true,
                            skipEmptyLines: true,
                            encoding: 'UTF-16',
                            preview: 1000,
                            complete: function(results2) {
                                if (results2.errors.length > 0) {
                                    hideLoading();
                                    showModal('', 'Parse Error', 'Failed to parse CSV file. Please check the format.');
                                } else {
                                    handleCSVParsed(results2, file, template);
                                }
                            }
                        });
                    } else {
                        handleCSVParsed(results, file, template);
                    }
                },
                error: function(err) {
                    hideLoading();
                    showModal('', 'Error', 'Failed to read CSV file: ' + err.message);
                }
            });
        }
        
        function handleCSVParsed(results, file, template) {
            hideLoading();
            
            if (!results.data || results.data.length === 0) {
                showModal('', 'Empty File', 'CSV file is empty or has no data rows.');
                return;
            }
            
            csvData.headers = results.meta.fields;
            csvData.rows = results.data;
            csvData.raw = file;
            
            // FIX: Show warning if file is large
            const fileSize = (file.size / (1024 * 1024)).toFixed(2);  // MB
            if (file.size > 100 * 1024 * 1024) {  // > 100MB
                showModal('', 'Large File Detected', 
                    `File size: ${fileSize} MB\n\n` +
                    `Only first 1,000 rows are loaded for preview and configuration.\n\n` +
                    `Full data will be processed when generating dashboard.`,
                    function() {
                        showCSVPreview();
                    }
                );
            } else {
                showCSVPreview();
            }
            
            document.getElementById('uploadNextBtn').disabled = false;
            enableSidebarStep('mapping');
            
            if (template) {
                applyTemplate(template);
            }
        }
        
        function showCSVPreview() {
            const previewSection = document.getElementById('previewSection');
            const previewTableHead = document.getElementById('previewTableHead');
            const previewTableBody = document.getElementById('previewTableBody');
            
            previewSection.classList.add('active');
            
            // FIX: Show preview count
            const totalRows = csvData.rows.length;
            const isPreview = totalRows >= 1000;
            
            document.getElementById('rowCount').textContent = 
                isPreview 
                    ? `${totalRows.toLocaleString()} (preview - full file may have more)` 
                    : totalRows.toLocaleString();
            
            document.getElementById('colCount').textContent = csvData.headers.length;
            
            let headerHTML = '<tr>';
            csvData.headers.forEach(header => {
                headerHTML += `<th>${header}</th>`;
            });
            headerHTML += '</tr>';
            previewTableHead.innerHTML = headerHTML;
            
            let bodyHTML = '';
            const previewRows = csvData.rows.slice(0, 10);
            previewRows.forEach(row => {
                bodyHTML += '<tr>';
                csvData.headers.forEach(header => {
                    bodyHTML += `<td>${row[header] || ''}</td>`;
                });
                bodyHTML += '</tr>';
            });
            previewTableBody.innerHTML = bodyHTML;
        }
        
        // ========================================
        // MAPPING SCREEN (Step 2) - Date Config
        // ========================================
        
        function populateDateColumnDropdown() {
            const select = document.getElementById('dateColumn');
            select.innerHTML = '<option value="">-- Select Column --</option>';
            
            csvData.headers.forEach(header => {
                const option = document.createElement('option');
                option.value = header;
                option.textContent = header;
                select.appendChild(option);
            });
        }
        
        function autoDetectDateColumn() {
            const dateKeywords = ['date', 'day', 'time', 'datetime', 'timestamp'];
            
            for (let header of csvData.headers) {
                const lowerHeader = header.toLowerCase();
                if (dateKeywords.some(keyword => lowerHeader.includes(keyword))) {
                    document.getElementById('dateColumn').value = header;
                    dateConfig.sourceColumn = header;
                    break;
                }
            }
        }
        
        function updateDateColumn() {
            dateConfig.sourceColumn = document.getElementById('dateColumn').value;
            hasUnsavedChanges = true;
            updateUsedColumns();
        }

        function renderDateConfig() {
            // Populate date column dropdown
            populateDateColumnDropdown();
            
            // Set values from dateConfig
            document.getElementById('dateName').value = dateConfig.displayName;
            document.getElementById('dateColumn').value = dateConfig.sourceColumn;
            document.getElementById('dateFormat').value = dateConfig.format;
        }
        
        // ========================================
        // MAPPING SCREEN (Step 2) - Columns Panel
        // ========================================
        
        function toggleColumnsPanel() {
            const panel = document.getElementById('columnsPanel');
            const editPanel = document.getElementById('editPanel');
            const mappingPanel = document.getElementById('mappingPanel');
            const mappingFooter = document.getElementById('mappingFooter');
            
            panel.classList.toggle('open');
            
            if (panel.classList.contains('open')) {
                editPanel.classList.remove('open');
                mappingPanel.classList.add('columns-open');
                mappingPanel.classList.remove('edit-open');
                
                // FIX: Adjust footer
                if (mappingFooter) {
                    mappingFooter.style.marginRight = '300px';
                }
            } else {
                mappingPanel.classList.remove('columns-open');
                
                // FIX: Reset footer
                if (mappingFooter) {
                    mappingFooter.style.marginRight = '0';
                }
            }
        }
        
        function populateColumnList() {
            const list = document.getElementById('columnList');
            list.innerHTML = '';
            
            csvData.headers.forEach(col => {
                const item = document.createElement('div');
                item.className = 'column-item';
                item.draggable = true;
                item.dataset.column = col;
                item.innerHTML = `
                    <span class="icon"></span>
                    <span class="name">${col}</span>
                `;
                
                item.addEventListener('dragstart', handleColumnDragStart);
                item.addEventListener('dragend', handleColumnDragEnd);
                
                list.appendChild(item);
            });
            
            updateUsedColumns();
        }
        
        function filterColumns() {
            const search = document.getElementById('columnSearch').value.toLowerCase();
            const items = document.querySelectorAll('.column-item');
            
            items.forEach(item => {
                const name = item.querySelector('.name').textContent.toLowerCase();
                if (name.includes(search)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }
        
        function getUsedColumns() {
            const used = [];
            
            if (dateConfig.sourceColumn) {
                used.push(dateConfig.sourceColumn);
            }
            
            dimensions.forEach(dim => {
                if (dim.sourceColumn) used.push(dim.sourceColumn);
            });
            
            metrics.forEach(metric => {
                if (metric.type === 'base' && metric.sourceColumn) {
                    used.push(metric.sourceColumn);
                }
            });
            
            return used;
        }
        
        function updateUsedColumns() {
            const used = getUsedColumns();
            const items = document.querySelectorAll('.column-item');
            
            items.forEach(item => {
                const col = item.dataset.column;
                if (used.includes(col)) {
                    item.classList.add('used');
                } else {
                    item.classList.remove('used');
                }
            });
        }
        
        function handleColumnDragStart(e) {
            if (this.classList.contains('used')) {
                e.preventDefault();
                return;
            }
            
            draggedColumn = this.dataset.column;
            this.classList.add('dragging');
            
            document.getElementById('dimensionsSection').classList.add('drag-over');
            document.getElementById('metricsSection').classList.add('drag-over');
        }
        
        function handleColumnDragEnd(e) {
            this.classList.remove('dragging');
            
            // FIX: Always remove overlay (d th  u)
            const dimSection = document.getElementById('dimensionsSection');
            const metSection = document.getElementById('metricsSection');
            
            if (dimSection) dimSection.classList.remove('drag-over');
            if (metSection) metSection.classList.remove('drag-over');
            
            // Reset
            draggedColumn = null;
        }
        
        function handleDrop(e, type) {
            e.preventDefault();
            
            document.getElementById('dimensionsSection').classList.remove('drag-over');
            document.getElementById('metricsSection').classList.remove('drag-over');
            
            if (!draggedColumn) return;
            
            if (type === 'dimension') {
                createDimensionFromColumn(draggedColumn);
            } else {
                createMetricFromColumn(draggedColumn);
            }
            
            draggedColumn = null;
        }
        
        // ========================================
        // MAPPING SCREEN (Step 2) - Dimensions
        // ========================================
        
        function createDimensionFromColumn(columnName) {
            const displayName = formatDisplayName(columnName);
            const newDim = {
                id: `dim_${dimensionIdCounter++}`,
                displayName: displayName,
                sourceColumn: columnName
            };
            
            dimensions.push(newDim);
            renderDimensionsTable();
            updateUsedColumns();
            hasUnsavedChanges = true;
        }
        
        function addDimension() {
            createDimensionFromColumn('new_column');
        }
        
        function renderDimensionsTable() {
            const tbody = document.getElementById('dimensionsBody');
            tbody.innerHTML = '';
            
            dimensions.forEach((dim, index) => {
                const row = tbody.insertRow();
                row.dataset.dimId = dim.id;
                row.innerHTML = `
                    <td><span class="drag-handle"></span></td>
                    <td>${index + 1}</td>
                    <td><input type="text" value="${dim.displayName}" onchange="updateDimensionName('${dim.id}', this.value)"></td>
                    <td>
                        <select onchange="updateDimensionColumn('${dim.id}', this.value)">
                            <option value="">-- Select Column --</option>
                            ${csvData.headers.map(col => 
                                `<option value="${col}" ${col === dim.sourceColumn ? 'selected' : ''}>${col}</option>`
                            ).join('')}
                        </select>
                    </td>
                    <td><button class="delete-btn" onclick="deleteDimension('${dim.id}')"></button></td>
                `;
            });
            
            initDimensionsSortable();
        }
        
        function initDimensionsSortable() {
            const tbody = document.getElementById('dimensionsBody');
            new Sortable(tbody, {
                handle: '.drag-handle',
                animation: 150,
                onEnd: function(evt) {
                    const movedDim = dimensions.splice(evt.oldIndex, 1)[0];
                    dimensions.splice(evt.newIndex, 0, movedDim);
                    renderDimensionsTable();
                }
            });
        }
        
        function updateDimensionName(id, name) {
            const dim = dimensions.find(d => d.id === id);
            if (dim) {
                dim.displayName = name;
                hasUnsavedChanges = true;
            }
        }
        
        function updateDimensionColumn(id, column) {
            const dim = dimensions.find(d => d.id === id);
            if (dim) {
                dim.sourceColumn = column;
                updateUsedColumns();
                hasUnsavedChanges = true;
            }
        }
        
        function deleteDimension(id) {
            showModal('', 'Delete Dimension', 
                'Are you sure you want to delete this dimension?',
                function() {
                    dimensions = dimensions.filter(d => d.id !== id);
                    renderDimensionsTable();
                    updateUsedColumns();
                    hasUnsavedChanges = true;
                }
            );
        }
        
        // ========================================
        // MAPPING SCREEN (Step 2) - Metrics
        // ========================================
        
        function createMetricFromColumn(columnName) {
            const displayName = formatDisplayName(columnName);
            const newMetric = {
                id: `metric_${metricIdCounter++}`,
                displayName: displayName,
                type: 'base',
                sourceColumn: columnName,
                formula: [],
                format: {
                    type: 'number',
                    decimals: 0,
                    currency: '',
                    thousandSeparator: true, // FIX: Add thousand separator option
                    dataBar: {
                        enabled: false,
                        style: 'solid',
                        color: '#27ae60'
                    }
                }
            };
            
            metrics.push(newMetric);
            renderMetricsTable();
            updateUsedColumns();
            populateMetricDropdowns();
            hasUnsavedChanges = true;
            
            // FIX: Don't auto-open edit panel
            // openEditPanel(newMetric.id);
        }
        
        function addMetric() {
            createMetricFromColumn('new_metric');
        }
        
        function renderMetricsTable() {
            const tbody = document.getElementById('metricsBody');
            tbody.innerHTML = '';
            
            metrics.forEach((metric, index) => {
                const row = tbody.insertRow();
                row.dataset.metricId = metric.id;
                row.innerHTML = `
                    <td><span class="drag-handle"></span></td>
                    <td>${index + 1}</td>
                    <td><span class="metric-name">${metric.displayName}</span></td>
                    <td><span class="metric-info">${metric.type === 'base' ? metric.sourceColumn : 'Formula'}</span></td>
                    <td><span class="calc-status ${metric.type === 'calculated' ? 'on' : 'off'}">${metric.type === 'calculated' ? 'Calc' : 'Base'}</span></td>
                    <td><span class="metric-info">${getMetricInfoText(metric)}</span></td>
                    <td><span class="edit-icon" onclick="openEditPanel('${metric.id}')"></span></td>
                `;
            });
            
            initMetricsSortable();
        }
        
        function initMetricsSortable() {
            const tbody = document.getElementById('metricsBody');
            new Sortable(tbody, {
                handle: '.drag-handle',
                animation: 150,
                onEnd: function(evt) {
                    const movedMetric = metrics.splice(evt.oldIndex, 1)[0];
                    metrics.splice(evt.newIndex, 0, movedMetric);
                    renderMetricsTable();
                }
            });
        }
        
        function getMetricInfoText(metric) {
            let info = [];
            
            if (metric.format.type === 'currency') {
                info.push(`${metric.format.currency}, ${metric.format.decimals} dec`);
            } else if (metric.format.type === 'percentage') {
                info.push(`%, ${metric.format.decimals} dec`);
            } else {
                info.push(`Number, ${metric.format.decimals} dec`);
            }
            
            // FIX: Show thousand separator info
            if (metric.format.thousandSeparator) {
                info.push('1,234');
            } else {
                info.push('1234');
            }
            
            if (metric.format.dataBar.enabled) {
                info.push(`Bar`);
            }
            
            return info.join(' | ');
        }
        
        function formatDisplayName(columnName) {
            return columnName
                .split('_')
                .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                .join(' ');
        }
        
        // ========================================
        // EDIT PANEL - Metrics
        // ========================================
        
        function openEditPanel(metricId) {
            currentEditingMetricId = metricId;
            const metric = metrics.find(m => m.id === metricId);
            
            if (!metric) {
                showModal('', 'Error', 'Metric not found!');
                return;
            }
            
            const panel = document.getElementById('editPanel');
            const columnsPanel = document.getElementById('columnsPanel');
            const mappingPanel = document.getElementById('mappingPanel');
            
            columnsPanel.classList.remove('open');
            mappingPanel.classList.remove('columns-open');
            
            panel.classList.add('open');
            mappingPanel.classList.add('edit-open');

            // FIX: Adjust footer
            const mappingFooter = document.getElementById('mappingFooter');
            if (mappingFooter) {
                mappingFooter.style.marginRight = '400px';
            }
            
            document.getElementById('editMetricName').textContent = metric.displayName;
            document.getElementById('metricDisplayName').value = metric.displayName;
            
            if (metric.type === 'base') {
                document.querySelector('input[name="metricType"][value="base"]').checked = true;
                populateSourceColumnDropdown();
                document.getElementById('sourceColumn').value = metric.sourceColumn;
            } else {
                document.querySelector('input[name="metricType"][value="calculated"]').checked = true;
                loadFormulaTokens(metric.formula);
            }
            
            toggleMetricType();
            
            document.querySelector(`input[name="formatType"][value="${metric.format.type}"]`).checked = true;
            document.getElementById('decimalPlaces').value = metric.format.decimals;
            document.getElementById('currencySymbol').value = metric.format.currency;
            
            // FIX: Load thousand separator checkbox
            document.getElementById('thousandSeparator').checked = metric.format.thousandSeparator !== false;
            
            document.getElementById('dataBarEnable').checked = metric.format.dataBar.enabled;
            document.getElementById('dataBarColor').value = metric.format.dataBar.color;
            
            if (metric.format.dataBar.style) {
                document.querySelector(`input[name="barStyle"][value="${metric.format.dataBar.style}"]`).checked = true;
            }
            
            toggleCurrencyField();
            toggleDataBarOptions();
            updateFormulaPreview();
            initFormulaDragDrop();
        }
        
        function closeEditPanel() {
            const panel = document.getElementById('editPanel');
            const mappingPanel = document.getElementById('mappingPanel');
            const mappingFooter = document.getElementById('mappingFooter');
            
            panel.classList.remove('open');
            mappingPanel.classList.remove('edit-open');
            
            // FIX: Reset footer
            if (mappingFooter) {
                mappingFooter.style.marginRight = '0';
            }
            
            currentEditingMetricId = null;
        }
        
        function toggleMetricType() {
            const type = document.querySelector('input[name="metricType"]:checked').value;
            const baseSection = document.getElementById('baseMetricSection');
            const calcSection = document.getElementById('calculatedMetricSection');
            
            if (type === 'base') {
                baseSection.style.display = 'block';
                calcSection.style.display = 'none';
            } else {
                baseSection.style.display = 'none';
                calcSection.style.display = 'block';
            }
        }
        
        function toggleCurrencyField() {
            const formatType = document.querySelector('input[name="formatType"]:checked').value;
            const currencySection = document.getElementById('currencySection');
            
            if (formatType === 'currency') {
                currencySection.style.display = 'block';
            } else {
                currencySection.style.display = 'none';
            }
            
            updateFormulaPreview();
        }
        
        function toggleDataBarOptions() {
            const enabled = document.getElementById('dataBarEnable').checked;
            const options = document.getElementById('dataBarOptions');
            
            if (enabled) {
                options.style.display = 'block';
            } else {
                options.style.display = 'none';
            }
        }
        
        function populateSourceColumnDropdown() {
            const select = document.getElementById('sourceColumn');
            select.innerHTML = '<option value="">-- Select Column --</option>';
            
            csvData.headers.forEach(col => {
                const option = document.createElement('option');
                option.value = col;
                option.textContent = col;
                select.appendChild(option);
            });
        }
        
        function populateMetricDropdowns() {
            const metricDropdown = document.getElementById('metricDropdown');
            metricDropdown.innerHTML = '<option value="">+ Metric </option>';
            
            metrics.forEach(metric => {
                const option = document.createElement('option');
                option.value = metric.displayName;
                option.textContent = metric.displayName;
                metricDropdown.appendChild(option);
            });
        }
        
        function saveMetric() {
            if (!currentEditingMetricId) return;
            
            const metric = metrics.find(m => m.id === currentEditingMetricId);
            const displayName = document.getElementById('metricDisplayName').value.trim();
            const type = document.querySelector('input[name="metricType"]:checked').value;
            
            if (!displayName) {
                showModal('', 'Validation Error', 'Please enter a display name!');
                return;
            }
            
            metric.displayName = displayName;
            metric.type = type;
            
            if (type === 'base') {
                const sourceColumn = document.getElementById('sourceColumn').value;
                if (!sourceColumn) {
                    showModal('', 'Validation Error', 'Please select a source column!');
                    return;
                }
                metric.sourceColumn = sourceColumn;
            } else {
                const tokens = document.getElementById('formulaDisplay').children;
                if (tokens.length === 0) {
                    showModal('', 'Validation Error', 'Please build a formula!');
                    return;
                }
                metric.formula = Array.from(tokens).map(token => ({
                    type: token.dataset.type || 'metric',
                    value: token.textContent
                }));
            }
            
            metric.format.type = document.querySelector('input[name="formatType"]:checked').value;
            metric.format.decimals = parseInt(document.getElementById('decimalPlaces').value);
            metric.format.currency = document.getElementById('currencySymbol').value;
            
            // FIX: Save thousand separator option
            metric.format.thousandSeparator = document.getElementById('thousandSeparator').checked;
            
            metric.format.dataBar.enabled = document.getElementById('dataBarEnable').checked;
            metric.format.dataBar.color = document.getElementById('dataBarColor').value;
            metric.format.dataBar.style = document.querySelector('input[name="barStyle"]:checked').value;
            
            renderMetricsTable();
            populateMetricDropdowns();
            updateUsedColumns();
            
            showModal('', 'Success', 'Metric saved successfully!', closeEditPanel);
        }
        
        function deleteCurrentMetric() {
            if (!currentEditingMetricId) return;
            
            showModal('', 'Delete Metric', 
                'Are you sure you want to delete this metric?',
                function() {
                    metrics = metrics.filter(m => m.id !== currentEditingMetricId);
                    renderMetricsTable();
                    populateMetricDropdowns();
                    updateUsedColumns();
                    closeEditPanel();
                }
            );
        }
        
        // ========================================
        // FORMULA BUILDER
        // ========================================
        
        function loadFormulaTokens(formula) {
            const display = document.getElementById('formulaDisplay');
            display.innerHTML = '';
            
            formula.forEach(token => {
                const span = document.createElement('span');
                span.className = `formula-token ${token.type === 'operator' ? 'operator' : token.type === 'number' ? 'number' : ''}`;
                span.dataset.type = token.type;
                span.textContent = token.value;
                span.onclick = function() { selectToken(this); };
                display.appendChild(span);
            });
        }
        
        function selectToken(token) {
            if (selectedFormulaToken) {
                selectedFormulaToken.classList.remove('selected');
            }
            token.classList.add('selected');
            selectedFormulaToken = token;
        }
        
        function initFormulaDragDrop() {
            new Sortable(document.getElementById('formulaDisplay'), {
                animation: 150,
                onEnd: updateFormulaPreview
            });
        }
        
        function addMetricToken() {
            const dropdown = document.getElementById('metricDropdown');
            const value = dropdown.value;
            
            if (value) {
                const display = document.getElementById('formulaDisplay');
                const token = document.createElement('span');
                token.className = 'formula-token';
                token.dataset.type = 'metric';
                token.textContent = `[${value}]`;
                token.onclick = function() { selectToken(this); };
                
                display.appendChild(token);
                dropdown.value = '';
                updateFormulaPreview();
                initFormulaDragDrop();
            }
        }
        
        function addOperatorToken() {
            const dropdown = document.getElementById('operatorDropdown');
            const value = dropdown.value;
            
            if (value) {
                const display = document.getElementById('formulaDisplay');
                const token = document.createElement('span');
                token.className = 'formula-token operator';
                token.dataset.type = 'operator';
                token.textContent = value === '*' ? '' : value;
                token.onclick = function() { selectToken(this); };
                
                display.appendChild(token);
                dropdown.value = '';
                updateFormulaPreview();
                initFormulaDragDrop();
            }
        }
        
        function showNumberInput() {
            document.getElementById('numberInputSection').style.display = 'block';
            document.getElementById('numberInput').focus();
        }
        
        function addNumberToken() {
            const input = document.getElementById('numberInput');
            const value = input.value.trim();
            
            if (value && !isNaN(value)) {
                const display = document.getElementById('formulaDisplay');
                const token = document.createElement('span');
                token.className = 'formula-token number';
                token.dataset.type = 'number';
                token.textContent = value;
                token.onclick = function() { selectToken(this); };
                
                display.appendChild(token);
                input.value = '';
                cancelNumberInput();
                updateFormulaPreview();
                initFormulaDragDrop();
            } else {
                showModal('', 'Invalid Input', 'Please enter a valid number!');
            }
        }
        
        function cancelNumberInput() {
            document.getElementById('numberInputSection').style.display = 'none';
            document.getElementById('numberInput').value = '';
        }
        
        function clearFormula() {
            showModal('', 'Clear Formula', 
                'Clear all formula tokens?',
                function() {
                    document.getElementById('formulaDisplay').innerHTML = '';
                    selectedFormulaToken = null;
                    updateFormulaPreview();
                }
            );
        }
        
        function updateFormulaPreview() {
            const tokens = document.getElementById('formulaDisplay').children;
            const previewEl = document.getElementById('formulaPreview');
            const statusEl = document.getElementById('formulaStatus');
            
            if (tokens.length === 0) {
                previewEl.textContent = '-';
                statusEl.innerHTML = '<span style="color: var(--text-gray);"> Formula is empty</span>';
                return;
            }
            
            let rawValue = 5.0;
            const formatType = document.querySelector('input[name="formatType"]:checked')?.value || 'number';
            const decimals = parseInt(document.getElementById('decimalPlaces').value);
            
            let formattedValue = rawValue.toFixed(decimals);
            
            // FIX: Apply thousand separator in preview
            const useThousandSep = document.getElementById('thousandSeparator').checked;
            if (useThousandSep) {
                const parts = formattedValue.split('.');
                parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                formattedValue = parts.join('.');
            }
            
            if (formatType === 'percentage') {
                formattedValue += '%';
            } else if (formatType === 'currency') {
                const symbol = document.getElementById('currencySymbol').value;
                formattedValue = symbol + formattedValue;
            }
            
            previewEl.textContent = formattedValue;
            statusEl.innerHTML = '<span style="color: var(--success);"> Formula is valid</span>';
        }
        
        // ========================================
        // PROCEED TO TABS
        // ========================================
        
        function proceedToTabs() {
            console.log('=== proceedToTabs START ===');
            console.log('dateConfig:', dateConfig);
            console.log('dimensions:', dimensions);
            console.log('metrics:', metrics);
            
            if (!dateConfig.sourceColumn) {
                console.log('ERROR: No date column');
                showModal('', 'Validation Error', 'Please select a date column!');
                return;
            }
            
            if (dimensions.length === 0) {
                console.log('ERROR: No dimensions');
                showModal('', 'Validation Error', 'Please add at least one dimension!');
                return;
            }
            
            if (metrics.length === 0) {
                console.log('ERROR: No metrics');
                showModal('', 'Validation Error', 'Please add at least one metric!');
                return;
            }
            
            const incompleteDims = dimensions.filter(d => !d.sourceColumn);
            if (incompleteDims.length > 0) {
                console.log('ERROR: Incomplete dimensions:', incompleteDims);
                showModal('', 'Validation Error', 'Some dimensions are missing source columns!');
                return;
            }
            
            const incompleteMetrics = metrics.filter(m => m.type === 'base' && !m.sourceColumn);
            if (incompleteMetrics.length > 0) {
                console.log('ERROR: Incomplete metrics:', incompleteMetrics);
                showModal('', 'Validation Error', 'Some metrics are missing source columns!');
                return;
            }
            
            console.log(' All validations passed');

            // FIX: Validate creative config if enabled
            if (creativeConfig.enabled) {
                if (!creativeConfig.adNameColumn || !creativeConfig.adFormatColumn) {
                    console.log('ERROR: Incomplete creative config');
                    showModal('', 'Validation Error', 'Creative Report is enabled but missing required columns (Ad Name, Ad Format)!');
                    return;
                }
                
                if (!creativeConfig.staticUrlColumn && !creativeConfig.videoUrlColumn && !creativeConfig.thumbnailUrlColumn) {
                    console.log('ERROR: No image URL columns');
                    showModal('', 'Validation Error', 'Creative Report requires at least one URL column (Thumbnail, Static, or Video)!');
                    return;
                }
            }
            
            console.log(' All validations passed');
            
            dateConfig.displayName = document.getElementById('dateName').value;
            dateConfig.format = document.getElementById('dateFormat').value;
            
            hasUnsavedChanges = false;
            enableSidebarStep('tabs');
            
            console.log('Calling navigateToStep("tabs")');
            navigateToStep('tabs');
            
            console.log('=== proceedToTabs END ===');
        }

        // ========================================
        // TAB CONFIGURATION (Step 3)
        // ========================================
        
        function checkEmptyState() {
            const emptyState = document.getElementById('emptyState');
            const tabConfig = document.getElementById('tabConfig');
            
            if (tabs.length === 0) {
                emptyState.style.display = 'flex';
                tabConfig.style.display = 'none';
            } else {
                emptyState.style.display = 'none';
            }
        }
        
        function addNewTab() {
            const newTab = {
                id: `tab_${tabIdCounter++}`,
                name: '',
                type: 'standard',
                dimensions: [],
                groupBy: null,
                options: {
                    hideDuplicates: false,
                    showTotal: true
                },
                filters: [],
                
                // Comparison fields (NEW!)
                dateMode: 'smart',
                smartTemplate: 'last_7_vs_prev_7',
                period1: { from: '', to: '', label: '' },
                period2: { from: '', to: '', label: '' },
                selectedMetrics: [],
                comparisonOptions: {
                    showAbsolute: true,
                    showPercentage: true,
                    colorCoding: true
                }
            };
            
            tabs.push(newTab);
            renderTabsList();
            editTab(newTab.id);
            hasUnsavedChanges = true;
        }
        
        function renderTabsList() {
            const list = document.getElementById('tabsList');
            list.innerHTML = '';
            
            tabs.forEach(tab => {
                const item = document.createElement('div');
                item.className = 'tab-item';
                item.dataset.tabId = tab.id;
                if (currentEditingTabId === tab.id) {
                    item.classList.add('active');
                }
                
                const unsavedIndicator = hasUnsavedChanges && currentEditingTabId === tab.id ? 
                    '<span class="unsaved-indicator"></span>' : '';
                
                item.innerHTML = `
                    <span class="drag-handle"></span>
                    <span class="tab-name" onclick="editTab('${tab.id}')" style="cursor: pointer; flex: 1;">${tab.name || 'Untitled Tab'}${unsavedIndicator}</span>
                    <div class="tab-actions">
                        <button onclick="event.stopPropagation(); duplicateTab('${tab.id}')" title="Duplicate"></button>
                        <button onclick="event.stopPropagation(); deleteTab('${tab.id}')" title="Delete" style="color: var(--error);"></button>
                    </div>
                `;
                
                // FIX: Click anywhere on tab to edit
                item.onclick = function(e) {
                    if (!e.target.closest('.tab-actions') && !e.target.closest('.drag-handle')) {
                        editTab(tab.id);
                    }
                };
                
                list.appendChild(item);
            });
            
            initTabsSortable();
            checkEmptyState();
        }
        
        function initTabsSortable() {
            new Sortable(document.getElementById('tabsList'), {
                handle: '.drag-handle',
                animation: 150,
                onEnd: function(evt) {
                    const movedTab = tabs.splice(evt.oldIndex, 1)[0];
                    tabs.splice(evt.newIndex, 0, movedTab);
                }
            });
        }
        
        function editTab(tabId) {
            if (hasUnsavedChanges && currentEditingTabId && currentEditingTabId !== tabId) {
                showModal('', 'Unsaved Changes', 
                    'You have unsaved changes. Do you want to save before switching tabs?',
                    function() {
                        saveTab();
                        loadTabConfig(tabId);
                    },
                    function() {
                        hasUnsavedChanges = false;
                        loadTabConfig(tabId);
                    },
                    'Save',
                    'Discard'
                );
                return;
            }
            
            loadTabConfig(tabId);
        }
        
        function loadTabConfig(tabId) {
            currentEditingTabId = tabId;
            const tab = tabs.find(t => t.id === tabId);
            
            if (!tab) return;
            
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('tabConfig').style.display = 'block';
            
            document.getElementById('tabName').value = tab.name;
            document.getElementById('hideDuplicates').checked = tab.options.hideDuplicates;
            document.getElementById('showTotal').checked = tab.options.showTotal;

            // FIX: Load tab type
            const tabType = tab.type || 'standard';
            const tabTypeRadio = document.querySelector(`input[name="tabType"][value="${tabType}"]`);
            if (tabTypeRadio) {
                tabTypeRadio.checked = true;
            }
            toggleTabType();
            
            renderDimensionSelection(tab);
            updateGroupByDropdown(tab);
            renderFilters(tab);
            
            renderTabsList();
            hasUnsavedChanges = false;
        }

        function toggleTabType() {
            const tabType = document.querySelector('input[name="tabType"]:checked').value;
            const creativeRadio = document.getElementById('creativeTabTypeRadio');
            const warning = document.getElementById('creativeTabWarning');
            
            if (!creativeConfig.enabled) {
                if (tabType === 'creative') {
                    warning.style.display = 'block';
                    creativeRadio.disabled = true;
                    document.querySelector('input[name="tabType"][value="standard"]').checked = true;
                    
                    showModal('', 'Creative Not Configured', 
                        'Please enable and configure Creative Columns in Step 2 first!',
                        function() {
                            navigateToStep('mapping');
                        }
                    );
                    return;
                } else {
                    warning.style.display = 'none';
                }
            } else {
                warning.style.display = 'none';
                creativeRadio.disabled = false;
            }
            
            const tab = tabs.find(t => t.id === currentEditingTabId);
            if (tab) {
                tab.type = tabType;
                
                if (tabType === 'creative') {
                    if (!tab.dimensions.includes('creative_image')) {
                        tab.dimensions.push('creative_image');
                    }
                } else if (tabType === 'comparison') {
                    // Show comparison config, hide dimensions/group by/filters
                    const compConfig = document.getElementById('comparisonConfig');
                    const tabdimSection = document.getElementById('tabdimensionsSection');
                    const groupSection = document.getElementById('groupBySection');
                    const filterSection = document.querySelector('.filters-section')?.closest('.section');
                    
                    if (compConfig) compConfig.style.display = 'block';
                    if (tabdimSection) tabdimSection.style.display = 'none';
                    if (groupSection) groupSection.style.display = 'none';
                    if (filterSection) filterSection.style.display = 'none';
                    
                    // Initialize comparison
                    initializeComparisonConfig(tab);
                } else if (tabType === 'chart') {
                    // Show chart config, hide dimensions/group by
                    const chartConfig = document.getElementById('chartConfig');
                    const compConfig = document.getElementById('comparisonConfig');
                    const tabdimSection = document.getElementById('tabdimensionsSection');
                    const groupSection = document.getElementById('groupBySection');
                    const optionsSection = document.getElementById('hideDuplicates')?.closest('.section');
                    const filterSection = document.querySelector('.filters-section')?.closest('.section');
                    
                    if (chartConfig) chartConfig.style.display = 'block';
                    if (compConfig) compConfig.style.display = 'none';
                    if (tabdimSection) tabdimSection.style.display = 'none';
                    if (groupSection) groupSection.style.display = 'none';
                    if (optionsSection) optionsSection.style.display = 'none';
                    if (filterSection) filterSection.style.display = 'none';
                    
                    // Initialize charts array
                    if (!tab.charts) {
                        tab.charts = [];
                    }
                    
                    renderChartsList(tab);    
                } else {
                    // Standard/Creative tab
                    if (tabType === 'standard') {
                        tab.dimensions = tab.dimensions.filter(dimId => !dimId.startsWith('creative_'));
                    }
                    
                    const chartConfig = document.getElementById('chartConfig');
                    const compConfig = document.getElementById('comparisonConfig');
                    const dimSection = document.getElementById('tabdimensionsSection');
                    const groupSection = document.getElementById('groupBySection');
                    const filterSection = document.querySelector('.filters-section')?.closest('.section');
                    const optionsSection = document.getElementById('hideDuplicates')?.closest('.section');
                    
                    if (chartConfig) chartConfig.style.display = 'none';
                    if (compConfig) compConfig.style.display = 'none';
                    if (dimSection) dimSection.style.display = 'block';
                    if (groupSection) groupSection.style.display = 'block';
                    if (filterSection) filterSection.style.display = 'block';
                    if (optionsSection) optionsSection.style.display = 'block';
                }
                
                if (tabType !== 'comparison') {
                    renderDimensionSelection(tab);
                }
                
                hasUnsavedChanges = true;
            }
        }

        function initializeComparisonConfig(tab) {
            // Initialize date pickers
            flatpickr('#customPeriod1From', { dateFormat: 'Y-m-d', allowInput: true });
            flatpickr('#customPeriod1To', { dateFormat: 'Y-m-d', allowInput: true });
            flatpickr('#customPeriod2From', { dateFormat: 'Y-m-d', allowInput: true });
            flatpickr('#customPeriod2To', { dateFormat: 'Y-m-d', allowInput: true });

            // Populate dimension dropdown
            populateComparisonDimensionDropdown();
            
            // Populate metric dropdown
            populateComparisonMetricDropdown();
            
            // Load existing config
            if (tab.dateMode) {
                const modeRadio = document.querySelector(`input[name="dateRangeMode"][value="${tab.dateMode}"]`);
                if (modeRadio) modeRadio.checked = true;
            }
            
            if (tab.smartTemplate) {
                document.getElementById('smartTemplate').value = tab.smartTemplate;
            }
            
            if (tab.period1) {
                document.getElementById('customPeriod1From').value = tab.period1.from || '';
                document.getElementById('customPeriod1To').value = tab.period1.to || '';
                document.getElementById('customPeriod1Label').value = tab.period1.label || '';
            }
            
            if (tab.period2) {
                document.getElementById('customPeriod2From').value = tab.period2.from || '';
                document.getElementById('customPeriod2To').value = tab.period2.to || '';
                document.getElementById('customPeriod2Label').value = tab.period2.label || '';
            }
            
            if (tab.comparisonOptions) {
                document.getElementById('compShowAbsolute').checked = tab.comparisonOptions.showAbsolute;
                document.getElementById('compShowPercentage').checked = tab.comparisonOptions.showPercentage;
                document.getElementById('compColorCoding').checked = tab.comparisonOptions.colorCoding;
            }
            
            toggleDateRangeMode();
            updateSmartPreview();
            renderComparisonMetrics(tab);
            renderComparisonDimensions(tab);
        }

        function populateComparisonDimensionDropdown() {
            const dropdown = document.getElementById('comparisonDimensionDropdown');
            if (!dropdown) return;
            
            dropdown.innerHTML = '<option value="">+ Add Dimension </option>';
            
            // Add Date
            if (dateConfig.sourceColumn) {
                const option = document.createElement('option');
                option.value = 'date_column';
                option.textContent = dateConfig.displayName;
                dropdown.appendChild(option);
            }
            
            // Add regular dimensions
            dimensions.forEach(dim => {
                const option = document.createElement('option');
                option.value = dim.id;
                option.textContent = dim.displayName;
                dropdown.appendChild(option);
            });
        }
        
        function addDimensionToComparison() {
            const dropdown = document.getElementById('comparisonDimensionDropdown');
            const dimId = dropdown.value;
            
            if (!dimId) return;
            
            const tab = tabs.find(t => t.id === currentEditingTabId);
            if (!tab) return;
            
            // Initialize dimensions array if not exists
            if (!tab.dimensions) {
                tab.dimensions = [];
            }
            
            // Check if already added
            if (tab.dimensions.includes(dimId)) {
                showModal('', 'Already Added', 'This dimension is already in the list!');
                dropdown.value = '';
                return;
            }
            
            // Add dimension
            tab.dimensions.push(dimId);
            renderComparisonDimensions(tab);
            
            dropdown.value = '';
            hasUnsavedChanges = true;
        }
        
        function renderComparisonDimensions(tab) {
            const display = document.getElementById('comparisonDimensionsDisplay');
            if (!display) return;
            
            if (!tab.dimensions || tab.dimensions.length === 0) {
                display.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-gray); font-size: 14px;">
                        No dimensions selected.<br>
                        Data will be aggregated as total.
                    </div>
                `;
                return;
            }
            
            display.innerHTML = '';
            
            tab.dimensions.forEach(dimId => {
                let dimName;
                
                if (dimId === 'date_column') {
                    dimName = dateConfig.displayName;
                } else {
                    const dim = dimensions.find(d => d.id === dimId);
                    dimName = dim?.displayName || dimId;
                }
                
                const token = document.createElement('div');
                token.className = 'metric-selector-token';
                token.style.background = 'linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%)';
                token.dataset.dimId = dimId;
                token.innerHTML = `
                    <span>${dimName}</span>
                    <button class="remove-btn" onclick="removeDimensionFromComparison('${dimId}')" title="Remove"></button>
                `;
                
                display.appendChild(token);
            });
            
            // Make sortable
            new Sortable(display, {
                animation: 150,
                onEnd: function(evt) {
                    const movedDim = tab.dimensions.splice(evt.oldIndex, 1)[0];
                    tab.dimensions.splice(evt.newIndex, 0, movedDim);
                    hasUnsavedChanges = true;
                }
            });
        }
        
        function removeDimensionFromComparison(dimId) {
            const tab = tabs.find(t => t.id === currentEditingTabId);
            if (!tab) return;
            
            tab.dimensions = tab.dimensions.filter(id => id !== dimId);
            renderComparisonDimensions(tab);
            hasUnsavedChanges = true;
        }
        
        function toggleDateRangeMode() {
            const mode = document.querySelector('input[name="dateRangeMode"]:checked').value;
            const smartConfig = document.getElementById('smartModeConfig');
            const customConfig = document.getElementById('customModeConfig');
            
            if (mode === 'smart') {
                smartConfig.style.display = 'block';
                customConfig.style.display = 'none';
                updateSmartPreview();
            } else {
                smartConfig.style.display = 'none';
                customConfig.style.display = 'block';
            }
        }
        
        function updateSmartPreview() {
            const template = document.getElementById('smartTemplate').value;
            const todayEl = document.getElementById('smartToday');
            const period1El = document.getElementById('smartPeriod1Preview');
            const period2El = document.getElementById('smartPeriod2Preview');
            
            if (!todayEl || !period1El || !period2El) return;
            
            const today = new Date();
            todayEl.textContent = formatDate(today);
            
            const periods = smartTemplates[template].calculate();
            
            const days1 = getDaysBetween(periods.period1.from, periods.period1.to);
            const days2 = getDaysBetween(periods.period2.from, periods.period2.to);
            
            period1El.innerHTML = `<strong>Period 1:</strong> ${periods.period1.label} 
                [${formatDateDisplay(periods.period1.from)} ~ ${formatDateDisplay(periods.period1.to)}] 
                <span style="color: var(--text-gray);">(${days1} days)</span>`;
            
            period2El.innerHTML = `<strong>Period 2:</strong> ${periods.period2.label} 
                [${formatDateDisplay(periods.period2.from)} ~ ${formatDateDisplay(periods.period2.to)}] 
                <span style="color: var(--text-gray);">(${days2} days)</span>`;
        }
        
        function populateComparisonMetricDropdown() {
            const dropdown = document.getElementById('comparisonMetricDropdown');
            if (!dropdown) return;
            
            dropdown.innerHTML = '<option value="">+ Add Metric </option>';
            
            metrics.forEach(metric => {
                const option = document.createElement('option');
                option.value = metric.id;
                option.textContent = metric.displayName;
                dropdown.appendChild(option);
            });
        }
        
        function addMetricToComparison() {
            const dropdown = document.getElementById('comparisonMetricDropdown');
            const metricId = dropdown.value;
            
            if (!metricId) return;
            
            const tab = tabs.find(t => t.id === currentEditingTabId);
            if (!tab) return;
            
            // Check if already added
            if (tab.selectedMetrics.includes(metricId)) {
                showModal('', 'Already Added', 'This metric is already in the comparison list!');
                dropdown.value = '';
                return;
            }
            
            // Add metric
            tab.selectedMetrics.push(metricId);
            renderComparisonMetrics(tab);
            
            dropdown.value = '';
            hasUnsavedChanges = true;
        }
        
        function renderComparisonMetrics(tab) {
            const display = document.getElementById('comparisonMetricsDisplay');
            if (!display) return;
            
            if (tab.selectedMetrics.length === 0) {
                display.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-gray); font-size: 14px;">
                        No metrics selected.<br>Click dropdown below to add metrics.
                    </div>
                `;
                return;
            }
            
            display.innerHTML = '';
            
            tab.selectedMetrics.forEach(metricId => {
                const metric = metrics.find(m => m.id === metricId);
                if (!metric) return;
                
                const token = document.createElement('div');
                token.className = 'metric-selector-token';
                token.dataset.metricId = metricId;
                token.innerHTML = `
                    <span>${metric.displayName}</span>
                    <button class="remove-btn" onclick="removeMetricFromComparison('${metricId}')" title="Remove"></button>
                `;
                
                display.appendChild(token);
            });
            
            // Make sortable
            new Sortable(display, {
                animation: 150,
                onEnd: function(evt) {
                    const movedMetric = tab.selectedMetrics.splice(evt.oldIndex, 1)[0];
                    tab.selectedMetrics.splice(evt.newIndex, 0, movedMetric);
                    hasUnsavedChanges = true;
                }
            });
        }
        
        function removeMetricFromComparison(metricId) {
            const tab = tabs.find(t => t.id === currentEditingTabId);
            if (!tab) return;
            
            tab.selectedMetrics = tab.selectedMetrics.filter(id => id !== metricId);
            renderComparisonMetrics(tab);
            hasUnsavedChanges = true;
        }
        
        
        function renderDimensionSelection(tab) {
            // FIX: Don't render for comparison tabs
            if (tab.type === 'comparison') {
                return;
            }
            const available = document.getElementById('availableDimensions');
            const selected = document.getElementById('selectedDimensions');
            
            available.innerHTML = '';
            selected.innerHTML = '';
            
            // FIX: Add Date column as first available dimension
            if (dateConfig.sourceColumn && !tab.dimensions.includes('date_column')) {
                const item = document.createElement('div');
                item.className = 'dimension-item';
                item.dataset.dimId = 'date_column';
                item.innerHTML = `
                    <span class="icon"></span>
                    <span class="name">${dateConfig.displayName}</span>
                `;
                item.onclick = () => selectDimension('date_column');
                available.appendChild(item);
            }

            // FIX: Add Creative dimensions if enabled
            if (creativeConfig.enabled) {
                const creativeDimensions = [
                    { id: 'creative_ad_name', name: ' Ad Name', required: false },
                    { id: 'creative_file_name', name: ' File Name', required: false },
                    { id: 'creative_image', name: ' Creative', required: tab.type === 'creative' },
                    { id: 'creative_ad_format', name: ' Ad Format', required: false }
                ];
                
                creativeDimensions.forEach(dim => {
                    if (!tab.dimensions.includes(dim.id)) {
                        const item = document.createElement('div');
                        item.className = 'dimension-item';
                        item.dataset.dimId = dim.id;
                        item.innerHTML = `
                            <span class="icon">${dim.required ? '' : ''}</span>
                            <span class="name">${dim.name}</span>
                        `;
                        item.onclick = () => selectDimension(dim.id);
                        available.appendChild(item);
                    }
                });
            }

            
            // Available dimensions
            dimensions.forEach(dim => {
                if (!tab.dimensions.includes(dim.id)) {
                    const item = document.createElement('div');
                    item.className = 'dimension-item';
                    item.dataset.dimId = dim.id;
                    item.innerHTML = `
                        <span class="icon"></span>
                        <span class="name">${dim.displayName}</span>
                    `;
                    item.onclick = () => selectDimension(dim.id);
                    available.appendChild(item);
                }
            });
            
            // Selected dimensions
            tab.dimensions.forEach(dimId => {
                let dim;
                let icon = '';
                let canRemove = true;
                
                // FIX: Handle date column
                if (dimId === 'date_column') {
                    dim = { id: 'date_column', displayName: dateConfig.displayName };
                    icon = '';
                } 
                // FIX: Handle creative columns
                else if (dimId.startsWith('creative_')) {
                    const creativeNames = {
                        'creative_ad_name': ' Ad Name',
                        'creative_file_name': ' File Name',
                        'creative_image': ' Creative',
                        'creative_ad_format': ' Ad Format'
                    };
                    dim = { id: dimId, displayName: creativeNames[dimId] || dimId };
                    
                    // FIX: Only Creative column is locked (cannot remove)
                    if (tab.type === 'creative' && dimId === 'creative_image') {
                        canRemove = false;
                    }
                } 
                else {
                    dim = dimensions.find(d => d.id === dimId);
                }
                
                if (dim) {
                    const item = document.createElement('div');
                    item.className = 'dimension-item selected';
                    item.dataset.dimId = dim.id;
                    
                    if (canRemove) {
                        item.innerHTML = `
                            <span class="icon"></span>
                            <span class="name">${dim.displayName}</span>
                        `;
                        item.onclick = () => deselectDimension(dim.id);
                    } else {
                        item.innerHTML = `
                            <span class="icon"></span>
                            <span class="name">${dim.displayName}</span>
                        `;
                        item.style.opacity = '0.7';
                        item.style.cursor = 'move';
                        item.title = 'Required for Creative tab (cannot remove)';
                    }
                    
                    selected.appendChild(item);
                }
            });
            
            new Sortable(selected, {
                animation: 150,
                onEnd: function(evt) {
                    const tab = tabs.find(t => t.id === currentEditingTabId);
                    const movedDim = tab.dimensions.splice(evt.oldIndex, 1)[0];
                    tab.dimensions.splice(evt.newIndex, 0, movedDim);
                    hasUnsavedChanges = true;
                }
            });
        }
        
        function selectDimension(dimId) {
            const tab = tabs.find(t => t.id === currentEditingTabId);
            if (tab.dimensions.length >= 10) {
                showModal('', 'Limit Reached', 'Maximum 10 dimensions per tab!');
                return;
            }
            tab.dimensions.push(dimId);
            renderDimensionSelection(tab);
            updateGroupByDropdown(tab);
            hasUnsavedChanges = true;
        }
        
        function deselectDimension(dimId) {
            const tab = tabs.find(t => t.id === currentEditingTabId);
            tab.dimensions = tab.dimensions.filter(id => id !== dimId);
            
            if (tab.groupBy === dimId) {
                tab.groupBy = null;
            }
            
            renderDimensionSelection(tab);
            updateGroupByDropdown(tab);
            hasUnsavedChanges = true;
        }
        
        function updateGroupByDropdown(tab) {
            const select = document.getElementById('groupBy');
            select.innerHTML = '<option value="">None - Single table</option>';
            
            tab.dimensions.forEach(dimId => {
                let dim;
                
                // FIX: Handle date column
                if (dimId === 'date_column') {
                    dim = { id: 'date_column', displayName: dateConfig.displayName };
                } else {
                    dim = dimensions.find(d => d.id === dimId);
                }
                
                if (dim) {
                    const option = document.createElement('option');
                    option.value = dim.id;
                    option.textContent = dim.displayName;
                    if (tab.groupBy === dim.id) {
                        option.selected = true;
                    }
                    select.appendChild(option);
                }
            });
        }
        
        // ========================================
        // FILTERS
        // ========================================
        
        function addFilter() {
            const tab = tabs.find(t => t.id === currentEditingTabId);
            const filter = {
                id: `filter_${filterIdCounter++}`,
                column: '',
                operator: '',
                value: '',
                valueTo: '',
                logic: 'AND' // FIX: Default logic
            };
            tab.filters.push(filter);
            renderFilters(tab);
            hasUnsavedChanges = true;
        }
        
        function renderFilters(tab) {
            const container = document.getElementById('filtersList');
            
            if (tab.filters.length === 0) {
                container.innerHTML = `
                    <div class="empty-filters">
                        No filters applied.<br>
                        All data will be displayed.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            tab.filters.forEach((filter, index) => {
                // FIX: Render AND/OR toggle BETWEEN filters (not inside filter item)
                if (index > 0) {
                    const logicToggle = document.createElement('div');
                    logicToggle.style.cssText = 'display: flex; align-items: center; justify-content: center; margin: 5px 0;';
                    logicToggle.innerHTML = `
                        <div style="display: inline-flex; background: var(--light-gray); border-radius: 20px; padding: 3px; box-shadow: var(--shadow-sm);">
                            <button onclick="updateFilterLogic('${filter.id}', 'AND')" 
                                    style="padding: 8px 20px; border: none; border-radius: 18px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; background: ${filter.logic === 'AND' ? 'var(--primary-green)' : 'transparent'}; color: ${filter.logic === 'AND' ? 'white' : 'var(--text-gray)'};">
                                AND
                            </button>
                            <button onclick="updateFilterLogic('${filter.id}', 'OR')" 
                                    style="padding: 8px 20px; border: none; border-radius: 18px; cursor: pointer; font-size: 13px; font-weight: 600; transition: all 0.2s; background: ${filter.logic === 'OR' ? 'var(--warning)' : 'transparent'}; color: ${filter.logic === 'OR' ? 'white' : 'var(--text-gray)'};">
                                OR
                            </button>
                        </div>
                    `;
                    container.appendChild(logicToggle);
                }
                
                const item = document.createElement('div');
                item.className = 'filter-item';
                item.dataset.filterId = filter.id;
                
                const columnType = getColumnType(filter.column);
                
                let valueInput = '';
                if (filter.operator === 'between') {
                    valueInput = `
                        <div class="filter-between">
                            <input type="${columnType === 'date' ? 'text' : columnType === 'number' ? 'number' : 'text'}" 
                                   class="filter-value-from" 
                                   value="${filter.value}" 
                                   placeholder="From"
                                   onchange="updateFilterValue('${filter.id}', 'value', this.value)">
                            <span>to</span>
                            <input type="${columnType === 'date' ? 'text' : columnType === 'number' ? 'number' : 'text'}" 
                                   class="filter-value-to" 
                                   value="${filter.valueTo}" 
                                   placeholder="To"
                                   onchange="updateFilterValue('${filter.id}', 'valueTo', this.value)">
                        </div>
                    `;
                } else {
                    valueInput = `
                        <input type="${columnType === 'date' ? 'text' : columnType === 'number' ? 'number' : 'text'}" 
                               class="filter-value" 
                               value="${filter.value}" 
                               placeholder="Value"
                               onchange="updateFilterValue('${filter.id}', 'value', this.value)">
                    `;
                }
                
                item.innerHTML = `
                    <div class="filter-row">
                        <select onchange="updateFilterColumn('${filter.id}', this.value)">
                            <option value="">-- Select Column --</option>
                            <optgroup label="Date">
                                <option value="date_column" ${filter.column === 'date_column' ? 'selected' : ''}>${dateConfig.displayName}</option>
                            </optgroup>
                            <optgroup label="Dimensions">
                                ${dimensions.map(dim => 
                                    `<option value="${dim.id}" ${filter.column === dim.id ? 'selected' : ''}>${dim.displayName}</option>`
                                ).join('')}
                            </optgroup>
                            <optgroup label="Metrics">
                                ${metrics.map(met => 
                                    `<option value="${met.id}" ${filter.column === met.id ? 'selected' : ''}>${met.displayName}</option>`
                                ).join('')}
                            </optgroup>
                        </select>
                        
                        <select onchange="updateFilterOperator('${filter.id}', this.value)">
                            <option value="">-- Operator --</option>
                            ${getOperatorsForColumn(filter.column).map(op => 
                                `<option value="${op.value}" ${filter.operator === op.value ? 'selected' : ''}>${op.label}</option>`
                            ).join('')}
                        </select>
                        
                        ${valueInput}
                        
                        <button class="delete-filter-btn" onclick="deleteFilter('${filter.id}')" title="Delete"></button>
                    </div>
                `;
                
                container.appendChild(item);
                
                // Initialize date picker if needed
                if (columnType === 'date') {
                    const inputs = item.querySelectorAll('input[type="text"]');
                    inputs.forEach(input => {
                        flatpickr(input, {
                            dateFormat: 'Y-m-d',
                            allowInput: true
                        });
                    });
                }
            });
        }

        function updateFilterLogic(filterId, logic) {
            const tab = tabs.find(t => t.id === currentEditingTabId);
            const filter = tab.filters.find(f => f.id === filterId);
            if (filter) {
                filter.logic = logic;
                renderFilters(tab);
                hasUnsavedChanges = true;
            }
        }

        
        function getColumnType(columnId) {
            if (columnId === 'date_column') return 'date';
            
            const dim = dimensions.find(d => d.id === columnId);
            if (dim) {
                if (dim.sourceColumn && dim.sourceColumn.toLowerCase().includes('date')) {
                    return 'date';
                }
                return 'text';
            }
            
            const met = metrics.find(m => m.id === columnId);
            if (met) return 'number';
            
            return 'text';
        }
        
        function getOperatorsForColumn(columnId) {
            const type = getColumnType(columnId);
            return operators[type] || operators.text;
        }
        
        function updateFilterColumn(filterId, value) {
            const tab = tabs.find(t => t.id === currentEditingTabId);
            const filter = tab.filters.find(f => f.id === filterId);
            if (filter) {
                filter.column = value;
                filter.operator = '';
                filter.value = '';
                filter.valueTo = '';
                renderFilters(tab);
                hasUnsavedChanges = true;
            }
        }
        
        function updateFilterOperator(filterId, value) {
            const tab = tabs.find(t => t.id === currentEditingTabId);
            const filter = tab.filters.find(f => f.id === filterId);
            if (filter) {
                filter.operator = value;
                renderFilters(tab);
                hasUnsavedChanges = true;
            }
        }
        
        function updateFilterValue(filterId, field, value) {
            const tab = tabs.find(t => t.id === currentEditingTabId);
            const filter = tab.filters.find(f => f.id === filterId);
            if (filter) {
                filter[field] = value;
                hasUnsavedChanges = true;
            }
        }
        
        function deleteFilter(filterId) {
            const tab = tabs.find(t => t.id === currentEditingTabId);
            if (tab) {
                tab.filters = tab.filters.filter(f => f.id !== filterId);
                renderFilters(tab);
                hasUnsavedChanges = true;
            }
        }
        
        // ========================================
        // TAB ACTIONS
        // ========================================
        
        function saveTab() {
            const tab = tabs.find(t => t.id === currentEditingTabId);
            
            const name = document.getElementById('tabName').value.trim();
            if (!name) {
                showModal('', 'Validation Error', 'Please enter a tab name!');
                return;
            }
            
            // FIX: Only validate dimensions for standard/creative tabs
            if (tab.type === 'standard' || tab.type === 'creative') {
                if (!tab.dimensions || tab.dimensions.length === 0) {
                    showModal('', 'Validation Error', 'Please select at least one dimension!');
                    return;
                }
            }

            // FIX: Validate creative tab
            if (tab.type === 'creative') {
                // Must have Creative column
                if (!tab.dimensions.includes('creative_image')) {
                    showModal('', 'Validation Error', 'Creative tab must include Creative column!');
                    return;
                }
                
                // Must have at least Ad Name OR File Name
                const hasAdName = tab.dimensions.includes('creative_ad_name');
                const hasFileName = tab.dimensions.includes('creative_file_name');
                
                if (!hasAdName && !hasFileName) {
                    showModal('', 'Validation Error', 'Creative tab must include at least Ad Name or File Name!');
                    return;
                }
            }

            // FIX: Validate comparison tab
            if (tab.type === 'comparison') {
                // Save comparison config
                tab.dateMode = document.querySelector('input[name="dateRangeMode"]:checked').value;
                
                if (tab.dateMode === 'smart') {
                    tab.smartTemplate = document.getElementById('smartTemplate').value;
                    
                    // Calculate periods from template
                    const periods = smartTemplates[tab.smartTemplate].calculate();
                    tab.period1 = periods.period1;
                    tab.period2 = periods.period2;
                } else {
                    // Custom mode
                    const p1From = document.getElementById('customPeriod1From').value;
                    const p1To = document.getElementById('customPeriod1To').value;
                    const p2From = document.getElementById('customPeriod2From').value;
                    const p2To = document.getElementById('customPeriod2To').value;
                    
                    if (!p1From || !p1To || !p2From || !p2To) {
                        showModal('', 'Validation Error', 'Please fill in all date ranges for both periods!');
                        return;
                    }
                    
                    tab.period1 = {
                        from: p1From,
                        to: p1To,
                        label: document.getElementById('customPeriod1Label').value || 'Period 1'
                    };
                    
                    tab.period2 = {
                        from: p2From,
                        to: p2To,
                        label: document.getElementById('customPeriod2Label').value || 'Period 2'
                    };
                }
                
                // Validate metrics
                if (tab.selectedMetrics.length === 0) {
                    showModal('', 'Validation Error', 'Please select at least one metric to compare!');
                    return;
                }
                
                // Save comparison options
                tab.comparisonOptions = {
                    showAbsolute: document.getElementById('compShowAbsolute').checked,
                    showPercentage: document.getElementById('compShowPercentage').checked,
                    colorCoding: document.getElementById('compColorCoding').checked
                };
            }

            // FIX: Validate chart tab
            if (tab.type === 'chart') {
                if (!tab.charts || tab.charts.length === 0) {
                    showModal('', 'Validation Error', 'Please add at least one chart!');
                    return;
                }
                
                // Validate each chart
                for (let i = 0; i < tab.charts.length; i++) {
                    const chart = tab.charts[i];
                    
                    if (chart.chartType === 'pie') {
                        if (!chart.xAxis) {
                            showModal('', 'Validation Error', `Chart ${i + 1}: Please select a dimension for pie chart!`);
                            return;
                        }
                        if (chart.yAxisMetrics.length === 0) {
                            showModal('', 'Validation Error', `Chart ${i + 1}: Please select a metric for pie chart!`);
                            return;
                        }
                    } else {
                        if (!chart.xAxis) {
                            showModal('', 'Validation Error', `Chart ${i + 1}: Please select X-Axis!`);
                            return;
                        }
                        if (chart.yAxisMetrics.length === 0) {
                            showModal('', 'Validation Error', `Chart ${i + 1}: Please select at least one metric for Y-Axis!`);
                            return;
                        }
                    }
                }
            }
            
            const duplicate = tabs.find(t => t.id !== tab.id && t.name === name);
            if (duplicate) {
                showModal('', 'Validation Error', 'Tab name already exists!');
                return;
            }
            
            for (let filter of tab.filters) {
                if (!filter.column || !filter.operator) {
                    showModal('', 'Validation Error', 'Please complete all filter fields or remove incomplete filters!');
                    return;
                }
                if (!filter.value && filter.operator !== 'between') {
                    showModal('', 'Validation Error', 'Please enter filter value!');
                    return;
                }
                if (filter.operator === 'between' && (!filter.value || !filter.valueTo)) {
                    showModal('', 'Validation Error', 'Please enter both "from" and "to" values for between filter!');
                    return;
                }
            }
            
            tab.name = name;
            // FIX: Only save these for standard/creative tabs
            if (tab.type === 'standard' || tab.type === 'creative') {
                tab.groupBy = document.getElementById('groupBy')?.value || null;
                tab.options.hideDuplicates = document.getElementById('hideDuplicates')?.checked || false;
                tab.options.showTotal = document.getElementById('showTotal')?.checked || true;
            }
            
            hasUnsavedChanges = false;
            renderTabsList();
            
            showModal('', 'Success', 'Tab saved successfully!');
        }
        
        function cancelTabEdit() {
            if (hasUnsavedChanges) {
                showModal('', 'Unsaved Changes', 
                    'You have unsaved changes. Discard them?',
                    function() {
                        hasUnsavedChanges = false;
                        if (tabs.length > 0) {
                            loadTabConfig(tabs[0].id);
                        } else {
                            checkEmptyState();
                        }
                    }
                );
            } else {
                if (tabs.length > 0) {
                    loadTabConfig(tabs[0].id);
                } else {
                    checkEmptyState();
                }
            }
        }
        
        function duplicateTab(tabId) {
            const original = tabs.find(t => t.id === tabId);
            const copy = JSON.parse(JSON.stringify(original));
            copy.id = `tab_${tabIdCounter++}`;
            copy.name = `${copy.name} (Copy)`;
            tabs.push(copy);
            renderTabsList();
            editTab(copy.id);
        }
        
        function deleteTab(tabId) {
            showModal('', 'Delete Tab', 
                'Are you sure you want to delete this tab?',
                function() {
                    tabs = tabs.filter(t => t.id !== tabId);
                    if (currentEditingTabId === tabId) {
                        currentEditingTabId = null;
                        hasUnsavedChanges = false;
                    }
                    renderTabsList();
                    checkEmptyState();
                }
            );
        }
        
        function previewTab() {
            const tab = tabs.find(t => t.id === currentEditingTabId);
            
            if (!tab || tab.dimensions.length === 0) {
                showModal('', 'Cannot Preview', 'Please select at least one dimension first!');
                return;
            }
            
            showLoading('Generating preview...');
            
            setTimeout(() => {
                const previewData = aggregateData(tab, 10);
                hideLoading();
                showPreviewModal(tab, previewData);
            }, 500);
        }
        
        function showPreviewModal(tab, previewData) {
            const tableName = generateTableName(tab, null);
            
            let tableHTML = `
                <div class="preview-table-container" style="max-height: 400px; overflow: auto;">
                    <table class="preview-table">
                        <thead>
                            <tr>
            `;
            
            // Dimension headers
            tab.dimensions.forEach(dimId => {
                let dim;
                if (dimId === 'date_column') {
                    dim = { id: 'date_column', displayName: dateConfig.displayName };
                } else if (dimId === 'creative_ad_name') {
                    dim = { id: 'creative_ad_name', displayName: 'Ad Name' };
                } else if (dimId === 'creative_file_name') {
                    dim = { id: 'creative_file_name', displayName: 'File Name' };
                } else if (dimId === 'creative_image') {
                    dim = { id: 'creative_image', displayName: 'Creative' };
                } else if (dimId === 'creative_ad_format') {
                    dim = { id: 'creative_ad_format', displayName: 'Ad Format' };
                } else {
                    dim = dimensions.find(d => d.id === dimId);
                }
                if (dim) {
                    tableHTML += `<th>${dim.displayName}</th>`;
                }
            });
            
            // Metric headers
            metrics.forEach(metric => {
                tableHTML += `<th>${metric.displayName}</th>`;
            });
            
            tableHTML += `</tr></thead><tbody>`;
            
            // Data rows - previewData is array of objects
            previewData.forEach(rowData => {
                tableHTML += '<tr>';
                
                // Dimension values
                tab.dimensions.forEach(dimId => {
                    let dim;
                    let isCreativeImage = false;
                    
                    if (dimId === 'date_column') {
                        dim = { id: 'date_column', sourceColumn: dateConfig.sourceColumn };
                    } else if (dimId === 'creative_ad_name') {
                        dim = { id: 'creative_ad_name', sourceColumn: creativeConfig.adNameColumn };
                    } else if (dimId === 'creative_file_name') {
                        const col = creativeConfig.sameAsAdName ? creativeConfig.adNameColumn : creativeConfig.fileNameColumn;
                        dim = { id: 'creative_file_name', sourceColumn: col };
                    } else if (dimId === 'creative_image') {
                        isCreativeImage = true;
                    } else if (dimId === 'creative_ad_format') {
                        dim = { id: 'creative_ad_format', sourceColumn: creativeConfig.adFormatColumn };
                    } else {
                        dim = dimensions.find(d => d.id === dimId);
                    }
                    
                    if (isCreativeImage) {
                        // Show placeholder in preview
                        tableHTML += `<td style="text-align: center;"></td>`;
                    } else if (dim) {
                        let value = rowData[dim.sourceColumn] || '-';
                        
                        if (dimId === 'date_column') {
                            value = formatDateValue(value, dateConfig.format);
                        }
                        
                        tableHTML += `<td>${value}</td>`;
                    }
                });
                
                // Metric values
                metrics.forEach((metric, metricIndex) => {
                    const value = rowData[`metric_${metricIndex}`];
                    const formatted = formatMetricValue(value, metric);
                    tableHTML += `<td>${formatted}</td>`;
                });
                
                tableHTML += '</tr>';
            });
            
            tableHTML += '</tbody></table></div>';
            
            const modalBody = `
                <div style="margin-bottom: 15px;">
                    <strong> ${tableName}</strong><br>
                    <span style="font-size: 12px; color: var(--text-gray);">Showing ${previewData.length} rows (sample)</span>
                </div>
                ${tableHTML}
            `;
            
            showModal('', 'Tab Preview', modalBody, null, null, 'Close');
        }
        
        // ========================================
        // PROCEED TO SUMMARY
        // ========================================
        
        function proceedToSummary() {
            if (tabs.length === 0) {
                showModal('', 'No Tabs', 'Please create at least one tab before proceeding!');
                return;
            }
            
            if (hasUnsavedChanges) {
                showModal('', 'Unsaved Changes', 
                    'You have unsaved changes in current tab. Save before proceeding?',
                    function() {
                        saveTab();
                        setTimeout(() => {
                            enableSidebarStep('summary');
                            navigateToStep('summary');
                        }, 500);
                    },
                    function() {
                        enableSidebarStep('summary');
                        navigateToStep('summary');
                    },
                    'Save',
                    'Skip'
                );
            } else {
                enableSidebarStep('summary');
                navigateToStep('summary');
            }
        }
        
        // ========================================
        // SUMMARY SCREEN (Step 4)
        // ========================================
        
       function updateSummaryStats() {
            document.getElementById('statTabs').textContent = tabs.length;
            document.getElementById('statDimensions').textContent = dimensions.length;
            document.getElementById('statMetrics').textContent = metrics.length;
            
            // FIX: Load metadata into form
            if (templateMetadata.clientName) {
                document.getElementById('clientName').value = templateMetadata.clientName;
            }
            if (templateMetadata.service) {
                document.getElementById('serviceName').value = templateMetadata.service;
            }
            if (templateMetadata.reportType) {
                const radioButton = document.querySelector(`input[name="reportType"][value="${templateMetadata.reportType}"]`);
                if (radioButton) {
                    radioButton.checked = true;
                }
            }
        }
        
        function exportTemplate() {
            const clientName = document.getElementById('clientName').value.trim();
            const serviceName = document.getElementById('serviceName').value.trim();
            const reportType = document.querySelector('input[name="reportType"]:checked').value;
            
            if (!clientName || !serviceName) {
                showModal('', 'Validation Error', 'Please fill in all required fields (Client Name, Service)!');
                return;
            }
            
            templateMetadata.clientName = clientName;
            templateMetadata.service = serviceName;
            templateMetadata.reportType = reportType;
            templateMetadata.createdAt = templateMetadata.createdAt || new Date().toISOString();
            templateMetadata.updatedAt = new Date().toISOString();
            
           const template = {
                version: '1.0',
                metadata: templateMetadata,
                dateConfig: dateConfig,
		creativeConfig: creativeConfig,
                dimensions: dimensions,
                metrics: metrics,
                tabs: tabs,
                settings: dashboardSettings  // FIX: Save settings
            };
            
            const blob = new Blob([JSON.stringify(template, null, 2)], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dashboard-template-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            showModal('', 'Success', 'Template saved successfully!');
        }
        
        function proceedToDashboard() {
            const clientName = document.getElementById('clientName').value.trim();
            const serviceName = document.getElementById('serviceName').value.trim();
            const reportType = document.querySelector('input[name="reportType"]:checked').value;
            
            if (!clientName || !serviceName) {
                showModal('', 'Required Fields', 
                    'Client Name and Service are required. Do you want to continue anyway?',
                    function() {
                        showModal('', 'Warning', 
                            'Your configuration will be lost if you refresh the page. Continue?',
                            function() {
                                enableSidebarStep('dashboard');
                                navigateToStep('dashboard');
                            }
                        );
                    }
                );
                return;
            }
            
            templateMetadata.clientName = clientName;
            templateMetadata.service = serviceName;
            templateMetadata.reportType = reportType;
            
            enableSidebarStep('dashboard');
            navigateToStep('dashboard');
        }
        
        // ========================================
        // DASHBOARD SCREEN
        // ========================================
        
        function renderDashboard() {
            showLoading('Generating dashboard...');
            
            setTimeout(() => {
                document.getElementById('dashClientName').textContent = templateMetadata.clientName || '-';
                document.getElementById('dashService').textContent = templateMetadata.service || '-';
                document.getElementById('dashReportType').textContent = templateMetadata.reportType || '-';

                // FIX: Apply theme settings
                applyThemeSettings();
                
                initializeDateRange();
                renderDashboardTabs();
                
                // Apply display settings to dashboard content
                const dashContent = document.getElementById('dashboardContent');
                if (dashContent) {
                    // Apply font size
                    const fontSize = dashboardSettings.theme.fontSize === 'small' ? '12px' : 
                                     dashboardSettings.theme.fontSize === 'large' ? '16px' : '14px';
                    dashContent.style.fontSize = fontSize;
                }
                
                if (tabs.length > 0) {
                    renderTabContent(tabs[0].id);
                }
                
                hideLoading();
            }, 1000);
        }

        function applyThemeSettings() {
            console.log('Applying theme settings...');
            
            // Apply colors to CSS variables
            document.documentElement.style.setProperty('--primary-green', dashboardSettings.theme.primaryColor);
            document.documentElement.style.setProperty('--light-green', dashboardSettings.theme.headerBackground);
            document.documentElement.style.setProperty('--mint-bg', dashboardSettings.theme.totalRowColor);
            
            console.log('Colors applied:', {
                primary: dashboardSettings.theme.primaryColor,
                header: dashboardSettings.theme.headerBackground,
                total: dashboardSettings.theme.totalRowColor
            });
            
            // Apply font size
            const dashboardContent = document.getElementById('dashboardContent');
            if (dashboardContent) {
                const fontSize = dashboardSettings.theme.fontSize === 'small' ? '12px' : 
                                 dashboardSettings.theme.fontSize === 'large' ? '16px' : '14px';
                dashboardContent.style.fontSize = fontSize;
                console.log('Font size applied:', fontSize);
            }
            
            // Apply to dashboard tabs
            const dashboardTabs = document.getElementById('dashboardTabs');
            if (dashboardTabs) {
                dashboardTabs.style.fontSize = dashboardSettings.theme.fontSize === 'small' ? '13px' : 
                                                dashboardSettings.theme.fontSize === 'large' ? '15px' : '14px';
            }
        }
        
        function initializeDateRange() {
            if (!dateConfig.sourceColumn || csvData.rows.length === 0) return;
            
            const dates = csvData.rows.map(row => row[dateConfig.sourceColumn]).filter(d => d);
            if (dates.length === 0) return;
            
            // FIX: Normalize dates to YYYY-MM-DD format
            const normalizedDates = dates.map(d => normalizeDateString(d)).filter(d => d);
            const sortedDates = normalizedDates.sort();
            
            const startDate = sortedDates[0];
            const endDate = sortedDates[sortedDates.length - 1];
            
            document.getElementById('dateRangeStart').value = startDate;
            document.getElementById('dateRangeEnd').value = endDate;
            
            filteredData = null;
        }
        
        function renderDashboardTabs() {
            const container = document.getElementById('dashboardTabs');
            container.innerHTML = '';
            
            tabs.forEach((tab, index) => {
                const button = document.createElement('button');
                button.className = 'dashboard-tab';
                button.textContent = tab.name;
                button.onclick = () => switchDashboardTab(tab.id, button);
                
                if (index === 0) {
                    button.classList.add('active');
                }
                
                container.appendChild(button);
            });
        }
        
        function switchDashboardTab(tabId, buttonEl) {
            document.querySelectorAll('.dashboard-tab').forEach(btn => {
                btn.classList.remove('active');
            });
            buttonEl.classList.add('active');
            
            renderTabContent(tabId);
        }
        
        function applyDateFilter() {
            const startDate = document.getElementById('dateRangeStart').value;
            const endDate = document.getElementById('dateRangeEnd').value;
            
            if (!startDate || !endDate) {
                showModal('', 'Invalid Date Range', 'Please select both start and end dates!');
                return;
            }
            
            showLoading('Filtering data...');
            
            setTimeout(() => {
                // FIX: Normalize dates before comparison
                const normalizedStart = normalizeDateString(startDate);
                const normalizedEnd = normalizeDateString(endDate);
                
                console.log('Date filter:', { start: normalizedStart, end: normalizedEnd });
                
                filteredData = csvData.rows.filter(row => {
                    const rowDate = normalizeDateString(row[dateConfig.sourceColumn]);
                    const result = rowDate >= normalizedStart && rowDate <= normalizedEnd;
                    return result;
                });
                
                console.log('Filtered rows:', filteredData.length);
                
                // FIX: Reset pagination when filtering
                tablePaginationState.clear();
                
                const activeTab = document.querySelector('.dashboard-tab.active');
                if (activeTab) {
                    const tabIndex = Array.from(activeTab.parentNode.children).indexOf(activeTab);
                    renderTabContent(tabs[tabIndex].id);
                }
                
                hideLoading();
                showModal('', 'Success', `Filtered to ${filteredData.length} rows`);
            }, 500);
        }
        
        function renderTabContent(tabId) {
            const tab = tabs.find(t => t.id === tabId);
            if (!tab) return;
            
            const container = document.getElementById('dashboardContent');
            container.innerHTML = '';
            
            const dataToUse = filteredData || csvData.rows;
            
            // FIX: Handle comparison tab FIRST (before aggregation)
            if (tab.type === 'comparison') {
                renderComparisonTable(container, tab, dataToUse);
                return;
            }

            // FIX: Handle chart tab
            if (tab.type === 'chart') {
                renderChartTab(container, tab, dataToUse);
                return;
            }
            
            // For standard/creative tabs: aggregate data
            if (tab.groupBy) {
                const groupedData = groupDataByDimension(dataToUse, tab);
                
                groupedData.forEach(group => {
                    const aggregated = aggregateData(tab, null, group.data);  //  NG
                    renderTable(container, tab, group.value, aggregated);
                });
            } else {
                const aggregated = aggregateData(tab, null, dataToUse);  //  NG
                renderTable(container, tab, null, aggregated);
            }
        }

        function renderComparisonTable(container, tab, data) {
            // Calculate periods (smart or custom)
            let period1, period2;
            
            if (tab.dateMode === 'smart') {
                const periods = smartTemplates[tab.smartTemplate].calculate();
                period1 = periods.period1;
                period2 = periods.period2;
            } else {
                period1 = tab.period1;
                period2 = tab.period2;
            }
            
            // Filter data for each period
            const period1Data = data.filter(row => {
                const rowDate = normalizeDateString(row[dateConfig.sourceColumn]);
                return rowDate >= period1.from && rowDate <= period1.to;
            });
            
            const period2Data = data.filter(row => {
                const rowDate = normalizeDateString(row[dateConfig.sourceColumn]);
                return rowDate >= period2.from && rowDate <= period2.to;
            });
            
            // Aggregate each period
            const agg1 = aggregateData(tab, null, period1Data);
            const agg2 = aggregateData(tab, null, period2Data);
            
            // Build comparison data
            const comparisonData = buildComparisonData(agg1, agg2, tab);
            
            // Render table
            const tableContainer = document.createElement('div');
            tableContainer.className = 'dashboard-table-container';
            
            const days1 = getDaysBetween(period1.from, period1.to);
            const days2 = getDaysBetween(period2.from, period2.to);
            
            tableContainer.innerHTML = `
                <div class="dashboard-table-header">
                    <span class="icon"></span>
                    <h3>Period Comparison</h3>
                </div>
                <div class="alert alert-info" style="margin: 12px 0; font-size: 13px;">
                    <span></span>
                    <div>
                        <strong>${period1.label}</strong>: ${formatDateDisplay(period1.from)} ~ ${formatDateDisplay(period1.to)} (${days1} days)<br>
                        <strong>${period2.label}</strong>: ${formatDateDisplay(period2.from)} ~ ${formatDateDisplay(period2.to)} (${days2} days)
                    </div>
                </div>
            `;
            
            const table = document.createElement('table');
            table.className = 'dashboard-table comparison-table';
            
            // Build header
            let headerHTML = '<thead><tr>';
            
            // Dimension columns
            tab.dimensions.forEach(dimId => {
                let dim;
                if (dimId === 'date_column') {
                    dim = { id: 'date_column', displayName: dateConfig.displayName };
                } else {
                    dim = dimensions.find(d => d.id === dimId);
                }
                if (dim) {
                    headerHTML += `<th rowspan="2">${dim.displayName}</th>`;
                }
            });
            
            // Metric column
            headerHTML += `<th rowspan="2">Metric</th>`;
            
            // Period columns with date range
            headerHTML += `
                <th style="text-align: center;">
                    <div style="font-weight: 700; margin-bottom: 4px;">${period1.label}</div>
                    <div style="font-size: 10px; font-weight: 500; opacity: 0.8;">
                        ${formatDateDisplay(period1.from)} ~ ${formatDateDisplay(period1.to)}
                    </div>
                </th>
            `;
            
            headerHTML += `
                <th style="text-align: center;">
                    <div style="font-weight: 700; margin-bottom: 4px;">${period2.label}</div>
                    <div style="font-size: 10px; font-weight: 500; opacity: 0.8;">
                        ${formatDateDisplay(period2.from)} ~ ${formatDateDisplay(period2.to)}
                    </div>
                </th>
            `;
            
            // Difference columns
            if (tab.comparisonOptions.showAbsolute) {
                headerHTML += `<th> Change</th>`;
            }
            if (tab.comparisonOptions.showPercentage) {
                headerHTML += `<th> Percent</th>`;
            }
            
            headerHTML += '</tr></thead>';
            table.innerHTML = headerHTML;
            
            const tbody = document.createElement('tbody');
            
            // Render comparison rows
            comparisonData.forEach((rowGroup, groupIndex) => {
                const dimensionValues = rowGroup.dimensions;
                const metricsData = rowGroup.metrics;
                
                tab.selectedMetrics.forEach((metricId, metricIndex) => {
                    const metric = metrics.find(m => m.id === metricId);
                    if (!metric) return;
                    
                    const tr = document.createElement('tr');
                    
                    // Dimension values (only show on first metric row)
                    if (metricIndex === 0) {
                        tab.dimensions.forEach((dimId, dimIdx) => {
                            const td = document.createElement('td');
                            td.rowSpan = tab.selectedMetrics.length;
                            td.textContent = dimensionValues[dimIdx] || '-';
                            td.style.fontWeight = '600';
                            td.style.background = '#fafbfc';
                            tr.appendChild(td);
                        });
                    }
                    
                    // Metric name
                    const metricNameTd = document.createElement('td');
                    metricNameTd.textContent = metric.displayName;
                    metricNameTd.style.fontWeight = '600';
                    metricNameTd.style.paddingLeft = '20px';
                    tr.appendChild(metricNameTd);
                    
                    // Period 1 value
                    const p1Td = document.createElement('td');
                    const p1Value = metricsData.period1[metricId];
                    p1Td.textContent = formatMetricValue(p1Value, metric);
                    tr.appendChild(p1Td);
                    
                    // Period 2 value
                    const p2Td = document.createElement('td');
                    const p2Value = metricsData.period2[metricId];
                    p2Td.textContent = formatMetricValue(p2Value, metric);
                    tr.appendChild(p2Td);
                    
                    // Calculate difference
                    const diff = p2Value - p1Value;
                    const diffPercent = p1Value !== 0 ? ((diff / p1Value) * 100) : 0;
                    
                    // Absolute difference
                    if (tab.comparisonOptions.showAbsolute) {
                        const diffTd = document.createElement('td');
                        const diffFormatted = formatMetricValue(Math.abs(diff), metric);
                        const sign = diff >= 0 ? '+' : '-';
                        diffTd.textContent = sign + diffFormatted;
                        diffTd.style.fontWeight = '700';
                        
                        if (tab.comparisonOptions.colorCoding) {
                            diffTd.style.color = diff >= 0 ? '#27ae60' : '#e74c3c';
                        }
                        
                        tr.appendChild(diffTd);
                    }
                    
                    // Percentage change
                    if (tab.comparisonOptions.showPercentage) {
                        const percentTd = document.createElement('td');
                        const sign = diffPercent >= 0 ? '+' : '';
                        percentTd.textContent = sign + diffPercent.toFixed(1) + '%';
                        percentTd.style.fontWeight = '700';
                        
                        if (tab.comparisonOptions.colorCoding) {
                            percentTd.style.color = diffPercent >= 0 ? '#27ae60' : '#e74c3c';
                        }
                        
                        tr.appendChild(percentTd);
                    }
                    
                    tbody.appendChild(tr);
                });
                
                // Add separator row between dimension groups
                if (groupIndex < comparisonData.length - 1) {
                    const separatorTr = document.createElement('tr');
                    separatorTr.innerHTML = '<td colspan="100" style="height: 8px; background: var(--light-gray);"></td>';
                    tbody.appendChild(separatorTr);
                }
            });
            
            table.appendChild(tbody);
            tableContainer.appendChild(table);
            container.appendChild(tableContainer);
        }
        
        function buildComparisonData(agg1, agg2, tab) {
            // Group by dimensions
            const groups = new Map();
            
            // Process period 1 data
            agg1.forEach(row => {
                const key = tab.dimensions.map(dimId => {
                    if (dimId === 'date_column') {
                        return row[dateConfig.sourceColumn];
                    }
                    const dim = dimensions.find(d => d.id === dimId);
                    return row[dim?.sourceColumn] || '';
                }).join('|');
                
                if (!groups.has(key)) {
                    groups.set(key, {
                        dimensions: tab.dimensions.map(dimId => {
                            if (dimId === 'date_column') {
                                return row[dateConfig.sourceColumn];
                            }
                            const dim = dimensions.find(d => d.id === dimId);
                            return row[dim?.sourceColumn] || '-';
                        }),
                        metrics: {
                            period1: {},
                            period2: {}
                        }
                    });
                }
                
                const group = groups.get(key);
                metrics.forEach((metric, idx) => {
                    group.metrics.period1[metric.id] = row[`metric_${idx}`] || 0;
                });
            });
            
            // Process period 2 data
            agg2.forEach(row => {
                const key = tab.dimensions.map(dimId => {
                    if (dimId === 'date_column') {
                        return row[dateConfig.sourceColumn];
                    }
                    const dim = dimensions.find(d => d.id === dimId);
                    return row[dim?.sourceColumn] || '';
                }).join('|');
                
                if (!groups.has(key)) {
                    groups.set(key, {
                        dimensions: tab.dimensions.map(dimId => {
                            if (dimId === 'date_column') {
                                return row[dateConfig.sourceColumn];
                            }
                            const dim = dimensions.find(d => d.id === dimId);
                            return row[dim?.sourceColumn] || '-';
                        }),
                        metrics: {
                            period1: {},
                            period2: {}
                        }
                    });
                }
                
                const group = groups.get(key);
                metrics.forEach((metric, idx) => {
                    group.metrics.period2[metric.id] = row[`metric_${idx}`] || 0;
                });
            });
            
            // Convert to array
            return Array.from(groups.values());
        }
        
        function groupDataByDimension(data, tab) {
            let groupByDim;
            
            if (tab.groupBy === 'date_column') {
                groupByDim = { id: 'date_column', sourceColumn: dateConfig.sourceColumn };
            } else {
                groupByDim = dimensions.find(d => d.id === tab.groupBy);
            }
            
            if (!groupByDim) return [];
            
            const groups = {};
            
            data.forEach(row => {
                const groupValue = row[groupByDim.sourceColumn] || '(empty)';
                if (!groups[groupValue]) {
                    groups[groupValue] = [];
                }
                groups[groupValue].push(row);
            });
            
            // Sort by group value A-Z
            const sortedGroups = Object.keys(groups).sort().map(key => ({
                value: key,
                data: groups[key]
            }));
            
            return sortedGroups;
        }

        function groupAggregatedDataByDimension(aggregatedData, tab) {
            let groupBySourceColumn;
            
            // Get source column of group by dimension
            if (tab.groupBy === 'date_column') {
                groupBySourceColumn = dateConfig.sourceColumn;
            } else {
                const groupByDim = dimensions.find(d => d.id === tab.groupBy);
                if (!groupByDim) return [];
                groupBySourceColumn = groupByDim.sourceColumn;
            }
            
            // Group aggregated data by the group by column
            const groups = {};
            
            aggregatedData.forEach(row => {
                const groupValue = row[groupBySourceColumn] || '(empty)';
                if (!groups[groupValue]) {
                    groups[groupValue] = [];
                }
                groups[groupValue].push(row);
            });
            
            // Sort by group value A-Z
            const sortedGroups = Object.keys(groups).sort().map(key => ({
                value: key,
                data: groups[key]
            }));
            
            return sortedGroups;
        }
        
        function renderTable(container, tab, groupValue, data) {
            const tableContainer = document.createElement('div');
            tableContainer.className = 'dashboard-table-container';
            
            const tableName = generateTableName(tab, groupValue);
            const tableId = `table_${tab.id}_${groupValue || 'main'}`;
            
            // Get or initialize pagination state
            if (!tablePaginationState.has(tableId)) {
                tablePaginationState.set(tableId, {
                    currentPage: 1,
                    pageSize: DEFAULT_PAGE_SIZE,
                    viewAll: false
                });
            }
            
            const paginationState = tablePaginationState.get(tableId);
            
            // Calculate pagination
            const totalRows = data.length;
            const totalPages = Math.ceil(totalRows / paginationState.pageSize);
            
            // Get data for current page
            let pageData;
            let showingFrom, showingTo;
            
            if (paginationState.viewAll) {
                pageData = data;
                showingFrom = 1;
                showingTo = totalRows;
            } else {
                const startIndex = (paginationState.currentPage - 1) * paginationState.pageSize;
                const endIndex = Math.min(startIndex + paginationState.pageSize, totalRows);
                pageData = data.slice(startIndex, endIndex);
                showingFrom = startIndex + 1;
                showingTo = endIndex;
            }
            
            tableContainer.innerHTML = `
                <div class="dashboard-table-header">
                    <span class="icon"></span>
                    <h3>${tableName}</h3>
                    <span style="font-size: 13px; color: var(--text-gray); margin-left: 10px;">
                        (${totalRows.toLocaleString()} rows)
                    </span>
                </div>
                ${tab.options.hideDuplicates ? '<div class="alert alert-info" style="margin: 10px 0; font-size: 12px;"><span</span><span>Sorting is disabled when "Hide Duplicates" is enabled</span></div>' : ''}
            `;
            
            const table = document.createElement('table');
            table.className = 'dashboard-table';
            
            if (dashboardSettings.display.stickyDimensions) {
                table.classList.add('sticky-dimensions');
            }
            if (dashboardSettings.display.alternateRowColors) {
                table.classList.add('alternate-rows');
            }
            
            let headerHTML = '<thead><tr>';
            
            let dimensionCount = 0;
            let leftPosition = 0;
            
            tab.dimensions.forEach((dimId, index) => {
                let dim;
                let isCreativeImage = false;
                
                if (dimId === 'date_column') {
                    dim = { id: 'date_column', displayName: dateConfig.displayName };
                } else if (dimId === 'creative_ad_name') {
                    dim = { id: 'creative_ad_name', displayName: 'Ad Name' };
                } else if (dimId === 'creative_file_name') {
                    dim = { id: 'creative_file_name', displayName: 'File Name' };
                } else if (dimId === 'creative_image') {
                    dim = { id: 'creative_image', displayName: 'Creative' };
                    isCreativeImage = true;
                } else if (dimId === 'creative_ad_format') {
                    dim = { id: 'creative_ad_format', displayName: 'Ad Format' };
                } else {
                    dim = dimensions.find(d => d.id === dimId);
                }
                
                if (dim) {
                    const stickyStyle = dashboardSettings.display.stickyDimensions 
                        ? `class="dimension-col" style="left: ${leftPosition}px;"` 
                        : '';
                    
                    const columnWidth = dashboardSettings.display.columnWidth === 'fixed' 
                        ? `style="width: ${dashboardSettings.display.fixedColumnWidth}px; min-width: ${dashboardSettings.display.fixedColumnWidth}px; max-width: ${dashboardSettings.display.fixedColumnWidth}px;"` 
                        : '';
                    
                    const title = dashboardSettings.display.showTooltips ? `title="${dim.displayName}"` : '';
                    
                    if (tab.options.hideDuplicates) {
                        headerHTML += `<th ${stickyStyle} ${columnWidth} ${title}>${dim.displayName}</th>`;
                    } else {
                        headerHTML += `<th ${stickyStyle} ${columnWidth} ${title} onclick="sortTable(this, '${dim.id}')" style="cursor: pointer;">${dim.displayName}</th>`;
                    }
                    
                    if (dashboardSettings.display.stickyDimensions) {
                        leftPosition += dashboardSettings.display.columnWidth === 'fixed' 
                            ? dashboardSettings.display.fixedColumnWidth 
                            : (isCreativeImage ? 80 : 150);
                    }
                    dimensionCount++;
                }
            });
            
            metrics.forEach(metric => {
                const columnWidth = dashboardSettings.display.columnWidth === 'fixed' 
                    ? `style="width: ${dashboardSettings.display.fixedColumnWidth}px; min-width: ${dashboardSettings.display.fixedColumnWidth}px; max-width: ${dashboardSettings.display.fixedColumnWidth}px;"` 
                    : '';
                
                const title = dashboardSettings.display.showTooltips ? `title="${metric.displayName}"` : '';
                
                if (tab.options.hideDuplicates) {
                    headerHTML += `<th ${columnWidth} ${title}>${metric.displayName}</th>`;
                } else {
                    headerHTML += `<th ${columnWidth} ${title} onclick="sortTable(this, '${metric.id}')" style="cursor: pointer;">${metric.displayName}</th>`;
                }
            });
            
            headerHTML += '</tr></thead>';
            table.innerHTML = headerHTML;
            
            const tbody = document.createElement('tbody');
            
            let previousRow = null;
            
            // FIX: Render pageData instead of all data
            pageData.forEach((rowData, rowIndex) => {
                const tr = document.createElement('tr');
                
                let leftPos = 0;
                
                tab.dimensions.forEach((dimId, dimIndex) => {
                    let dim;
                    let isCreativeImage = false;
                    
                    if (dimId === 'date_column') {
                        dim = { id: 'date_column', sourceColumn: dateConfig.sourceColumn };
                    } else if (dimId === 'creative_ad_name') {
                        dim = { id: 'creative_ad_name', sourceColumn: creativeConfig.adNameColumn };
                    } else if (dimId === 'creative_file_name') {
                        const col = creativeConfig.sameAsAdName ? creativeConfig.adNameColumn : creativeConfig.fileNameColumn;
                        dim = { id: 'creative_file_name', sourceColumn: col };
                    } else if (dimId === 'creative_image') {
                        isCreativeImage = true;
                    } else if (dimId === 'creative_ad_format') {
                        dim = { id: 'creative_ad_format', sourceColumn: creativeConfig.adFormatColumn };
                    } else {
                        dim = dimensions.find(d => d.id === dimId);
                    }
                    
                    if (isCreativeImage) {
                        const td = renderCreativeCell(rowData);
                        
                        if (dashboardSettings.display.stickyDimensions) {
                            td.classList.add('dimension-col');
                            td.style.left = `${leftPos}px`;
                            leftPos += 80;
                        }
                        
                        tr.appendChild(td);
                        return;
                    }
                    
                    if (dim) {
                        const td = document.createElement('td');
                        
                        if (dashboardSettings.display.stickyDimensions) {
                            td.classList.add('dimension-col');
                            td.style.left = `${leftPos}px`;
                            leftPos += dashboardSettings.display.columnWidth === 'fixed' 
                                ? dashboardSettings.display.fixedColumnWidth 
                                : 150;
                        }
                        
                        let value;
                        
                        if (dimId === 'date_column') {
                            value = formatDateValue(rowData[dim.sourceColumn], dateConfig.format);
                        } else {
                            value = rowData[dim.sourceColumn] || '-';
                        }
                        
                        if (dashboardSettings.display.showTooltips) {
                            td.title = value;
                        }
                        
                        if (tab.options.hideDuplicates && previousRow) {
                            let previousValue;
                            if (dimId === 'date_column') {
                                previousValue = formatDateValue(previousRow[dim.sourceColumn], dateConfig.format);
                            } else {
                                previousValue = previousRow[dim.sourceColumn] || '-';
                            }
                            
                            if (value === previousValue) {
                                td.textContent = '';
                            } else {
                                td.textContent = value;
                            }
                        } else {
                            td.textContent = value;
                        }
                        
                        tr.appendChild(td);
                    }
                });
                
                metrics.forEach((metric, metricIndex) => {
                    const td = document.createElement('td');
                    const value = rowData[`metric_${metricIndex}`];
                    
                    const formatted = formatMetricValue(value, metric);
                    
                    if (dashboardSettings.display.showTooltips) {
                        td.title = `${metric.displayName}: ${formatted}`;
                    }
                    
                    if (metric.format.dataBar.enabled) {
                        const maxValue = Math.max(...data.map(r => r[`metric_${metricIndex}`] || 0));
                        const percentage = maxValue > 0 ? (value / maxValue) * 100 : 0;
                        
                        // FIX: Generate background based on style
                        let barBackground;
                        if (metric.format.dataBar.style === 'gradient') {
                            // Gradient from transparent to color
                            barBackground = `linear-gradient(to right, transparent, ${metric.format.dataBar.color})`;
                        } else {
                            // Solid color
                            barBackground = metric.format.dataBar.color;
                        }
                        
                        td.className = 'data-bar-cell';
                        td.innerHTML = `
                            <div class="data-bar" style="width: ${percentage}%; background: ${barBackground};"></div>
                            <span class="data-bar-value">${formatted}</span>
                        `;
                    } else {
                        td.textContent = formatted;
                    }
                    
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
                
                if (tab.options.hideDuplicates) {
                    previousRow = rowData;
                }
            });
            
            if (tab.options.showTotal && pageData.length > 0) {
                const totalRow = calculateTotalRow(data, tab); // Use full data for total
                const tr = document.createElement('tr');
                tr.className = 'total-row';
                
                let firstCol = true;
                let leftPos = 0;
                
                tab.dimensions.forEach(dimId => {
                    let dim;
                    let isCreativeImage = false;
                    
                    if (dimId === 'date_column') {
                        dim = { id: 'date_column' };
                    } else if (dimId === 'creative_ad_name') {
                        dim = { id: 'creative_ad_name' };
                    } else if (dimId === 'creative_file_name') {
                        dim = { id: 'creative_file_name' };
                    } else if (dimId === 'creative_image') {
                        isCreativeImage = true;
                    } else if (dimId === 'creative_ad_format') {
                        dim = { id: 'creative_ad_format' };
                    } else {
                        dim = dimensions.find(d => d.id === dimId);
                    }
                    
                    if (isCreativeImage) {
                        const td = document.createElement('td');
                        td.textContent = '';
                        
                        if (dashboardSettings.display.stickyDimensions) {
                            td.classList.add('dimension-col');
                            td.style.left = `${leftPos}px`;
                            td.style.background = dashboardSettings.theme.totalRowColor;
                            leftPos += 80;
                        }
                        
                        tr.appendChild(td);
                        return;
                    }
                    
                    if (dim) {
                        const td = document.createElement('td');
                        
                        if (dashboardSettings.display.stickyDimensions) {
                            td.classList.add('dimension-col');
                            td.style.left = `${leftPos}px`;
                            td.style.background = dashboardSettings.theme.totalRowColor;
                            leftPos += dashboardSettings.display.columnWidth === 'fixed' 
                                ? dashboardSettings.display.fixedColumnWidth 
                                : 150;
                        }
                        
                        if (firstCol) {
                            td.textContent = 'Total';
                            td.style.fontWeight = '700';
                            firstCol = false;
                        } else {
                            td.textContent = '';
                        }
                        tr.appendChild(td);
                    }
                });
                
                metrics.forEach((metric, metricIndex) => {
                    const td = document.createElement('td');
                    const value = totalRow[`metric_${metricIndex}`];
                    const formatted = formatMetricValue(value, metric);
                    td.textContent = formatted;
                    
                    if (dashboardSettings.display.showTooltips) {
                        td.title = `Total ${metric.displayName}: ${formatted}`;
                    }
                    
                    tr.appendChild(td);
                });
                
                tbody.appendChild(tr);
            }
            
            table.appendChild(tbody);
            tableContainer.appendChild(table);
            
            // FIX: Add pagination controls
            if (totalRows > DEFAULT_PAGE_SIZE) {
                const paginationDiv = renderPaginationControls(
                    tableId, 
                    paginationState.currentPage, 
                    totalPages, 
                    showingFrom, 
                    showingTo, 
                    totalRows,
                    paginationState.viewAll,
                    tab,
                    groupValue,
                    data
                );
                tableContainer.appendChild(paginationDiv);
            }
            
            container.appendChild(tableContainer);
        }

        function renderCreativeCell(rowData) {
            const td = document.createElement('td');
            td.className = 'creative-cell';
            
            const adFormat = rowData[creativeConfig.adFormatColumn];
            const imageUrl = getCreativeImageUrl(rowData, adFormat);
            
            if (!imageUrl) {
                td.innerHTML = '<div class="no-image">[No Image]</div>';
                return td;
            }
            
            // Get thumbnail size
            const size = thumbnailSizes[creativeConfig.thumbnailSize] || thumbnailSizes.medium;
            
            // Check if video
            const isVideo = adFormat === '' || adFormat === 'video' || adFormat === 'Video';
            
            const wrapper = document.createElement('div');
            wrapper.className = 'creative-wrapper';
            wrapper.onclick = function(e) {
                e.stopPropagation();
                toggleImageZoom(imageUrl, isVideo, rowData[creativeConfig.adNameColumn]);
            };
            
            const img = document.createElement('img');
            img.src = imageUrl;
            img.loading = 'lazy';
            img.className = 'creative-thumbnail';
            img.style.width = size.w + 'px';
            img.style.height = size.h + 'px';
            img.onerror = function() {
                this.parentElement.innerHTML = '<div class="no-image">[No Image]</div>';
            };
            
            wrapper.appendChild(img);
            
            if (isVideo) {
                const badge = document.createElement('div');
                badge.className = 'video-badge';
                badge.textContent = '';
                wrapper.appendChild(badge);
            }
            
            td.appendChild(wrapper);
            
            return td;
        }
        
        function getCreativeImageUrl(rowData, adFormat) {
            // Priority: thumbnail_url > static_url/video_url based on format
            
            // If thumbnail_url exists, use it
            if (creativeConfig.thumbnailUrlColumn && rowData[creativeConfig.thumbnailUrlColumn]) {
                return rowData[creativeConfig.thumbnailUrlColumn];
            }
            
            // Otherwise, use format-specific URL
            const isVideo = adFormat === '' || adFormat === 'video' || adFormat === 'Video';
            
            if (isVideo) {
                return rowData[creativeConfig.videoUrlColumn] || '';
            } else {
                return rowData[creativeConfig.staticUrlColumn] || '';
            }
        }
        
        function toggleImageZoom(url, isVideo, adName) {
            // If already zoomed, close it
            if (zoomedImage) {
                zoomedImage.remove();
                zoomedImage = null;
                return;
            }
            
            // Create zoom overlay
            const overlay = document.createElement('div');
            overlay.className = 'image-zoom-overlay';
            
            const content = document.createElement('div');
            content.style.cssText = 'text-align: center; position: relative;';
            
            if (isVideo) {
                content.innerHTML = `
                    <div style="position: relative; display: inline-block;">
                        <img src="${url}" style="max-width: 90vw; max-height: 75vh; border-radius: 8px; box-shadow: var(--shadow-lg);" 
                             onclick="event.stopPropagation();" />
                        <div class="video-badge-large"> Video</div>
                    </div>
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="event.stopPropagation(); window.open('${url}', '_blank')">
                            <span></span>
                            <span>Open Video in New Tab</span>
                        </button>
                        <button class="btn btn-secondary" onclick="event.stopPropagation(); copyToClipboard('${url}')" style="margin-left: 10px;">
                            <span></span>
                            <span>Copy URL</span>
                        </button>
                    </div>
                    <p style="color: white; margin-top: 10px; font-size: 14px; opacity: 0.8;">
                        ${adName || 'Creative'} | Click anywhere to close
                    </p>
                `;
            } else {
                content.innerHTML = `
                    <img src="${url}" style="max-width: 90vw; max-height: 75vh; border-radius: 8px; box-shadow: var(--shadow-lg);" 
                         onclick="event.stopPropagation();" />
                    <div style="margin-top: 20px;">
                        <button class="btn btn-primary" onclick="event.stopPropagation(); window.open('${url}', '_blank')">
                            <span></span>
                            <span>Open in New Tab</span>
                        </button>
                        <button class="btn btn-secondary" onclick="event.stopPropagation(); copyToClipboard('${url}')" style="margin-left: 10px;">
                            <span></span>
                            <span>Copy URL</span>
                        </button>
                    </div>
                    <p style="color: white; margin-top: 10px; font-size: 14px; opacity: 0.8;">
                        ${adName || 'Creative'} | Click anywhere to close
                    </p>
                `;
            }
            
            overlay.appendChild(content);
            
            overlay.onclick = function(e) {
                if (e.target === this) {
                    this.remove();
                    zoomedImage = null;
                }
            };
            
            document.body.appendChild(overlay);
            zoomedImage = overlay;
        }
        
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                showModal('', 'Copied', 'URL copied to clipboard!');
            }).catch(() => {
                showModal('', 'Error', 'Failed to copy URL');
            });
        }
        
        function generateTableName(tab, groupValue) {
            if (!tab.groupBy) {
                return tab.dimensions
                    .map(dimId => {
                        if (dimId === 'date_column') {
                            return dateConfig.displayName;
                        } else if (dimId === 'creative_ad_name') {
                            return 'Ad Name';
                        } else if (dimId === 'creative_file_name') {
                            return 'File Name';
                        } else if (dimId === 'creative_image') {
                            return 'Creative';
                        } else if (dimId === 'creative_ad_format') {
                            return 'Ad Format';
                        }
                        const dim = dimensions.find(d => d.id === dimId);
                        return dim?.displayName;
                    })
                    .filter(name => name)
                    .join(' x ');
            } else {
                return tab.dimensions
                    .map(dimId => {
                        if (dimId === tab.groupBy) {
                            return groupValue;
                        }
                        if (dimId === 'date_column') {
                            return dateConfig.displayName;
                        } else if (dimId === 'creative_ad_name') {
                            return 'Ad Name';
                        } else if (dimId === 'creative_file_name') {
                            return 'File Name';
                        } else if (dimId === 'creative_image') {
                            return 'Creative';
                        } else if (dimId === 'creative_ad_format') {
                            return 'Ad Format';
                        }
                        const dim = dimensions.find(d => d.id === dimId);
                        return dim?.displayName;
                    })
                    .filter(name => name)
                    .join(' x ');
            }
        }

        function renderPaginationControls(tableId, currentPage, totalPages, showingFrom, showingTo, totalRows, viewAll, tab, groupValue, data) {
            const div = document.createElement('div');
            div.className = 'pagination-container';
            
            // Left: Info
            const info = document.createElement('div');
            info.className = 'pagination-info';
            info.innerHTML = `
                Showing <strong>${showingFrom.toLocaleString()}</strong> - <strong>${showingTo.toLocaleString()}</strong> of <strong>${totalRows.toLocaleString()}</strong> rows
            `;
            div.appendChild(info);
            
            // Right: Controls
            const controls = document.createElement('div');
            controls.className = 'pagination-controls';
            
            if (!viewAll) {
                // Previous button
                const prevBtn = document.createElement('button');
                prevBtn.className = 'pagination-btn';
                prevBtn.innerHTML = ' Prev';
                prevBtn.disabled = currentPage === 1;
                prevBtn.onclick = () => changePage(tableId, currentPage - 1, tab, groupValue, data);
                controls.appendChild(prevBtn);
                
                // Page numbers
                const pageNumbers = generatePageNumbers(currentPage, totalPages);
                pageNumbers.forEach(page => {
                    if (page === '...') {
                        const ellipsis = document.createElement('span');
                        ellipsis.className = 'pagination-ellipsis';
                        ellipsis.textContent = '...';
                        controls.appendChild(ellipsis);
                    } else {
                        const pageBtn = document.createElement('button');
                        pageBtn.className = 'pagination-btn';
                        if (page === currentPage) {
                            pageBtn.classList.add('active');
                        }
                        pageBtn.textContent = page;
                        pageBtn.onclick = () => changePage(tableId, page, tab, groupValue, data);
                        controls.appendChild(pageBtn);
                    }
                });
                
                // Next button
                const nextBtn = document.createElement('button');
                nextBtn.className = 'pagination-btn';
                nextBtn.innerHTML = 'Next ';
                nextBtn.disabled = currentPage === totalPages;
                nextBtn.onclick = () => changePage(tableId, currentPage + 1, tab, groupValue, data);
                controls.appendChild(nextBtn);
                
                // View All button
                const viewAllBtn = document.createElement('button');
                viewAllBtn.className = 'pagination-btn view-all';
                viewAllBtn.innerHTML = '<span></span> <span>View All</span>';
                viewAllBtn.onclick = () => toggleViewAll(tableId, tab, groupValue, data);
                controls.appendChild(viewAllBtn);
            } else {
                // Show Pagination button (when viewing all)
                const showPaginationBtn = document.createElement('button');
                showPaginationBtn.className = 'pagination-btn';
                showPaginationBtn.innerHTML = '<span></span> <span>Show Pagination</span>';
                showPaginationBtn.onclick = () => toggleViewAll(tableId, tab, groupValue, data);
                controls.appendChild(showPaginationBtn);
            }
            
            div.appendChild(controls);
            
            return div;
        }
        
        function generatePageNumbers(currentPage, totalPages) {
            const pages = [];
            const maxVisible = 7;
            
            if (totalPages <= maxVisible) {
                for (let i = 1; i <= totalPages; i++) {
                    pages.push(i);
                }
            } else {
                if (currentPage <= 4) {
                    for (let i = 1; i <= 5; i++) pages.push(i);
                    pages.push('...');
                    pages.push(totalPages);
                } else if (currentPage >= totalPages - 3) {
                    pages.push(1);
                    pages.push('...');
                    for (let i = totalPages - 4; i <= totalPages; i++) pages.push(i);
                } else {
                    pages.push(1);
                    pages.push('...');
                    for (let i = currentPage - 1; i <= currentPage + 1; i++) pages.push(i);
                    pages.push('...');
                    pages.push(totalPages);
                }
            }
            
            return pages;
        }
        
        function changePage(tableId, newPage, tab, groupValue, data) {
            const state = tablePaginationState.get(tableId);
            state.currentPage = newPage;
            
            // Re-render this table only
            const container = document.getElementById('dashboardContent');
            container.innerHTML = '';
            
            // Re-render all tables (to maintain order)
            const dataToUse = filteredData || csvData.rows;
            
            if (tab.groupBy) {
                const groupedData = groupDataByDimension(dataToUse, tab);
                groupedData.forEach(group => {
                    const groupTableId = `table_${tab.id}_${group.value}`;
                    const aggregated = aggregateData(tab, null, group.data);
                    renderTable(container, tab, group.value, aggregated);
                });
            } else {
                const aggregated = aggregateData(tab, null, dataToUse);
                renderTable(container, tab, null, aggregated);
            }
        }
        
        function toggleViewAll(tableId, tab, groupValue, data) {
            const state = tablePaginationState.get(tableId);
            state.viewAll = !state.viewAll;
            
            if (state.viewAll) {
                showModal('', 'View All Rows', 
                    `This will load all ${data.length} rows and may cause performance issues. Continue?`,
                    function() {
                        // Re-render
                        const container = document.getElementById('dashboardContent');
                        container.innerHTML = '';
                        
                        const dataToUse = filteredData || csvData.rows;
                        
                        if (tab.groupBy) {
                            const groupedData = groupDataByDimension(dataToUse, tab);
                            groupedData.forEach(group => {
                                const aggregated = aggregateData(tab, null, group.data);
                                renderTable(container, tab, group.value, aggregated);
                            });
                        } else {
                            const aggregated = aggregateData(tab, null, dataToUse);
                            renderTable(container, tab, null, aggregated);
                        }
                    },
                    function() {
                        // Cancel - reset viewAll
                        state.viewAll = false;
                    }
                );
            } else {
                // Back to pagination
                state.currentPage = 1;
                
                const container = document.getElementById('dashboardContent');
                container.innerHTML = '';
                
                const dataToUse = filteredData || csvData.rows;
                
                if (tab.groupBy) {
                    const groupedData = groupDataByDimension(dataToUse, tab);
                    groupedData.forEach(group => {
                        const aggregated = aggregateData(tab, null, group.data);
                        renderTable(container, tab, group.value, aggregated);
                    });
                } else {
                    const aggregated = aggregateData(tab, null, dataToUse);
                    renderTable(container, tab, null, aggregated);
                }
            }
        }
        
        function aggregateData(tab, limit = null, dataSource = null) {
            const data = dataSource || csvData.rows;
            
            // FIX: DON'T apply filters here - only filter dimensions/date range
            // Metric filters should be applied AFTER aggregation
            
            // Separate dimension filters and metric filters
            const dimensionFilters = tab.filters.filter(f => {
                if (f.column === 'date_column') return true;
                const dim = dimensions.find(d => d.id === f.column);
                return !!dim;
            });
            
            // Apply ONLY dimension/date filters before aggregation
            let filteredRows = data;
            if (dimensionFilters.length > 0) {
                filteredRows = applyFilters(data, dimensionFilters);
            }
            
            // Use Map for better performance
            const groups = new Map();

            // FIX: If no dimensions (comparison tab without dimensions), group all
            if (!tab.dimensions || tab.dimensions.length === 0) {
                // Aggregate all data into one row
                const rowData = {};
                
                metrics.forEach((metric, metricIndex) => {
                    if (metric.type === 'base') {
                        rowData[`metric_${metricIndex}`] = calculateBaseMetric(filteredRows, metric.sourceColumn);
                    } else {
                        const metricValues = {};
                        metrics.filter(m => m.type === 'base').forEach(m => {
                            metricValues[`[${m.displayName}]`] = calculateBaseMetric(filteredRows, m.sourceColumn);
                        });
                        rowData[`metric_${metricIndex}`] = calculateFormula(metric.formula, metricValues);
                    }
                });
                
                return [rowData];
            }
            
            filteredRows.forEach(row => {
                // Build key from dimension values
                const keyParts = [];
                tab.dimensions.forEach(dimId => {
                    let value;
                    
                    if (dimId === 'date_column') {
                        value = row[dateConfig.sourceColumn] || '';
                    } else if (dimId === 'creative_ad_name') {
                        value = row[creativeConfig.adNameColumn] || '';
                    } else if (dimId === 'creative_file_name') {
                        const col = creativeConfig.sameAsAdName ? creativeConfig.adNameColumn : creativeConfig.fileNameColumn;
                        value = row[col] || '';
                    } else if (dimId === 'creative_image') {
                        // For grouping, use file name as key (not image URL)
                        const col = creativeConfig.sameAsAdName ? creativeConfig.adNameColumn : creativeConfig.fileNameColumn;
                        value = row[col] || '';
                    } else if (dimId === 'creative_ad_format') {
                        value = row[creativeConfig.adFormatColumn] || '';
                    } else {
                        const dim = dimensions.find(d => d.id === dimId);
                        value = row[dim.sourceColumn] || '';
                    }
                    
                    keyParts.push(value);
                });
                const key = keyParts.join('|');
                
                if (!groups.has(key)) {
                    groups.set(key, {
                        dimensions: keyParts,
                        rows: []
                    });
                }
                groups.get(key).rows.push(row);
            });
            
            // Calculate metrics for each group
            const result = [];
            
            groups.forEach(group => {
                const rowData = {};
                
                // Add dimension values
                tab.dimensions.forEach((dimId, index) => {
                    if (dimId === 'date_column') {
                        rowData[dateConfig.sourceColumn] = group.dimensions[index];
                    } else if (dimId === 'creative_ad_name') {
                        rowData[creativeConfig.adNameColumn] = group.dimensions[index];
                    } else if (dimId === 'creative_file_name') {
                        const col = creativeConfig.sameAsAdName ? creativeConfig.adNameColumn : creativeConfig.fileNameColumn;
                        rowData[col] = group.dimensions[index];
                    } else if (dimId === 'creative_image') {
                        // Store image URLs from first row in group
                        if (group.rows.length > 0) {
                            const firstRow = group.rows[0];
                            rowData[creativeConfig.adFormatColumn] = firstRow[creativeConfig.adFormatColumn];
                            if (creativeConfig.thumbnailUrlColumn) {
                                rowData[creativeConfig.thumbnailUrlColumn] = firstRow[creativeConfig.thumbnailUrlColumn];
                            }
                            if (creativeConfig.staticUrlColumn) {
                                rowData[creativeConfig.staticUrlColumn] = firstRow[creativeConfig.staticUrlColumn];
                            }
                            if (creativeConfig.videoUrlColumn) {
                                rowData[creativeConfig.videoUrlColumn] = firstRow[creativeConfig.videoUrlColumn];
                            }
                        }
                    } else if (dimId === 'creative_ad_format') {
                        rowData[creativeConfig.adFormatColumn] = group.dimensions[index];
                    } else {
                        const dim = dimensions.find(d => d.id === dimId);
                        if (dim) {
                            rowData[dim.sourceColumn] = group.dimensions[index];
                        }
                    }
                });
                
                // Calculate metrics
                metrics.forEach((metric, metricIndex) => {
                    if (metric.type === 'base') {
                        rowData[`metric_${metricIndex}`] = calculateBaseMetric(group.rows, metric.sourceColumn);
                    } else {
                        const metricValues = {};
                        metrics.filter(m => m.type === 'base').forEach(m => {
                            metricValues[`[${m.displayName}]`] = calculateBaseMetric(group.rows, m.sourceColumn);
                        });
                        rowData[`metric_${metricIndex}`] = calculateFormula(metric.formula, metricValues);
                    }
                });
                
                result.push(rowData);
            });
            
            // Clear map to free memory
            groups.clear();
            
            // FIX: Sort by date if date column exists
            const hasDateColumn = tab.dimensions.includes('date_column');
            if (hasDateColumn) {
                result.sort((a, b) => {
                    const dateA = a[dateConfig.sourceColumn] || '';
                    const dateB = b[dateConfig.sourceColumn] || '';
                    return dateA.localeCompare(dateB);
                });
            }
            
            // FIX: Apply METRIC filters AFTER aggregation
            const metricFilters = tab.filters.filter(f => {
                if (f.column === 'date_column') return false;
                const dim = dimensions.find(d => d.id === f.column);
                if (dim) return false;
                return true; // It's a metric filter
            });
            
            let finalResult = result;
            if (metricFilters.length > 0) {
                finalResult = applyMetricFilters(result, metricFilters);
            }
            
            if (limit && finalResult.length > limit) {
                return finalResult.slice(0, limit);
            }
            
            return finalResult;
        }
        
        function applyFilters(data, filters) {
            if (!filters || filters.length === 0) return data;
            
            return data.filter(row => {
                let result = true;
                
                filters.forEach((filter, index) => {
                    const column = filter.column;
                    let value;
                    let columnType = 'text';
                    
                    // Get value from row (only dimensions and date)
                    if (column === 'date_column') {
                        value = row[dateConfig.sourceColumn];
                        columnType = 'date';
                    } else {
                        const dim = dimensions.find(d => d.id === column);
                        if (dim) {
                            value = row[dim.sourceColumn];
                            columnType = 'text';
                        } else {
                            // Skip metric filters here (handled after aggregation)
                            return;
                        }
                    }
                    
                    // Apply operator
                    const operator = filter.operator;
                    const filterValue = filter.value;
                    const filterValueTo = filter.valueTo;
                    
                    let conditionResult = true;
                    
                    if (columnType === 'text') {
                        const strValue = String(value || '');
                        const strFilter = String(filterValue || '');
                        
                        switch(operator) {
                            case 'equals': conditionResult = strValue === strFilter; break;
                            case 'not_equals': conditionResult = strValue !== strFilter; break;
                            case 'contains': conditionResult = strValue.toLowerCase().includes(strFilter.toLowerCase()); break;
                            case 'not_contains': conditionResult = !strValue.toLowerCase().includes(strFilter.toLowerCase()); break;
                            case 'starts_with': conditionResult = strValue.toLowerCase().startsWith(strFilter.toLowerCase()); break;
                            case 'ends_with': conditionResult = strValue.toLowerCase().endsWith(strFilter.toLowerCase()); break;
                            default: conditionResult = true;
                        }
                    } else if (columnType === 'date') {
                        const dateValue = String(value || '');
                        const dateFilter = String(filterValue || '');
                        const dateFilterTo = String(filterValueTo || '');
                        
                        switch(operator) {
                            case '=': conditionResult = dateValue === dateFilter; break;
                            case '>': conditionResult = dateValue > dateFilter; break;
                            case '<': conditionResult = dateValue < dateFilter; break;
                            case '>=': conditionResult = dateValue >= dateFilter; break;
                            case '<=': conditionResult = dateValue <= dateFilter; break;
                            case 'between': conditionResult = dateValue >= dateFilter && dateValue <= dateFilterTo; break;
                            default: conditionResult = true;
                        }
                    }
                    
                    // Apply AND/OR logic
                    if (index === 0) {
                        result = conditionResult;
                    } else {
                        const logic = filter.logic || 'AND';
                        if (logic === 'AND') {
                            result = result && conditionResult;
                        } else {
                            result = result || conditionResult;
                        }
                    }
                });
                
                return result;
            });
        }

        function applyMetricFilters(aggregatedData, filters) {
            if (!filters || filters.length === 0) return aggregatedData;
            
            return aggregatedData.filter(row => {
                let result = true;
                
                filters.forEach((filter, index) => {
                    const column = filter.column;
                    
                    // Find metric
                    const metricIndex = metrics.findIndex(m => m.id === column);
                    if (metricIndex === -1) return;
                    
                    const value = row[`metric_${metricIndex}`];
                    
                    // Apply operator
                    const operator = filter.operator;
                    const filterValue = parseFloat(filter.value);
                    const filterValueTo = parseFloat(filter.valueTo);
                    
                    let conditionResult = true;
                    
                    if (isNaN(value)) {
                        conditionResult = false;
                    } else if (isNaN(filterValue) && operator !== 'between') {
                        conditionResult = true;
                    } else if (operator === 'between' && (isNaN(filterValue) || isNaN(filterValueTo))) {
                        conditionResult = true;
                    } else {
                        switch(operator) {
                            case '=': conditionResult = value === filterValue; break;
                            case '>': conditionResult = value > filterValue; break;
                            case '<': conditionResult = value < filterValue; break;
                            case '>=': conditionResult = value >= filterValue; break;
                            case '<=': conditionResult = value <= filterValue; break;
                            case 'between': conditionResult = value >= filterValue && value <= filterValueTo; break;
                            default: conditionResult = true;
                        }
                    }
                    
                    // Apply AND/OR logic
                    if (index === 0) {
                        result = conditionResult;
                    } else {
                        const logic = filter.logic || 'AND';
                        if (logic === 'AND') {
                            result = result && conditionResult;
                        } else {
                            result = result || conditionResult;
                        }
                    }
                });
                
                return result;
            });
        }
        
        function calculateBaseMetric(rows, columnName) {
            return rows.reduce((sum, row) => {
                const value = parseFloat(row[columnName]) || 0;
                return sum + value;
            }, 0);
        }
        
        function calculateFormula(formula, metricValues) {
            let result = 0;
            let currentOp = null;
            
            formula.forEach(token => {
                if (token.type === 'metric') {
                    const value = metricValues[token.value] || 0;
                    if (currentOp === null) result = value;
                    else if (currentOp === '+') result += value;
                    else if (currentOp === '-') result -= value;
                    else if (currentOp === '*') result *= value;
                    else if (currentOp === '/') result = value !== 0 ? result / value : 0;
                } else if (token.type === 'number') {
                    const value = parseFloat(token.value);
                    if (currentOp === null) result = value;
                    else if (currentOp === '+') result += value;
                    else if (currentOp === '-') result -= value;
                    else if (currentOp === '*') result *= value;
                    else if (currentOp === '/') result = value !== 0 ? result / value : 0;
                } else if (token.type === 'operator') {
                    currentOp = token.value === '' ? '*' : token.value;
                }
            });
            
            return result;
        }
        
        function calculateTotalRow(data, tab) {
            const totalRow = {};
            
            metrics.forEach((metric, metricIndex) => {
                const sum = data.reduce((acc, row) => {
                    return acc + (row[`metric_${metricIndex}`] || 0);
                }, 0);
                totalRow[`metric_${metricIndex}`] = sum;
            });
            
            return totalRow;
        }
        
        function formatMetricValue(value, metric) {
            if (value === null || value === undefined || isNaN(value)) {
                return '-';
            }
            
            const decimals = metric.format.decimals;
            let formatted = value.toFixed(decimals);
            
            // FIX: Apply thousand separator based on metric setting
            if (metric.format.thousandSeparator !== false) {
                const parts = formatted.split('.');
                parts[0] = parts[0].replace(/\B(?=(\d{3})+(?!\d))/g, ',');
                formatted = parts.join('.');
            }
            
            if (metric.format.type === 'percentage') {
                return formatted + '%';
            } else if (metric.format.type === 'currency') {
                return metric.format.currency + formatted;
            } else {
                return formatted;
            }
        }

        function formatDateValue(dateString, format) {
            if (!dateString) return '-';
            
            // Parse date (assume input is YYYY-MM-DD or YYYY/MM/DD)
            const parts = dateString.split(/[-/]/);
            if (parts.length !== 3) return dateString;
            
            const year = parts[0];
            const month = parts[1];
            const day = parts[2];
            
            // Format based on config
            switch(format) {
                case 'YYYY/MM/DD':
                    return `${year}/${month}/${day}`;
                case 'YYYY-MM-DD':
                    return `${year}-${month}-${day}`;
                case 'DD/MM/YYYY':
                    return `${day}/${month}/${year}`;
                case 'MM/DD/YYYY':
                    return `${month}/${day}/${year}`;
                case 'YYYYMMDD':
                    return `${year}${month}${day}`;
                default:
                    return dateString;
            }
        }

        function normalizeDateString(dateStr) {
            if (!dateStr) return '';
            
            // Try to parse date and return YYYY-MM-DD format
            const parts = dateStr.split(/[-/]/);
            if (parts.length !== 3) return dateStr;
            
            let year, month, day;
            
            // Detect format
            if (parts[0].length === 4) {
                // YYYY-MM-DD or YYYY/MM/DD
                year = parts[0];
                month = parts[1].padStart(2, '0');
                day = parts[2].padStart(2, '0');
            } else if (parts[2].length === 4) {
                // DD-MM-YYYY or DD/MM/YYYY or MM/DD/YYYY
                // Assume DD/MM/YYYY (European format)
                day = parts[0].padStart(2, '0');
                month = parts[1].padStart(2, '0');
                year = parts[2];
            } else {
                // Cannot parse, return as-is
                return dateStr;
            }
            
            return `${year}-${month}-${day}`;
        }
        
        function sortTable(th, columnId) {
            const table = th.closest('table');
            const tbody = table.querySelector('tbody');
            const rows = Array.from(tbody.querySelectorAll('tr:not(.total-row)'));
            const totalRow = tbody.querySelector('tr.total-row');
            
            const columnIndex = Array.from(th.parentNode.children).indexOf(th);
            
            // Determine sort direction
            let isAsc = true;
            if (th.classList.contains('sorted-asc')) {
                isAsc = false;
                th.classList.remove('sorted-asc');
                th.classList.add('sorted-desc');
            } else {
                // Remove all sorted classes from siblings
                Array.from(th.parentNode.children).forEach(sibling => {
                    sibling.classList.remove('sorted-asc', 'sorted-desc');
                });
                th.classList.add('sorted-asc');
            }
            
            // Sort rows
            rows.sort((a, b) => {
                const aCell = a.children[columnIndex];
                const bCell = b.children[columnIndex];
                
                // FIX: Use originalValue if exists, otherwise use textContent
                const aValue = (aCell.dataset.originalValue || aCell.textContent).trim();
                const bValue = (bCell.dataset.originalValue || bCell.textContent).trim();
                
                // Try to parse as number
                const aNum = parseFloat(aValue.replace(/[^0-9.-]/g, ''));
                const bNum = parseFloat(bValue.replace(/[^0-9.-]/g, ''));
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    return isAsc ? aNum - bNum : bNum - aNum;
                } else {
                    return isAsc ? aValue.localeCompare(bValue) : bValue.localeCompare(aValue);
                }
            });
            
            // Re-append rows
            tbody.innerHTML = '';
            rows.forEach(row => tbody.appendChild(row));
            if (totalRow) tbody.appendChild(totalRow);
        }
        
        // ========================================
        // MODAL & UTILITIES
        // ========================================
        
        function showModal(icon, title, message, onConfirm, onCancel, confirmText = 'OK', cancelText = 'Cancel') {
            const overlay = document.getElementById('modalOverlay');
            const modalIcon = document.getElementById('modalIcon');
            const modalTitle = document.getElementById('modalTitle');
            const modalBody = document.getElementById('modalBody');
            const modalFooter = document.getElementById('modalFooter');
            
            modalIcon.textContent = icon;
            modalTitle.textContent = title;
            
            if (message.includes('<')) {
                modalBody.innerHTML = message;
            } else {
                modalBody.textContent = message;
            }
            
            overlay.classList.add('active');
            
            if (onConfirm || onCancel) {
                modalFooter.innerHTML = `
                    ${onCancel ? `<button class="btn btn-secondary" onclick="closeModal(); modalCancelCallback()">${cancelText}</button>` : ''}
                    <button class="btn btn-primary" onclick="closeModal(); ${onConfirm ? 'modalConfirmCallback()' : ''}">${confirmText}</button>
                `;
                
                if (onConfirm) window.modalConfirmCallback = onConfirm;
                if (onCancel) window.modalCancelCallback = onCancel;
            } else {
                modalFooter.innerHTML = `
                    <button class="btn btn-primary" onclick="closeModal()">${confirmText}</button>
                `;
            }
        }

        // ========================================
        // SETTINGS MODAL
        // ========================================
        
        function openSettingsModal() {
            const modal = document.getElementById('settingsModalOverlay');
            
            // Load current settings into form
            document.getElementById('settingStickyDim').checked = dashboardSettings.display.stickyDimensions;
            document.getElementById('settingTooltips').checked = dashboardSettings.display.showTooltips;
            document.getElementById('settingAlternateRows').checked = dashboardSettings.display.alternateRowColors;
            
            const columnWidthRadio = document.querySelector(`input[name="settingColumnWidth"][value="${dashboardSettings.display.columnWidth}"]`);
            if (columnWidthRadio) columnWidthRadio.checked = true;
            
            document.getElementById('settingFixedWidth').value = dashboardSettings.display.fixedColumnWidth;
            
            // Show/hide fixed width input
            toggleFixedWidthInput();
            
            // Theme settings
            document.getElementById('settingPrimaryColor').value = dashboardSettings.theme.primaryColor;
            document.getElementById('settingHeaderBg').value = dashboardSettings.theme.headerBackground;
            document.getElementById('settingTotalRowColor').value = dashboardSettings.theme.totalRowColor;
            
            const fontSizeRadio = document.querySelector(`input[name="settingFontSize"][value="${dashboardSettings.theme.fontSize}"]`);
            if (fontSizeRadio) fontSizeRadio.checked = true;
            
            modal.classList.add('active');
        }
        
        function closeSettingsModal() {
            document.getElementById('settingsModalOverlay').classList.remove('active');
        }
        
        function switchSettingsTab(tabName, buttonElement) {
            // Update tab buttons
            document.querySelectorAll('.settings-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // FIX: Use buttonElement parameter instead of event.target
            if (buttonElement) {
                buttonElement.classList.add('active');
            } else {
                // Fallback: find and activate by tabName
                const tabs = document.querySelectorAll('.settings-tab');
                tabs.forEach(tab => {
                    if ((tabName === 'display' && tab.textContent.includes('Display')) ||
                        (tabName === 'theme' && tab.textContent.includes('Theme'))) {
                        tab.classList.add('active');
                    }
                });
            }
            
            // Update content
            document.querySelectorAll('.settings-content').forEach(content => {
                content.classList.remove('active');
            });
            
            if (tabName === 'display') {
                document.getElementById('settingsDisplay').classList.add('active');
            } else if (tabName === 'theme') {
                document.getElementById('settingsTheme').classList.add('active');
            }
        }
        
        function toggleFixedWidthInput() {
            const columnWidth = document.querySelector('input[name="settingColumnWidth"]:checked').value;
            const fixedWidthInput = document.getElementById('fixedWidthInput');
            
            if (columnWidth === 'fixed') {
                fixedWidthInput.style.display = 'block';
            } else {
                fixedWidthInput.style.display = 'none';
            }
        }
        
        // Add event listeners for column width radio
        document.addEventListener('DOMContentLoaded', function() {
            const radios = document.querySelectorAll('input[name="settingColumnWidth"]');
            radios.forEach(radio => {
                radio.addEventListener('change', toggleFixedWidthInput);
            });
        });
        
        function applySettings() {
            console.log('=== applySettings START ===');
            
            // Update settings object
            dashboardSettings.display.stickyDimensions = document.getElementById('settingStickyDim').checked;
            dashboardSettings.display.showTooltips = document.getElementById('settingTooltips').checked;
            dashboardSettings.display.alternateRowColors = document.getElementById('settingAlternateRows').checked;
            dashboardSettings.display.columnWidth = document.querySelector('input[name="settingColumnWidth"]:checked').value;
            dashboardSettings.display.fixedColumnWidth = parseInt(document.getElementById('settingFixedWidth').value);
            
            dashboardSettings.theme.primaryColor = document.getElementById('settingPrimaryColor').value;
            dashboardSettings.theme.headerBackground = document.getElementById('settingHeaderBg').value;
            dashboardSettings.theme.totalRowColor = document.getElementById('settingTotalRowColor').value;
            dashboardSettings.theme.fontSize = document.querySelector('input[name="settingFontSize"]:checked').value;
            
            console.log('Updated settings:', dashboardSettings);
            
            // Apply theme immediately
            applyThemeSettings();
            
            // Re-render dashboard
            showLoading('Applying settings...');
            
            setTimeout(() => {
                const activeTabButton = document.querySelector('.dashboard-tab.active');
                if (activeTabButton) {
                    const tabIndex = Array.from(activeTabButton.parentNode.children).indexOf(activeTabButton);
                    
                    console.log('Re-rendering tab:', tabs[tabIndex].id);
                    
                    // Clear and re-render
                    document.getElementById('dashboardContent').innerHTML = '';
                    renderTabContent(tabs[tabIndex].id);
                }
                
                hideLoading();
                closeSettingsModal();
                showModal('', 'Applied', 'Settings applied successfully!');
                
                console.log('=== applySettings END ===');
            }, 500);
        }
        
        function resetThemeToDefault() {
            showModal('', 'Reset Theme',
                'Reset all theme settings to default?',
                function() {
                    document.getElementById('settingPrimaryColor').value = '#27ae60';
                    document.getElementById('settingHeaderBg').value = '#a8e6cf';
                    document.getElementById('settingTotalRowColor').value = '#e8f8f5';
                    document.querySelector('input[name="settingFontSize"][value="medium"]').checked = true;
                    
                    showModal('', 'Reset', 'Theme reset to default!');
                }
            );
        }
        
        function saveTemplateFromSettings() {
            // Apply settings first
            dashboardSettings.display.stickyDimensions = document.getElementById('settingStickyDim').checked;
            dashboardSettings.display.showTooltips = document.getElementById('settingTooltips').checked;
            dashboardSettings.display.alternateRowColors = document.getElementById('settingAlternateRows').checked;
            dashboardSettings.display.columnWidth = document.querySelector('input[name="settingColumnWidth"]:checked').value;
            dashboardSettings.display.fixedColumnWidth = parseInt(document.getElementById('settingFixedWidth').value);
            
            dashboardSettings.theme.primaryColor = document.getElementById('settingPrimaryColor').value;
            dashboardSettings.theme.headerBackground = document.getElementById('settingHeaderBg').value;
            dashboardSettings.theme.totalRowColor = document.getElementById('settingTotalRowColor').value;
            dashboardSettings.theme.fontSize = document.querySelector('input[name="settingFontSize"]:checked').value;
            
            // Check if metadata is filled
            if (!templateMetadata.clientName || !templateMetadata.service) {
                showModal('', 'Missing Information', 
                    'Client Name and Service are required. Please go to Step 4 to fill them first.',
                    function() {
                        closeSettingsModal();
                        navigateToStep('summary');
                    }
                );
                return;
            }
            
            // Build and export template
            const template = {
                version: '1.0',
                metadata: templateMetadata,
                dateConfig: dateConfig,
      creativeConfig: creativeConfig, 	
                dimensions: dimensions,
                metrics: metrics,
                tabs: tabs,
                settings: dashboardSettings
            };
            
            const blob = new Blob([JSON.stringify(template, null, 2)], {
                type: 'application/json'
            });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `dashboard-template-${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);
            
            closeSettingsModal();
            showModal('', 'Success', 'Template with settings saved successfully!');
        }
        
        // Close settings modal on overlay click
        document.getElementById('settingsModalOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSettingsModal();
            }
        });
        
        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }
        
        function showLoading(text = 'Processing...') {
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingOverlay').classList.add('active');
        }
        
        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('active');
        }
        
        document.getElementById('modalOverlay').addEventListener('click', function(e) {
            if (e.target === this) {
                closeModal();
            }
        });

        function toggleSidebar() {
            const sidebar = document.querySelector('.sidebar');
            sidebar.classList.toggle('expanded');
            
            // Icon s t ng rotate bng CSS, khng cn i
            // Re-initialize icons  m bo render ng
            setTimeout(() => {
                lucide.createIcons();
            }, 50);
        }

        // ========================================
        // AURORA PARTICLE NETWORK
        // ========================================
        
        class AuroraBackground {
            constructor(canvasId) {
                this.canvas = document.getElementById(canvasId);
                if (!this.canvas) return;
                
                this.ctx = this.canvas.getContext('2d');
                this.particles = [];
                this.particleCount = 200;
                this.maxDistance = 150;
                this.mouse = { x: null, y: null, radius: 150 };
                
                this.resize();
                this.init();
                this.animate();
                
                window.addEventListener('resize', () => this.resize());
                this.canvas.addEventListener('mousemove', (e) => {
                    this.mouse.x = e.x;
                    this.mouse.y = e.y;
                });
                
                this.canvas.addEventListener('mouseleave', () => {
                    this.mouse.x = null;
                    this.mouse.y = null;
                });
            }
            
            resize() {
                this.canvas.width = this.canvas.offsetWidth;
                this.canvas.height = this.canvas.offsetHeight;
            }
            
            init() {
                this.particles = [];
                for (let i = 0; i < this.particleCount; i++) {
                    this.particles.push({
                        x: Math.random() * this.canvas.width,
                        y: Math.random() * this.canvas.height,
                        vx: (Math.random() - 0.5) * 0.5,
                        vy: (Math.random() - 0.5) * 0.5,
                        radius: Math.random() * 2 + 1,
                        opacity: Math.random() * 0.5 + 0.3
                    });
                }
            }
            
            drawAurora() {
                const gradient = this.ctx.createLinearGradient(0, 0, this.canvas.width, this.canvas.height);
                const time = Date.now() * 0.0001;
                
                gradient.addColorStop(0, `hsl(${200 + Math.sin(time) * 20}, 70%, 15%)`);
                gradient.addColorStop(0.5, `hsl(${160 + Math.cos(time) * 20}, 60%, 20%)`);
                gradient.addColorStop(1, `hsl(${140 + Math.sin(time * 0.8) * 20}, 65%, 18%)`);
                
                this.ctx.fillStyle = gradient;
                this.ctx.fillRect(0, 0, this.canvas.width, this.canvas.height);
            }
            
            drawParticles() {
                this.particles.forEach(particle => {
                    // Update position
                    particle.x += particle.vx;
                    particle.y += particle.vy;
                    
                    // Bounce off edges
                    if (particle.x < 0 || particle.x > this.canvas.width) particle.vx *= -1;
                    if (particle.y < 0 || particle.y > this.canvas.height) particle.vy *= -1;
                    
                    // Mouse interaction
                    if (this.mouse.x && this.mouse.y) {
                        const dx = this.mouse.x - particle.x;
                        const dy = this.mouse.y - particle.y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < this.mouse.radius) {
                            const force = (this.mouse.radius - distance) / this.mouse.radius;
                            particle.x -= dx * force * 0.03;
                            particle.y -= dy * force * 0.03;
                        }
                    }
                    
                    // Draw particle
                    this.ctx.beginPath();
                    this.ctx.arc(particle.x, particle.y, particle.radius, 0, Math.PI * 2);
                    this.ctx.fillStyle = `rgba(168, 230, 207, ${particle.opacity})`;
                    this.ctx.fill();
                });
            }
            
            drawConnections() {
                for (let i = 0; i < this.particles.length; i++) {
                    for (let j = i + 1; j < this.particles.length; j++) {
                        const dx = this.particles[i].x - this.particles[j].x;
                        const dy = this.particles[i].y - this.particles[j].y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < this.maxDistance) {
                            const opacity = (1 - distance / this.maxDistance) * 0.3;
                            
                            this.ctx.beginPath();
                            this.ctx.strokeStyle = `rgba(39, 174, 96, ${opacity})`;
                            this.ctx.lineWidth = 1;
                            this.ctx.moveTo(this.particles[i].x, this.particles[i].y);
                            this.ctx.lineTo(this.particles[j].x, this.particles[j].y);
                            this.ctx.stroke();
                        }
                    }
                }
            }
            
            animate() {
                this.drawAurora();
                this.drawParticles();
                this.drawConnections();
                
                requestAnimationFrame(() => this.animate());
            }
        }
        
        // Initialize Aurora when DOM loaded
        let auroraInstance = null;

        // ========================================
        // CHART TAB MANAGEMENT
        // ========================================
        
        function addNewChart() {
            const tab = tabs.find(t => t.id === currentEditingTabId);
            if (!tab) return;
            
            if (!tab.charts) {
                tab.charts = [];
            }
            
            const newChart = {
                id: `chart_${chartIdCounter++}`,
                title: `Chart ${tab.charts.length + 1}`,
                chartType: 'line',
                xAxis: 'date_column',
                yAxisMetrics: [],
                splitBy: null,
                groupBy: null,
                options: {
                    showLegend: true,
                    showGrid: true,
                    smoothCurve: true,
                    stacked: false
                }
            };
            
            tab.charts.push(newChart);
            renderChartsList(tab);
            expandChart(newChart.id);
            hasUnsavedChanges = true;
        }
        
        function renderChartsList(tab) {
            const container = document.getElementById('chartsList');
            if (!container) return;
            
            if (!tab.charts || tab.charts.length === 0) {
                container.innerHTML = `
                    <div class="empty-charts">
                        No charts yet.<br>
                        Click "Add New Chart" to create your first chart.
                    </div>
                `;
                return;
            }
            
            container.innerHTML = '';
            
            tab.charts.forEach((chart, index) => {
                const item = document.createElement('div');
                item.className = 'chart-config-item';
                item.dataset.chartId = chart.id;
                
                const chartTypeIcons = {
                    'line': '',
                    'bar': '',
                    'pie': '',
                    'area': ''
                };
                
                item.innerHTML = `
                    <div class="chart-config-header" onclick="toggleChartExpand('${chart.id}')">
                        <span class="chart-expand-icon"></span>
                        <span class="chart-type-icon">${chartTypeIcons[chart.chartType] || ''}</span>
                        <span class="chart-config-title">${chart.title || 'Untitled Chart'}</span>
                        <div class="chart-config-actions" onclick="event.stopPropagation()">
                            <button onclick="duplicateChart('${chart.id}')" title="Duplicate"></button>
                            <button onclick="deleteChart('${chart.id}')" title="Delete" style="color: var(--error);"></button>
                        </div>
                    </div>
                    
                    <div class="chart-config-body">
                        ${renderChartConfigForm(chart, index)}
                    </div>
                `;
                
                container.appendChild(item);
            });
            
            // Make sortable
            new Sortable(container, {
                animation: 150,
                handle: '.chart-config-header',
                onEnd: function(evt) {
                    const movedChart = tab.charts.splice(evt.oldIndex, 1)[0];
                    tab.charts.splice(evt.newIndex, 0, movedChart);
                    hasUnsavedChanges = true;
                }
            });
        }
        
        function renderChartConfigForm(chart, index) {
            const metricIndex = metrics.findIndex(m => m.id === chart.yAxisMetrics[0]);
            
            return `
                <div class="form-group">
                    <label>Chart Title</label>
                    <input type="text" value="${chart.title}" 
                           onchange="updateChartConfig('${chart.id}', 'title', this.value)"
                           placeholder="e.g., Cost Trend">
                </div>
                
                <div class="chart-form-row">
                    <div class="form-group">
                        <label>Chart Type</label>
                        <select onchange="updateChartConfig('${chart.id}', 'chartType', this.value)">
                            <option value="line" ${chart.chartType === 'line' ? 'selected' : ''}> Line</option>
                            <option value="bar" ${chart.chartType === 'bar' ? 'selected' : ''}> Bar</option>
                            <option value="pie" ${chart.chartType === 'pie' ? 'selected' : ''}> Pie</option>
                            <option value="area" ${chart.chartType === 'area' ? 'selected' : ''}> Area</option>
                            <option value="combo" ${chart.chartType === 'combo' ? 'selected' : ''}> Combo (Bar + Line)</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>${chart.chartType === 'pie' ? 'Dimension (Slices)' : 'X-Axis'}</label>
                        <select onchange="updateChartConfig('${chart.id}', 'xAxis', this.value)">
                            <option value="">-- Select --</option>
                            <option value="date_column" ${chart.xAxis === 'date_column' ? 'selected' : ''}>${dateConfig.displayName}</option>
                            ${dimensions.map(dim => 
                                `<option value="${dim.id}" ${chart.xAxis === dim.id ? 'selected' : ''}>${dim.displayName}</option>`
                            ).join('')}
                        </select>
                        ${chart.chartType === 'pie' ? '<p style="font-size: 11px; color: var(--text-gray); margin-top: 4px;">Each unique value will be a slice</p>' : ''}
                    </div>
                </div>
                
                <div class="form-group">
                    <label>${chart.chartType === 'pie' ? 'Metric (Value)' : 'Y-Axis Metrics'}</label>
                    ${chart.chartType === 'pie' ? '<div class="alert alert-info" style="margin-bottom: 8px; padding: 8px 12px; font-size: 11px;"><span></span><span>Pie chart uses only 1 metric</span></div>' : ''}
                    <div class="metric-selector-container">
                        <div class="metric-selector-display" id="chartMetrics_${chart.id}">
                            ${renderChartMetricTokens(chart)}
                        </div>
                        <select onchange="addMetricToChart('${chart.id}', this.value)" style="margin-top: 8px;">
                            <option value="">+ Add Metric </option>
                            ${metrics.map(m => 
                                `<option value="${m.id}">${m.displayName}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                
                <div class="chart-form-row" style="${chart.chartType === 'pie' ? 'display:none;' : ''}">
                    <div class="form-group">
                        <label>Split By (Optional)</label>
                        <select onchange="updateChartConfig('${chart.id}', 'splitBy', this.value)">
                            <option value="">None</option>
                            ${dimensions.map(dim => 
                                `<option value="${dim.id}" ${chart.splitBy === dim.id ? 'selected' : ''}>${dim.displayName}</option>`
                            ).join('')}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>Group By (Optional)</label>
                        <select onchange="updateChartConfig('${chart.id}', 'groupBy', this.value)">
                            <option value="">None</option>
                            ${dimensions.map(dim => 
                                `<option value="${dim.id}" ${chart.groupBy === dim.id ? 'selected' : ''}>${dim.displayName}</option>`
                            ).join('')}
                        </select>
                    </div>
                </div>
                
                <div class="form-group" style="${chart.chartType === 'pie' ? 'display:none;' : ''}">
                    <label>Chart Options</label>
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="chartLegend_${chart.id}" 
                                   ${chart.options.showLegend ? 'checked' : ''}
                                   onchange="updateChartOption('${chart.id}', 'showLegend', this.checked)">
                            <label for="chartLegend_${chart.id}">Show legend</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="chartGrid_${chart.id}" 
                                   ${chart.options.showGrid ? 'checked' : ''}
                                   onchange="updateChartOption('${chart.id}', 'showGrid', this.checked)">
                            <label for="chartGrid_${chart.id}">Show grid</label>
                        </div>
                        <div class="checkbox-item" style="${chart.chartType === 'line' || chart.chartType === 'area' ? '' : 'display:none;'}">
                            <input type="checkbox" id="chartSmooth_${chart.id}" 
                                   ${chart.options.smoothCurve ? 'checked' : ''}
                                   onchange="updateChartOption('${chart.id}', 'smoothCurve', this.checked)">
                            <label for="chartSmooth_${chart.id}">Smooth curve</label>
                        </div>
                        <div class="checkbox-item" style="${chart.chartType === 'bar' || chart.chartType === 'area' ? '' : 'display:none;'}">
                            <input type="checkbox" id="chartStacked_${chart.id}" 
                                   ${chart.options.stacked ? 'checked' : ''}
                                   onchange="updateChartOption('${chart.id}', 'stacked', this.checked)">
                            <label for="chartStacked_${chart.id}">Stacked</label>
                        </div>
                    </div>
                </div>
                
                <button class="btn btn-danger btn-block" onclick="deleteChart('${chart.id}')" style="margin-top: 16px;">
                    <span></span>
                    <span>Delete Chart</span>
                </button>
            `;
        }
        
        function renderChartMetricTokens(chart) {
            if (!chart.yAxisMetrics || chart.yAxisMetrics.length === 0) {
                return '<div style="text-align: center; padding: 12px; color: var(--text-gray); font-size: 13px;">No metrics selected</div>';
            }
            
            return chart.yAxisMetrics.map(metricId => {
                const metric = metrics.find(m => m.id === metricId);
                if (!metric) return '';
                
                // For combo chart, show type selector
                let typeSelector = '';
                if (chart.chartType === 'combo') {
                    const metricType = chart.metricTypes?.[metricId] || 'bar';
                    typeSelector = `
                        <select onchange="updateMetricType('${chart.id}', '${metricId}', this.value)" 
                                style="background: rgba(255,255,255,0.3); border: none; color: white; font-size: 11px; 
                                       padding: 2px 6px; border-radius: 4px; font-weight: 600; cursor: pointer;"
                                onclick="event.stopPropagation()">
                            <option value="bar" ${metricType === 'bar' ? 'selected' : ''}></option>
                            <option value="line" ${metricType === 'line' ? 'selected' : ''}></option>
                        </select>
                    `;
                }
                
                return `
                    <div class="metric-selector-token" style="background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);">
                        <span>${metric.displayName}</span>
                        ${typeSelector}
                        <button class="remove-btn" onclick="removeMetricFromChart('${chart.id}', '${metricId}')" title="Remove"></button>
                    </div>
                `;
            }).join('');
        }

        function updateMetricType(chartId, metricId, type) {
            const tab = tabs.find(t => t.id === currentEditingTabId);
            if (!tab) return;
            
            const chart = tab.charts.find(c => c.id === chartId);
            if (!chart) return;
            
            if (!chart.metricTypes) {
                chart.metricTypes = {};
            }
            
            chart.metricTypes[metricId] = type;
            hasUnsavedChanges = true;
        }
        
        function toggleChartExpand(chartId) {
            const item = document.querySelector(`[data-chart-id="${chartId}"]`);
            if (!item) return;
            
            // Collapse all others
            document.querySelectorAll('.chart-config-item').forEach(el => {
                if (el.dataset.chartId !== chartId) {
                    el.classList.remove('active');
                }
            });
            
            // Toggle this one
            item.classList.toggle('active');
        }
        
        function expandChart(chartId) {
            const item = document.querySelector(`[data-chart-id="${chartId}"]`);
            if (!item) return;
            
            document.querySelectorAll('.chart-config-item').forEach(el => {
                el.classList.remove('active');
            });
            
            item.classList.add('active');
        }
        
        function updateChartConfig(chartId, field, value) {
            const tab = tabs.find(t => t.id === currentEditingTabId);
            if (!tab) return;
            
            const chart = tab.charts.find(c => c.id === chartId);
            if (!chart) return;
            
            chart[field] = value;
            
            // Re-render if chart type changed (to show/hide fields)
            if (field === 'chartType') {
                renderChartsList(tab);
                expandChart(chartId);
            }
            
            hasUnsavedChanges = true;
        }
        
        function updateChartOption(chartId, option, value) {
            const tab = tabs.find(t => t.id === currentEditingTabId);
            if (!tab) return;
            
            const chart = tab.charts.find(c => c.id === chartId);
            if (!chart) return;
            
            chart.options[option] = value;
            hasUnsavedChanges = true;
        }
        
        function addMetricToChart(chartId, metricId) {
            if (!metricId) return;
            
            const tab = tabs.find(t => t.id === currentEditingTabId);
            if (!tab) return;
            
            const chart = tab.charts.find(c => c.id === chartId);
            if (!chart) return;
            
            // For pie chart, only allow 1 metric
            if (chart.chartType === 'pie') {
                chart.yAxisMetrics = [metricId];
            } else {
                if (chart.yAxisMetrics.includes(metricId)) {
                    showModal('', 'Already Added', 'This metric is already selected!');
                    return;
                }
                chart.yAxisMetrics.push(metricId);
            }
            
            renderChartsList(tab);
            expandChart(chartId);
            hasUnsavedChanges = true;
        }
        
        function removeMetricFromChart(chartId, metricId) {
            const tab = tabs.find(t => t.id === currentEditingTabId);
            if (!tab) return;
            
            const chart = tab.charts.find(c => c.id === chartId);
            if (!chart) return;
            
            chart.yAxisMetrics = chart.yAxisMetrics.filter(id => id !== metricId);
            renderChartsList(tab);
            expandChart(chartId);
            hasUnsavedChanges = true;
        }
        
        function duplicateChart(chartId) {
            const tab = tabs.find(t => t.id === currentEditingTabId);
            if (!tab) return;
            
            const chart = tab.charts.find(c => c.id === chartId);
            if (!chart) return;
            
            const newChart = JSON.parse(JSON.stringify(chart));
            newChart.id = `chart_${chartIdCounter++}`;
            newChart.title = chart.title + ' (Copy)';
            
            tab.charts.push(newChart);
            renderChartsList(tab);
            expandChart(newChart.id);
            hasUnsavedChanges = true;
        }
        
        function deleteChart(chartId) {
            const tab = tabs.find(t => t.id === currentEditingTabId);
            if (!tab) return;
            
            showModal('', 'Delete Chart', 
                'Are you sure you want to delete this chart?',
                function() {
                    tab.charts = tab.charts.filter(c => c.id !== chartId);
                    renderChartsList(tab);
                    hasUnsavedChanges = true;
                }
            );
        }

        function renderChartTab(container, tab, data) {
            if (!tab.charts || tab.charts.length === 0) {
                container.innerHTML = `
                    <div style="text-align: center; padding: 80px; color: var(--text-gray);">
                        <div style="font-size: 64px; margin-bottom: 20px;"></div>
                        <h3 style="font-size: 20px; margin-bottom: 10px;">No Charts Configured</h3>
                        <p>Go to Step 3 to add charts to this tab</p>
                    </div>
                `;
                return;
            }
            
            tab.charts.forEach(chart => {
                if (chart.groupBy) {
                    // Render separate chart for each group
                    renderGroupedCharts(container, tab, chart, data);
                } else {
                    // Render single chart
                    renderSingleChart(container, tab, chart, data);
                }
            });
        }
        
        function renderSingleChart(container, tab, chart, data) {
            const chartContainer = document.createElement('div');
            chartContainer.className = 'dashboard-table-container';
            chartContainer.style.marginBottom = '32px';
            
            chartContainer.innerHTML = `
                <div class="dashboard-table-header">
                    <span class="icon">${getChartIcon(chart.chartType)}</span>
                    <h3>${chart.title || 'Untitled Chart'}</h3>
                </div>
                <div style="padding: 20px; background: white;">
                    <canvas id="chart_${chart.id}" style="max-height: 400px;"></canvas>
                </div>
            `;
            
            container.appendChild(chartContainer);
            
            // Render chart after DOM update
            setTimeout(() => {
                drawChart(chart, data, tab);
            }, 100);
        }
        
        function renderGroupedCharts(container, tab, chart, data) {
            // Get group by dimension
            let groupDim;
            if (chart.groupBy === 'date_column') {
                groupDim = { id: 'date_column', sourceColumn: dateConfig.sourceColumn, displayName: dateConfig.displayName };
            } else {
                groupDim = dimensions.find(d => d.id === chart.groupBy);
            }
            
            if (!groupDim) return;
            
            // Get unique values
            const uniqueValues = [...new Set(data.map(row => row[groupDim.sourceColumn]))].filter(v => v);
            
            uniqueValues.forEach(value => {
                const groupData = data.filter(row => row[groupDim.sourceColumn] === value);
                
                const chartContainer = document.createElement('div');
                chartContainer.className = 'dashboard-table-container';
                chartContainer.style.marginBottom = '32px';
                
                const chartTitle = `${chart.title} - ${value}`;
                
                chartContainer.innerHTML = `
                    <div class="dashboard-table-header">
                        <span class="icon">${getChartIcon(chart.chartType)}</span>
                        <h3>${chartTitle}</h3>
                    </div>
                    <div style="padding: 20px; background: white;">
                        <canvas id="chart_${chart.id}_${value.replace(/[^a-zA-Z0-9]/g, '_')}" style="max-height: 400px;"></canvas>
                    </div>
                `;
                
                container.appendChild(chartContainer);
                
                setTimeout(() => {
                    drawChart(chart, groupData, tab, value);
                }, 100);
            });
        }
        
        function getChartIcon(chartType) {
            const icons = {
                'line': '',
                'bar': '',
                'pie': '',
                'area': '',
                'combo': ''
            };
            return icons[chartType] || '';
        }

        // ========================================
        // CHART RENDERING vi Chart.js
        // ========================================
        
        function drawChart(chart, data, tab, groupValue = null) {
            const canvasId = groupValue 
                ? `chart_${chart.id}_${groupValue.replace(/[^a-zA-Z0-9]/g, '_')}`
                : `chart_${chart.id}`;
            
            const canvas = document.getElementById(canvasId);
            if (!canvas) {
                console.error('Canvas not found:', canvasId);
                return;
            }
            
            const ctx = canvas.getContext('2d');
            
            // Prepare chart data based on type
            let chartData;
            
            if (chart.chartType === 'pie') {
                chartData = preparePieChartData(chart, data);
            } else {
                chartData = prepareAxisChartData(chart, data, tab);
            }
            
            // FIX: For combo chart, each dataset has its own type
            let chartType;
            if (chart.chartType === 'area') {
                chartType = 'line';
            } else if (chart.chartType === 'combo') {
                // Combo uses first metric's type as base, others override
                const firstMetricType = chart.metricTypes?.[chart.yAxisMetrics[0]] || 'bar';
                chartType = firstMetricType;
            } else {
                chartType = chart.chartType;
            }
            
            const config = {
                type: chartType,
                data: chartData,
                options: getChartOptions(chart)
            };
            
            // Create chart
            new Chart(ctx, config);
        }
        
        function prepareAxisChartData(chart, data, tab) {
            // Get X-axis dimension
            let xDim;
            if (chart.xAxis === 'date_column') {
                xDim = { id: 'date_column', sourceColumn: dateConfig.sourceColumn };
            } else {
                xDim = dimensions.find(d => d.id === chart.xAxis);
            }
            
            if (!xDim) {
                return { labels: [], datasets: [] };
            }
            
            // Aggregate data
            const aggregated = aggregateDataForChart(data, chart, tab);
            
            // Get unique X values (labels)
            const labels = [...new Set(aggregated.map(row => {
                let value = row[xDim.sourceColumn];
                if (chart.xAxis === 'date_column') {
                    value = formatDateValue(value, dateConfig.format);
                }
                return value;
            }))];
            
            // Build datasets
            const datasets = [];
            
            if (chart.splitBy) {
                // Multiple series (split by dimension)
                const splitDim = dimensions.find(d => d.id === chart.splitBy);
                if (splitDim) {
                    const splitValues = [...new Set(aggregated.map(row => row[splitDim.sourceColumn]))].filter(v => v);
                    
                    splitValues.forEach((splitValue, index) => {
                        chart.yAxisMetrics.forEach(metricId => {
                            const metric = metrics.find(m => m.id === metricId);
                            if (!metric) return;
                            
                            const metricIndex = metrics.findIndex(m => m.id === metricId);
                            
                            const dataPoints = labels.map(label => {
                                const row = aggregated.find(r => {
                                    let xValue = r[xDim.sourceColumn];
                                    if (chart.xAxis === 'date_column') {
                                        xValue = formatDateValue(xValue, dateConfig.format);
                                    }
                                    return xValue === label && r[splitDim.sourceColumn] === splitValue;
                                });
                                return row ? row[`metric_${metricIndex}`] : null;
                            });
                            
                            const color = getChartColor(splitValues.indexOf(splitValue));
                            
                            // FIX: For combo chart, check metric type
                            let datasetType = chart.chartType;
                            if (chart.chartType === 'combo') {
                                datasetType = chart.metricTypes?.[metricId] || 'bar';
                            }
                            
                            const dataset = {
                                label: `${splitValue} - ${metric.displayName}`,
                                data: dataPoints,
                                borderColor: color,
                                backgroundColor: datasetType === 'area' ? color + '40' : 
                                                 datasetType === 'bar' ? color : color,
                                tension: chart.options.smoothCurve ? 0.4 : 0,
                                fill: datasetType === 'area'
                            };
                            
                            // FIX: Set type and Y-axis for combo chart
                            if (chart.chartType === 'combo') {
                                dataset.type = datasetType;
                                
                                // FIX: Set order
                                dataset.order = datasetType === 'bar' ? 2 : 1;
                                
                                // Assign Y-axis based on metric type
                                if (datasetType === 'bar') {
                                    dataset.yAxisID = 'y';
                                } else {
                                    dataset.yAxisID = 'y1';
                                }
                            }
                            
                            datasets.push(dataset);
                        });
                    });
                }
            } else {
                // Single series (no split)
                chart.yAxisMetrics.forEach((metricId, index) => {
                    const metric = metrics.find(m => m.id === metricId);
                    if (!metric) return;
                    
                    const metricIndex = metrics.findIndex(m => m.id === metricId);
                    
                    const dataPoints = labels.map(label => {
                        const row = aggregated.find(r => {
                            let xValue = r[xDim.sourceColumn];
                            if (chart.xAxis === 'date_column') {
                                xValue = formatDateValue(xValue, dateConfig.format);
                            }
                            return xValue === label;
                        });
                        return row ? row[`metric_${metricIndex}`] : null;
                    });
                    
                    const color = getChartColor(index);
                    
                    // FIX: For combo chart, check metric type
                    let datasetType = chart.chartType;
                    if (chart.chartType === 'combo') {
                        datasetType = chart.metricTypes?.[metricId] || 'bar';
                    }
                    
                    const dataset = {
                        label: metric.displayName,
                        data: dataPoints,
                        borderColor: color,
                        backgroundColor: datasetType === 'area' ? color + '40' : 
                                         datasetType === 'bar' ? color : color,
                        tension: chart.options.smoothCurve ? 0.4 : 0,
                        fill: datasetType === 'area'
                    };
                    
                    // FIX: Set type and Y-axis for combo chart
                    if (chart.chartType === 'combo') {
                        dataset.type = datasetType;
                        
                        // FIX: Set order (bar = 2, line = 1)  Line renders on top
                        dataset.order = datasetType === 'bar' ? 2 : 1;
                        
                        // Assign to different Y-axes
                        if (index === 0) {
                            dataset.yAxisID = 'y';
                        } else {
                            dataset.yAxisID = 'y1';
                        }
                    }
                    
                    datasets.push(dataset);
                });
                
            }
            
            return { labels, datasets };
        }
        
        function preparePieChartData(chart, data) {
            // Pie chart: 1 dimension + 1 metric
            if (chart.yAxisMetrics.length === 0) {
                return { labels: [], datasets: [] };
            }
            
            // Use first dimension from tab or chart config
            const dimId = chart.xAxis || 'date_column';
            let dim;
            
            if (dimId === 'date_column') {
                dim = { id: 'date_column', sourceColumn: dateConfig.sourceColumn };
            } else {
                dim = dimensions.find(d => d.id === dimId);
            }
            
            if (!dim) {
                return { labels: [], datasets: [] };
            }
            
            const metricId = chart.yAxisMetrics[0];
            const metric = metrics.find(m => m.id === metricId);
            const metricIndex = metrics.findIndex(m => m.id === metricId);
            
            // Aggregate by dimension
            const groups = new Map();
            
            data.forEach(row => {
                const key = row[dim.sourceColumn] || 'Unknown';
                
                if (!groups.has(key)) {
                    groups.set(key, []);
                }
                groups.get(key).push(row);
            });
            
            const labels = [];
            const values = [];
            const colors = [];
            
            let colorIndex = 0;
            groups.forEach((rows, key) => {
                labels.push(key);
                
                // Calculate metric
                if (metric.type === 'base') {
                    values.push(calculateBaseMetric(rows, metric.sourceColumn));
                } else {
                    const metricValues = {};
                    metrics.filter(m => m.type === 'base').forEach(m => {
                        metricValues[`[${m.displayName}]`] = calculateBaseMetric(rows, m.sourceColumn);
                    });
                    values.push(calculateFormula(metric.formula, metricValues));
                }
                
                colors.push(getChartColor(colorIndex++));
            });
            
            return {
                labels,
                datasets: [{
                    data: values,
                    backgroundColor: colors,
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            };
        }
        
        function aggregateDataForChart(data, chart, tab) {
            // Build temporary tab config for aggregation
            const tempTab = {
                dimensions: [],
                filters: tab.filters || []
            };
            
            // Add X-axis dimension
            if (chart.xAxis) {
                tempTab.dimensions.push(chart.xAxis);
            }
            
            // Add split dimension
            if (chart.splitBy) {
                tempTab.dimensions.push(chart.splitBy);
            }
            
            // Aggregate
            return aggregateData(tempTab, null, data);
        }
        
        function getChartOptions(chart) {
            const options = {
                responsive: true,
                maintainAspectRatio: true,
                aspectRatio: 2.5,
                plugins: {
                    legend: {
                        display: chart.options.showLegend,
                        position: 'top',
                        labels: {
                            font: {
                                family: 'Plus Jakarta Sans, Inter, sans-serif',
                                size: 12,
                                weight: 600
                            },
                            padding: 15,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        backgroundColor: 'rgba(0, 0, 0, 0.8)',
                        padding: 12,
                        titleFont: {
                            size: 14,
                            weight: 700
                        },
                        bodyFont: {
                            size: 13,
                            weight: 500
                        },
                        borderColor: 'rgba(255, 255, 255, 0.1)',
                        borderWidth: 1,
                        cornerRadius: 8
                    }
                }
            };
            
            // For axis charts (line, bar, area, combo)
            if (chart.chartType !== 'pie') {
                options.scales = {
                    x: {
                        grid: {
                            display: chart.options.showGrid,
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            font: {
                                size: 11,
                                weight: 600
                            }
                        }
                    },
                    y: {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        grid: {
                            display: chart.options.showGrid,
                            color: 'rgba(0, 0, 0, 0.05)'
                        },
                        ticks: {
                            font: {
                                size: 11,
                                weight: 600
                            }
                        },
                        beginAtZero: true
                    }
                };
                
                // FIX: Add second Y-axis for combo chart
                if (chart.chartType === 'combo') {
                    options.scales.y1 = {
                        type: 'linear',
                        display: true,
                        position: 'right',
                        grid: {
                            drawOnChartArea: false  // Don't draw grid lines for right axis
                        },
                        ticks: {
                            font: {
                                size: 11,
                                weight: 600
                            }
                        },
                        beginAtZero: true
                    };
                }
                
                // Stacked option
                if (chart.options.stacked) {
                    options.scales.x.stacked = true;
                    options.scales.y.stacked = true;
                }
            }
            
            return options;
        }
        
        function getChartColor(index) {
            const colors = [
                '#27ae60',  // Green
                '#3b82f6',  // Blue
                '#f59e0b',  // Orange
                '#8b5cf6',  // Purple
                '#ef4444',  // Red
                '#06b6d4',  // Cyan
                '#ec4899',  // Pink
                '#84cc16',  // Lime
                '#f97316',  // Orange-red
                '#6366f1',  // Indigo
            ];
            return colors[index % colors.length];
        }
        
        // ========================================
        // EXPORT TO EXCEL
        // ========================================
        
        async function exportToExcel() {
            showLoading('Generating Excel file...');
            
            try {
                const workbook = new ExcelJS.Workbook();
                
                // Metadata
                workbook.creator = templateMetadata.clientName || 'Dashboard Builder';
                workbook.created = new Date();
                workbook.company = templateMetadata.clientName || '';
                
                // Export each tab as sheet
                for (const tab of tabs) {
                    console.log('Exporting tab:', tab.name);
                    
                    if (tab.type === 'standard' || tab.type === 'creative') {
                        await exportStandardTab(workbook, tab);
                    } else if (tab.type === 'comparison') {
                        await exportComparisonTab(workbook, tab);
                    } else if (tab.type === 'chart') {
                        await exportChartTab(workbook, tab);
                    }
                }
                
                // Generate file
                const buffer = await workbook.xlsx.writeBuffer();
                const blob = new Blob([buffer], { 
                    type: 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet' 
                });
                
                // Download
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                
                const clientName = templateMetadata.clientName || 'Dashboard';
                const service = templateMetadata.service || '';
                const date = new Date().toISOString().split('T')[0];
                a.download = `${clientName}_${service}_${date}.xlsx`.replace(/\s+/g, '_');
                
                a.click();
                URL.revokeObjectURL(url);
                
                hideLoading();
                showModal('', 'Success', 'Excel file exported successfully!');
                
            } catch (error) {
                console.error('Export error:', error);
                hideLoading();
                showModal('', 'Error', 'Failed to export Excel: ' + error.message);
            }
        }
        
        async function exportStandardTab(workbook, tab) {
            const sheetName = sanitizeSheetName(tab.name);
            const sheet = workbook.addWorksheet(sheetName);
            
            const dataToUse = filteredData || csvData.rows;
            
            // Get aggregated data
            let allData = [];
            
            if (tab.groupBy) {
                const groupedData = groupDataByDimension(dataToUse, tab);
                groupedData.forEach(group => {
                    const aggregated = aggregateData(tab, null, group.data);
                    allData = allData.concat(aggregated);
                });
            } else {
                allData = aggregateData(tab, null, dataToUse);
            }
            
            // Build headers
            const headers = [];
            
            // Dimension headers
            tab.dimensions.forEach(dimId => {
                if (dimId === 'date_column') {
                    headers.push(dateConfig.displayName);
                } else if (dimId === 'creative_ad_name') {
                    headers.push('Ad Name');
                } else if (dimId === 'creative_file_name') {
                    headers.push('File Name');
                } else if (dimId === 'creative_image') {
                    headers.push('Creative URL');
                } else if (dimId === 'creative_ad_format') {
                    headers.push('Ad Format');
                } else {
                    const dim = dimensions.find(d => d.id === dimId);
                    headers.push(dim?.displayName || dimId);
                }
            });
            
            // Metric headers
            metrics.forEach(metric => {
                headers.push(metric.displayName);
            });
            
            // Add header row
            const headerRow = sheet.addRow(headers);
            
            // Style header
            headerRow.height = 25;
            headerRow.eachCell((cell) => {
                cell.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FFA8E6CF' }
                };
                cell.font = { 
                    bold: true, 
                    size: 12,
                    name: 'Plus Jakarta Sans'
                };
                cell.alignment = { 
                    vertical: 'middle', 
                    horizontal: 'left' 
                };
                cell.border = {
                    top: { style: 'thin', color: { argb: 'FF000000' } },
                    bottom: { style: 'thin', color: { argb: 'FF000000' } },
                    left: { style: 'thin', color: { argb: 'FF000000' } },
                    right: { style: 'thin', color: { argb: 'FF000000' } }
                };
            });
            
            // Add data rows
            allData.forEach(rowData => {
                const row = [];
                
                // Dimensions
                tab.dimensions.forEach(dimId => {
                    if (dimId === 'date_column') {
                        row.push(rowData[dateConfig.sourceColumn] || '');
                    } else if (dimId === 'creative_ad_name') {
                        row.push(rowData[creativeConfig.adNameColumn] || '');
                    } else if (dimId === 'creative_file_name') {
                        const col = creativeConfig.sameAsAdName ? creativeConfig.adNameColumn : creativeConfig.fileNameColumn;
                        row.push(rowData[col] || '');
                    } else if (dimId === 'creative_image') {
                        const url = getCreativeImageUrl(rowData, rowData[creativeConfig.adFormatColumn]);
                        row.push(url || '');
                    } else if (dimId === 'creative_ad_format') {
                        row.push(rowData[creativeConfig.adFormatColumn] || '');
                    } else {
                        const dim = dimensions.find(d => d.id === dimId);
                        row.push(rowData[dim?.sourceColumn] || '');
                    }
                });
                
                // Metrics
                metrics.forEach((metric, idx) => {
                    const value = rowData[`metric_${idx}`];
                    row.push(value || 0);
                });
                
                const dataRow = sheet.addRow(row);
                
                // Format metric cells
                metrics.forEach((metric, idx) => {
                    const colIndex = tab.dimensions.length + idx + 1;
                    const cell = dataRow.getCell(colIndex);
                    
                    // Number format
                    if (metric.format.type === 'number') {
                        const decimals = metric.format.decimals;
                        if (metric.format.thousandSeparator) {
                            cell.numFmt = decimals > 0 
                                ? `#,##0.${'0'.repeat(decimals)}` 
                                : '#,##0';
                        } else {
                            cell.numFmt = decimals > 0 
                                ? `0.${'0'.repeat(decimals)}` 
                                : '0';
                        }
                    } else if (metric.format.type === 'percentage') {
                        const decimals = metric.format.decimals;
                        cell.numFmt = `0.${'0'.repeat(decimals)}%`;
                        cell.value = cell.value / 100;  // Excel percentage is 0.05 not 5
                    }
                    
                    cell.alignment = { horizontal: 'right' };
                });
            });
            
            // Total row
            if (tab.options.showTotal && allData.length > 0) {
                const totalRow = calculateTotalRow(allData, tab);
                const row = [];
                
                // First dimension cell = "Total"
                row.push('Total');
                for (let i = 1; i < tab.dimensions.length; i++) {
                    row.push('');
                }
                
                // Metrics
                metrics.forEach((metric, idx) => {
                    row.push(totalRow[`metric_${idx}`] || 0);
                });
                
                const totalRowExcel = sheet.addRow(row);
                
                // Style total row
                totalRowExcel.height = 25;
                totalRowExcel.eachCell((cell, colNum) => {
                    cell.fill = {
                        type: 'pattern',
                        pattern: 'solid',
                        fgColor: { argb: 'FFE8F8F5' }
                    };
                    cell.font = { bold: true };
                    cell.border = {
                        top: { style: 'medium', color: { argb: 'FF27AE60' } },
                        bottom: { style: 'thin', color: { argb: 'FF000000' } },
                        left: { style: 'thin', color: { argb: 'FF000000' } },
                        right: { style: 'thin', color: { argb: 'FF000000' } }
                    };
                    
                    // Format metrics
                    if (colNum > tab.dimensions.length) {
                        const metricIdx = colNum - tab.dimensions.length - 1;
                        const metric = metrics[metricIdx];
                        
                        if (metric.format.type === 'percentage') {
                            cell.value = cell.value / 100;
                        }
                        
                        cell.alignment = { horizontal: 'right' };
                    }
                });
            }
            
            // Auto-fit columns
            sheet.columns.forEach((column) => {
                let maxLength = 10;
                column.eachCell({ includeEmpty: false }, (cell) => {
                    const length = cell.value ? String(cell.value).length : 10;
                    if (length > maxLength) maxLength = length;
                });
                column.width = Math.min(maxLength + 3, 35);
            });
            
            // Freeze header row
            sheet.views = [
                { state: 'frozen', xSplit: 0, ySplit: 1 }
            ];
        }
        
        function sanitizeSheetName(name) {
            // Excel sheet name: max 31 chars, no special chars
            return name
                .replace(/[:\\\/\?\*\[\]]/g, '')
                .substring(0, 31);
        }

        async function exportComparisonTab(workbook, tab) {
            const sheetName = sanitizeSheetName(tab.name);
            const sheet = workbook.addWorksheet(sheetName);
            
            // Calculate periods
            let period1, period2;
            if (tab.dateMode === 'smart') {
                const periods = smartTemplates[tab.smartTemplate].calculate();
                period1 = periods.period1;
                period2 = periods.period2;
            } else {
                period1 = tab.period1;
                period2 = tab.period2;
            }
            
            // Filter data
            const dataToUse = filteredData || csvData.rows;
            const period1Data = dataToUse.filter(row => {
                const rowDate = normalizeDateString(row[dateConfig.sourceColumn]);
                return rowDate >= period1.from && rowDate <= period1.to;
            });
            const period2Data = dataToUse.filter(row => {
                const rowDate = normalizeDateString(row[dateConfig.sourceColumn]);
                return rowDate >= period2.from && rowDate <= period2.to;
            });
            
            // Aggregate
            const agg1 = aggregateData(tab, null, period1Data);
            const agg2 = aggregateData(tab, null, period2Data);
            const comparisonData = buildComparisonData(agg1, agg2, tab);
            
            // Add info rows
            const days1 = getDaysBetween(period1.from, period1.to);
            const days2 = getDaysBetween(period2.from, period2.to);
            
            sheet.addRow([`Period 1: ${period1.label}`, `${formatDateDisplay(period1.from)} ~ ${formatDateDisplay(period1.to)} (${days1} days)`]);
            sheet.addRow([`Period 2: ${period2.label}`, `${formatDateDisplay(period2.from)} ~ ${formatDateDisplay(period2.to)} (${days2} days)`]);
            sheet.addRow([]);  // Empty row
            
            // Build headers
            const headers = [];
            
            // Dimensions
            if (tab.dimensions && tab.dimensions.length > 0) {
                tab.dimensions.forEach(dimId => {
                    if (dimId === 'date_column') {
                        headers.push(dateConfig.displayName);
                    } else {
                        const dim = dimensions.find(d => d.id === dimId);
                        headers.push(dim?.displayName || dimId);
                    }
                });
            }
            
            headers.push('Metric');
            headers.push(period1.label);
            headers.push(period2.label);
            
            if (tab.comparisonOptions.showAbsolute) {
                headers.push('');
            }
            if (tab.comparisonOptions.showPercentage) {
                headers.push(' %');
            }
            
            const headerRow = sheet.addRow(headers);
            
            // Style header
            headerRow.height = 25;
            headerRow.eachCell((cell) => {
                cell.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FFA8E6CF' }
                };
                cell.font = { bold: true, size: 12 };
                cell.alignment = { vertical: 'middle', horizontal: 'center' };
                cell.border = {
                    top: { style: 'thin' },
                    bottom: { style: 'thin' },
                    left: { style: 'thin' },
                    right: { style: 'thin' }
                };
            });
            
            // Add data
            comparisonData.forEach(rowGroup => {
                const dimensionValues = rowGroup.dimensions;
                const metricsData = rowGroup.metrics;
                
                tab.selectedMetrics.forEach((metricId, metricIndex) => {
                    const metric = metrics.find(m => m.id === metricId);
                    if (!metric) return;
                    
                    const row = [];
                    
                    // Dimensions (only on first metric row)
                    if (metricIndex === 0 && tab.dimensions && tab.dimensions.length > 0) {
                        dimensionValues.forEach(val => row.push(val));
                    } else if (tab.dimensions && tab.dimensions.length > 0) {
                        tab.dimensions.forEach(() => row.push(''));
                    }
                    
                    // Metric name
                    row.push(metric.displayName);
                    
                    // Period values
                    const p1Value = metricsData.period1[metricId] || 0;
                    const p2Value = metricsData.period2[metricId] || 0;
                    
                    row.push(p1Value);
                    row.push(p2Value);
                    
                    // Difference
                    const diff = p2Value - p1Value;
                    const diffPercent = p1Value !== 0 ? ((diff / p1Value) * 100) : 0;
                    
                    if (tab.comparisonOptions.showAbsolute) {
                        row.push(diff);
                    }
                    if (tab.comparisonOptions.showPercentage) {
                        row.push(diffPercent / 100);  // Excel percentage
                    }
                    
                    const dataRow = sheet.addRow(row);
                    
                    // Format numbers
                    const startCol = (tab.dimensions?.length || 0) + 2;
                    
                    // Period 1 & 2
                    [startCol, startCol + 1].forEach(colIdx => {
                        const cell = dataRow.getCell(colIdx);
                        if (metric.format.type === 'percentage') {
                            cell.numFmt = '0.0%';
                            cell.value = cell.value / 100;
                        } else {
                            cell.numFmt = metric.format.thousandSeparator ? '#,##0' : '0';
                        }
                        cell.alignment = { horizontal: 'right' };
                    });
                    
                    // Difference
                    if (tab.comparisonOptions.showAbsolute) {
                        const diffCell = dataRow.getCell(startCol + 2);
                        diffCell.numFmt = metric.format.thousandSeparator ? '#,##0' : '0';
                        diffCell.alignment = { horizontal: 'right' };
                        diffCell.font = { bold: true };
                        
                        // Color coding
                        if (tab.comparisonOptions.colorCoding) {
                            diffCell.font.color = { argb: diff >= 0 ? 'FF27AE60' : 'FFE74C3C' };
                        }
                    }
                    
                    // Percentage
                    if (tab.comparisonOptions.showPercentage) {
                        const percentCell = dataRow.getCell(startCol + (tab.comparisonOptions.showAbsolute ? 3 : 2));
                        percentCell.numFmt = '0.0%';
                        percentCell.alignment = { horizontal: 'right' };
                        percentCell.font = { bold: true };
                        
                        if (tab.comparisonOptions.colorCoding) {
                            percentCell.font.color = { argb: diffPercent >= 0 ? 'FF27AE60' : 'FFE74C3C' };
                        }
                    }
                });
            });
            
            // Auto-fit columns
            sheet.columns.forEach((column) => {
                let maxLength = 12;
                column.eachCell({ includeEmpty: false }, (cell) => {
                    const length = cell.value ? String(cell.value).length : 10;
                    if (length > maxLength) maxLength = length;
                });
                column.width = Math.min(maxLength + 3, 35);
            });
            
            // Freeze header
            sheet.views = [{ state: 'frozen', xSplit: 0, ySplit: 4 }];  // Freeze after info rows + header
        }

        async function exportChartTab(workbook, tab) {
            const sheetName = sanitizeSheetName(tab.name);
            const sheet = workbook.addWorksheet(sheetName);
            
            if (!tab.charts || tab.charts.length === 0) {
                sheet.addRow(['No charts configured']);
                return;
            }
            
            const dataToUse = filteredData || csvData.rows;
            let currentRow = 1;
            
            // Export each chart
            for (const chart of tab.charts) {
                // Add chart title
                const titleRow = sheet.getRow(currentRow);
                titleRow.getCell(1).value = `${getChartIcon(chart.chartType)} ${chart.title || 'Untitled Chart'}`;
                titleRow.getCell(1).font = { bold: true, size: 14, color: { argb: 'FF27AE60' } };
                titleRow.height = 30;
                currentRow++;
                
                // Add chart info
                const infoRow = sheet.getRow(currentRow);
                infoRow.getCell(1).value = `Type: ${chart.chartType} | X-Axis: ${getAxisLabel(chart.xAxis)} | Y-Axis: ${chart.yAxisMetrics.map(id => {
                    const m = metrics.find(met => met.id === id);
                    return m?.displayName;
                }).join(', ')}`;
                infoRow.getCell(1).font = { size: 11, color: { argb: 'FF6C757D' } };
                currentRow++;
                
                currentRow++;  // Empty row
                
                // Export chart data
                if (chart.chartType === 'pie') {
                    currentRow = await exportPieChartData(sheet, chart, dataToUse, currentRow);
                } else {
                    currentRow = await exportAxisChartData(sheet, chart, dataToUse, tab, currentRow);
                }
                
                currentRow += 2;  // Space between charts
                
                // Try to export chart as image
                try {
                    const chartImage = await captureChartAsImage(chart);
                    if (chartImage) {
                        const imageId = workbook.addImage({
                            base64: chartImage,
                            extension: 'png',
                        });
                        
                        sheet.addImage(imageId, {
                            tl: { col: 0, row: currentRow - 1 },
                            ext: { width: 600, height: 300 }
                        });
                        
                        currentRow += 18;  // Space for image (approx 18 rows)
                    }
                } catch (err) {
                    console.warn('Could not capture chart image:', err);
                }
            }
            
            // Auto-fit columns
            sheet.columns.forEach((column) => {
                let maxLength = 15;
                column.eachCell({ includeEmpty: false }, (cell) => {
                    const length = cell.value ? String(cell.value).length : 10;
                    if (length > maxLength) maxLength = length;
                });
                column.width = Math.min(maxLength + 3, 40);
            });
        }
        
        async function exportAxisChartData(sheet, chart, data, tab, startRow) {
            const aggregated = aggregateDataForChart(data, chart, tab);
            
            // Get X-axis dimension
            let xDim;
            if (chart.xAxis === 'date_column') {
                xDim = { id: 'date_column', sourceColumn: dateConfig.sourceColumn, displayName: dateConfig.displayName };
            } else {
                xDim = dimensions.find(d => d.id === chart.xAxis);
            }
            
            // Build headers
            const headers = [xDim?.displayName || 'X-Axis'];
            
            if (chart.splitBy) {
                // Multi-series: X | Series1-Metric1 | Series1-Metric2 | Series2-Metric1...
                const splitDim = dimensions.find(d => d.id === chart.splitBy);
                const splitValues = [...new Set(aggregated.map(row => row[splitDim.sourceColumn]))].filter(v => v);
                
                splitValues.forEach(splitValue => {
                    chart.yAxisMetrics.forEach(metricId => {
                        const metric = metrics.find(m => m.id === metricId);
                        headers.push(`${splitValue} - ${metric.displayName}`);
                    });
                });
            } else {
                // Single series: X | Metric1 | Metric2...
                chart.yAxisMetrics.forEach(metricId => {
                    const metric = metrics.find(m => m.id === metricId);
                    headers.push(metric?.displayName || metricId);
                });
            }
            
            const headerRow = sheet.getRow(startRow);
            headers.forEach((header, idx) => {
                const cell = headerRow.getCell(idx + 1);
                cell.value = header;
                cell.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FFA8E6CF' }
                };
                cell.font = { bold: true, size: 11 };
                cell.alignment = { vertical: 'middle', horizontal: 'center' };
                cell.border = {
                    top: { style: 'thin' },
                    bottom: { style: 'thin' },
                    left: { style: 'thin' },
                    right: { style: 'thin' }
                };
            });
            
            startRow++;
            
            // Get unique X values
            const xValues = [...new Set(aggregated.map(row => {
                let value = row[xDim.sourceColumn];
                if (chart.xAxis === 'date_column') {
                    value = formatDateValue(value, dateConfig.format);
                }
                return value;
            }))];
            
            // Add data rows
            xValues.forEach(xValue => {
                const row = [xValue];
                
                if (chart.splitBy) {
                    const splitDim = dimensions.find(d => d.id === chart.splitBy);
                    const splitValues = [...new Set(aggregated.map(r => r[splitDim.sourceColumn]))].filter(v => v);
                    
                    splitValues.forEach(splitValue => {
                        chart.yAxisMetrics.forEach(metricId => {
                            const metricIndex = metrics.findIndex(m => m.id === metricId);
                            const dataRow = aggregated.find(r => {
                                let xVal = r[xDim.sourceColumn];
                                if (chart.xAxis === 'date_column') {
                                    xVal = formatDateValue(xVal, dateConfig.format);
                                }
                                return xVal === xValue && r[splitDim.sourceColumn] === splitValue;
                            });
                            row.push(dataRow ? dataRow[`metric_${metricIndex}`] : null);
                        });
                    });
                } else {
                    chart.yAxisMetrics.forEach(metricId => {
                        const metricIndex = metrics.findIndex(m => m.id === metricId);
                        const dataRow = aggregated.find(r => {
                            let xVal = r[xDim.sourceColumn];
                            if (chart.xAxis === 'date_column') {
                                xVal = formatDateValue(xVal, dateConfig.format);
                            }
                            return xVal === xValue;
                        });
                        row.push(dataRow ? dataRow[`metric_${metricIndex}`] : null);
                    });
                }
                
                const dataRow = sheet.getRow(startRow);
                row.forEach((val, idx) => {
                    const cell = dataRow.getCell(idx + 1);
                    cell.value = val;
                    
                    if (idx > 0) {  // Metric cells
                        cell.numFmt = '#,##0';
                        cell.alignment = { horizontal: 'right' };
                    }
                });
                
                startRow++;
            });
            
            return startRow;
        }
        
        async function exportPieChartData(sheet, chart, data, startRow) {
            // Get dimension
            let dim;
            if (chart.xAxis === 'date_column') {
                dim = { id: 'date_column', sourceColumn: dateConfig.sourceColumn, displayName: dateConfig.displayName };
            } else {
                dim = dimensions.find(d => d.id === chart.xAxis);
            }
            
            const metricId = chart.yAxisMetrics[0];
            const metric = metrics.find(m => m.id === metricId);
            const metricIndex = metrics.findIndex(m => m.id === metricId);
            
            // Headers
            const headerRow = sheet.getRow(startRow);
            headerRow.getCell(1).value = dim?.displayName || 'Category';
            headerRow.getCell(2).value = metric?.displayName || 'Value';
            headerRow.getCell(3).value = 'Percentage';
            
            headerRow.eachCell((cell) => {
                cell.fill = {
                    type: 'pattern',
                    pattern: 'solid',
                    fgColor: { argb: 'FFA8E6CF' }
                };
                cell.font = { bold: true, size: 11 };
                cell.alignment = { vertical: 'middle', horizontal: 'center' };
                cell.border = {
                    top: { style: 'thin' },
                    bottom: { style: 'thin' },
                    left: { style: 'thin' },
                    right: { style: 'thin' }
                };
            });
            
            startRow++;
            
            // Aggregate by dimension
            const groups = new Map();
            data.forEach(row => {
                const key = row[dim.sourceColumn] || 'Unknown';
                if (!groups.has(key)) {
                    groups.set(key, []);
                }
                groups.get(key).push(row);
            });
            
            // Calculate values
            const results = [];
            let total = 0;
            
            groups.forEach((rows, key) => {
                let value;
                if (metric.type === 'base') {
                    value = calculateBaseMetric(rows, metric.sourceColumn);
                } else {
                    const metricValues = {};
                    metrics.filter(m => m.type === 'base').forEach(m => {
                        metricValues[`[${m.displayName}]`] = calculateBaseMetric(rows, m.sourceColumn);
                    });
                    value = calculateFormula(metric.formula, metricValues);
                }
                results.push({ category: key, value });
                total += value;
            });
            
            // Add data rows
            results.forEach(result => {
                const percentage = total > 0 ? (result.value / total) : 0;
                
                const dataRow = sheet.getRow(startRow);
                dataRow.getCell(1).value = result.category;
                dataRow.getCell(2).value = result.value;
                dataRow.getCell(2).numFmt = '#,##0';
                dataRow.getCell(2).alignment = { horizontal: 'right' };
                
                dataRow.getCell(3).value = percentage;
                dataRow.getCell(3).numFmt = '0.0%';
                dataRow.getCell(3).alignment = { horizontal: 'right' };
                
                startRow++;
            });
            
            return startRow;
        }
        
        function getAxisLabel(axisId) {
            if (axisId === 'date_column') {
                return dateConfig.displayName;
            }
            const dim = dimensions.find(d => d.id === axisId);
            return dim?.displayName || axisId;
        }
        
        async function captureChartAsImage(chart) {
            // Find chart canvas in DOM
            const canvas = document.getElementById(`chart_${chart.id}`);
            if (!canvas) return null;
            
            try {
                // Convert canvas to base64
                const base64 = canvas.toDataURL('image/png').split(',')[1];
                return base64;
            } catch (err) {
                console.error('Failed to capture chart:', err);
                return null;
            }
        }

        window.addEventListener('DOMContentLoaded', function() {
            // Initialize Aurora
            const canvas = document.getElementById('auroraCanvas');
            if (canvas) {
                auroraInstance = new AuroraBackground('auroraCanvas');
            }
            
            // Initialize Lucide icons
            lucide.createIcons();
        });
        
        window.addEventListener('DOMContentLoaded', function() {
            init();
        });
    </script>

    <!-- Initialize Lucide Icons -->
    <script>
        // Initialize icons after DOM loaded
        document.addEventListener('DOMContentLoaded', function() {
            lucide.createIcons();
        });
        
        // Re-initialize icons after dynamic content updates
        const originalRenderTabsList = renderTabsList;
        renderTabsList = function() {
            originalRenderTabsList();
            setTimeout(() => lucide.createIcons(), 100);
        };
        
        const originalRenderDimensionsTable = renderDimensionsTable;
        renderDimensionsTable = function() {
            originalRenderDimensionsTable();
            setTimeout(() => lucide.createIcons(), 100);
        };
        
        const originalRenderMetricsTable = renderMetricsTable;
        renderMetricsTable = function() {
            originalRenderMetricsTable();
            setTimeout(() => lucide.createIcons(), 100);
        };
    </script>
</body>
</html>